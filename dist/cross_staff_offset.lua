function plugindef()finaleplugin.RequireSelection=true;finaleplugin.Copyright="CC0 https://creativecommons.org/publicdomain/zero/1.0/"finaleplugin.Author="Carl Vine"finaleplugin.AuthorURL="http://carlvine.com"finaleplugin.Version="v1.21"finaleplugin.Date="2022/05/23"finaleplugin.Notes=[[
        When creating cross-staff notes using the option-downarrow shortcut, the stems of 'crossed' notes
        are reversed (on the wrong side of the notehead) and so appear too far to the right (if shifting downwards)
        by the width of one notehead (typically 24EVPU). This script lets you set a horizontal offset for all cross-staff
        notes in the currently selected region, with a different offset for non-crossed notes. For crossing to the
        staff below use (-24,0) or (-12,12). For crossing to the staff above use (24,0) or (12,-12). Also specify
        which layer number (1-4) or "all layers" (0). (This also offers a simple way to reset the horizontal offset
        of all notes in the selection to zero).

        If you invoke the plugin with Option key (macOS) or Shift key pressed, the script uses the last settings
        from the dialog.
    ]]return"CrossStaff Offset","CrossStaff Offset","Offset horizontal position of cross-staff note entries"end;function user_selects_offset()local a,b=10,25;local c=finenv.UI():IsOnMac()and 3 or 0;local d=120;local e=finale.FCCustomWindow()local f=finale.FCString()f.LuaString=plugindef()e:SetTitle(f)local g={}local h={{"Cross-staff offset:",cross_offset and cross_offset or 0},{"Non-crossed offset:",non_cross_offset and non_cross_offset or 0},{"Layer 1-4 (0 = all):",layer_number and layer_number or 0}}for i,j in ipairs(h)do f.LuaString=j[1]local k=e:CreateStatic(0,a)k:SetText(f)k:SetWidth(200)g[i]=e:CreateEdit(d,a-c)g[i]:SetInteger(j[2])g[i]:SetWidth(75)if i<3 then f.LuaString="EVPUs"e:CreateStatic(d+80,a):SetText(f)end;a=a+b end;local k=e:CreateStatic(0,a+8)f.LuaString="cross to staff below = [ -24 | 0 ] or [ -12, 12 ]"k:SetText(f)k:SetWidth(240)k=e:CreateStatic(0,a+b)f.LuaString="cross to staff above = [ 24 | 0 ] or [ 12, -12 ]"k:SetText(f)k:SetWidth(240)e:CreateOkButton()e:CreateCancelButton()return e:ExecuteModal(nil),g[1]:GetInteger(),g[2]:GetInteger(),g[3]:GetInteger()end;function is_out_of_range(l)max_value=999;return l>max_value or l<max_value*-1 end;function cross_staff_offset()local m=finenv.QueryInvokedModifierKeys and(finenv.QueryInvokedModifierKeys(finale.CMDMODKEY_ALT)or finenv.QueryInvokedModifierKeys(finale.CMDMODKEY_SHIFT))if not m or dialog_result~=finale.EXECMODAL_OK then dialog_result,cross_offset,non_cross_offset,layer_number=user_selects_offset()if dialog_result~=finale.EXECMODAL_OK then return end;if nil~=finenv.RetainLuaState then finenv.RetainLuaState=true end end;local n=""if layer_number<0 or layer_number>4 then n="The layer number must\nbe between 0 and 4\n(not "..layer_number..")"elseif is_out_of_range(cross_offset)or is_out_of_range(non_cross_offset)then n="Choose realistic offset\nvalues (say from -999 to 999)\n(not "..cross_offset.." / "..non_cross_offset..")"end;if n~=""then finenv.UI():AlertNeutral("script: "..plugindef(),n)dialog_result=finale.EXECMODAL_CANCEL else for o in eachentrysaved(finenv.Region(),layer_number)do if o:IsNote()then o.ManualPosition=o.CrossStaff and cross_offset or non_cross_offset end end end end;cross_staff_offset()