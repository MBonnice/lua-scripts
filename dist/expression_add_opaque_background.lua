local a,b,c,d=(function(e)local f={[{}]=true}local g;local h={}local require;local i={}g=function(j,k)if not h[j]then h[j]=k end end;require=function(j)local l=i[j]if l then if l==f then return nil end else if not h[j]then if not e then local m=type(j)=='string'and'\"'..j..'\"'or tostring(j)error('Tried to require '..m..', but no such module has been registered')else return e(j)end end;i[j]=f;l=h[j](require,i,g,h)i[j]=l end;return l end;return require,i,g,h end)(require)c("__root",function(require,n,c,d)function plugindef()finaleplugin.RequireSelection=true;finaleplugin.Author="Robert Patterson"finaleplugin.Copyright="CC0 https://creativecommons.org/publicdomain/zero/1.0/"finaleplugin.Version="1.1"finaleplugin.Date="March 20, 2021"finaleplugin.CategoryTags="Expression"return"Expression Add Opaque Background","Expression Add Opaque Background","Add an opaque background to any single-staff text expression in the currenly selected region."end;local o=require("library.general_library")local p=require("library.expression")local q=finenv.MajorVersion>0 or finenv.MinorVersion>=60;local r=nil;if not q then local s=finale.FCTextExpressionDefs()s:LoadAll()for t in each(s)do if t.UseEnclosure then r=t:CreateEnclosure()if nil~=r then break end end end;if nil==r then finenv.UI():AlertNeutral("Please create or modify any text expression to have an enclosure, and then rerun this script.","Create Enclosure Needed")return end end;function expression_add_opaque_background()local u=o.get_current_part()local v=finale.FCExpressions()v:LoadAllForRegion(finenv.Region())for w in each(v)do if not w:IsShape()and w:IsSingleStaffAssigned()then if p.is_for_current_part(w,u)then local x=finale.FCTextExpressionDef()if x:Load(w.ID)then if not x.UseEnclosure then local y=r;if q then y=finale.FCEnclosure()end;y.FixedSize=false;y.HorizontalMargin=0;y.HorizontalOffset=0;y.LineWidth=0;y.Mode=finale.ENCLOSUREMODE_NONE;y.Opaque=true;y.RoundedCornerRadius=0;y.RoundedCorners=false;y.Shape=finale.ENCLOSURE_RECTANGLE;y.VerticalMargin=0;y.VerticalOffset=0;if y:SaveAs(x.ItemNo)then x:SetUseEnclosure(true)end else local z=x:CreateEnclosure()if nil~=z then z.Opaque=true;z:Save()end end;x:Save()end end end end end;expression_add_opaque_background()end)c("library.expression",function(require,n,c,d)local o={}function o.finale_version(A,B,C)local D=bit32.bor(bit32.lshift(math.floor(A),24),bit32.lshift(math.floor(B),20))if C then D=bit32.bor(D,math.floor(C))end;return D end;function o.group_overlaps_region(E,F)if F:IsFullDocumentSpan()then return true end;local G=false;local H=finale.FCSystemStaves()H:LoadAllForRegion(F)for I in each(H)do if E:ContainsStaff(I:GetStaff())then G=true;break end end;if not G then return false end;if E.StartMeasure>F.EndMeasure or E.EndMeasure<F.StartMeasure then return false end;return true end;function o.group_is_contained_in_region(E,F)if not F:IsStaffIncluded(E.StartStaff)then return false end;if not F:IsStaffIncluded(E.EndStaff)then return false end;return true end;function o.staff_group_is_multistaff_instrument(E)local J=finale.FCMultiStaffInstruments()J:LoadAll()for K in each(J)do if K:ContainsStaff(E.StartStaff)and K.GroupID==E:GetItemID()then return true end end;return false end;function o.get_selected_region_or_whole_doc()local L=finenv.Region()if L:IsEmpty()then L:SetFullDocument()end;return L end;function o.get_first_cell_on_or_after_page(M)local N=M;local O=finale.FCPage()local P=false;while O:Load(N)do if O:GetFirstSystem()>0 then P=true;break end;N=N+1 end;if P then local Q=finale.FCStaffSystem()Q:Load(O:GetFirstSystem())return finale.FCCell(Q.FirstMeasure,Q.TopStaff)end;local R=finale.FCMusicRegion()R:SetFullDocument()return finale.FCCell(R.EndMeasure,R.EndStaff)end;function o.get_top_left_visible_cell()if not finenv.UI():IsPageView()then local S=finale.FCMusicRegion()S:SetFullDocument()return finale.FCCell(finenv.UI():GetCurrentMeasure(),S.StartStaff)end;return o.get_first_cell_on_or_after_page(finenv.UI():GetCurrentPage())end;function o.get_top_left_selected_or_visible_cell()local L=finenv.Region()if not L:IsEmpty()then return finale.FCCell(L.StartMeasure,L.StartStaff)end;return o.get_top_left_visible_cell()end;function o.is_default_measure_number_visible_on_cell(T,U,V,W)local X=finale.FCCurrentStaffSpec()if not X:LoadForCell(U,0)then return false end;if T:GetShowOnTopStaff()and U.Staff==V.TopStaff then return true end;if T:GetShowOnBottomStaff()and U.Staff==V:CalcBottomStaff()then return true end;if X.ShowMeasureNumbers then return not T:GetExcludeOtherStaves(W)end;return false end;function o.is_default_number_visible_and_left_aligned(T,U,Y,W,Z)if T.UseScoreInfoForParts then W=false end;if Z and T:GetShowOnMultiMeasureRests(W)then if finale.MNALIGN_LEFT~=T:GetMultiMeasureAlignment(W)then return false end elseif U.Measure==Y.FirstMeasure then if not T:GetShowOnSystemStart()then return false end;if finale.MNALIGN_LEFT~=T:GetStartAlignment(W)then return false end else if not T:GetShowMultiples(W)then return false end;if finale.MNALIGN_LEFT~=T:GetMultipleAlignment(W)then return false end end;return o.is_default_measure_number_visible_on_cell(T,U,Y,W)end;function o.update_layout(_,a0)_=_ or 1;a0=a0 or false;local a1=finale.FCPage()if a1:Load(_)then a1:UpdateLayout(a0)end end;function o.get_current_part()local a2=finale.FCParts()a2:LoadAll()return a2:GetCurrent()end;function o.get_page_format_prefs()local u=o.get_current_part()local a3=finale.FCPageFormatPrefs()local a4=false;if u:IsScore()then a4=a3:LoadScore()else a4=a3:LoadParts()end;return a3,a4 end;local a5=function(a6)local a7=finenv.UI():IsOnWindows()local a8=function(a9,aa)if finenv.UI():IsOnWindows()then return a9 and os.getenv(a9)or""else return aa and os.getenv(aa)or""end end;local ab=a6 and a8("LOCALAPPDATA","HOME")or a8("COMMONPROGRAMFILES")if not a7 then ab=ab.."/Library/Application Support"end;ab=ab.."/SMuFL/Fonts/"return ab end;function o.get_smufl_font_list()local ac={}local ad=function(a6)local ab=a5(a6)local ae=function()if finenv.UI():IsOnWindows()then return io.popen('dir "'..ab..'" /b /ad')else return io.popen('ls "'..ab..'"')end end;local af=function(ag)local ah=finale.FCString()ah.LuaString=ag;return finenv.UI():IsFontAvailable(ah)end;for ag in ae():lines()do if not ag:find("%.")then ag=ag:gsub(" Bold","")ag=ag:gsub(" Italic","")local ah=finale.FCString()ah.LuaString=ag;if ac[ag]or af(ag)then ac[ag]=a6 and"user"or"system"end end end end;ad(true)ad(false)return ac end;function o.get_smufl_metadata_file(ai)if not ai then ai=finale.FCFontInfo()ai:LoadFontPrefs(finale.FONTPREF_MUSIC)end;local aj=function(ak,ai)local al=ak..ai.Name.."/"..ai.Name..".json"return io.open(al,"r")end;local am=aj(a5(true),ai)if am then return am end;return aj(a5(false),ai)end;function o.is_font_smufl_font(ai)if not ai then ai=finale.FCFontInfo()ai:LoadFontPrefs(finale.FONTPREF_MUSIC)end;if finenv.RawFinaleVersion>=o.finale_version(27,1)then if nil~=ai.IsSMuFLFont then return ai.IsSMuFLFont end end;local an=o.get_smufl_metadata_file(ai)if nil~=an then io.close(an)return true end;return false end;function o.simple_input(ao,ap)local aq=finale.FCString()aq.LuaString=""local ar=finale.FCString()local as=160;function format_ctrl(at,au,av,aw)at:SetHeight(au)at:SetWidth(av)ar.LuaString=aw;at:SetText(ar)end;title_width=string.len(ao)*6+54;if title_width>as then as=title_width end;text_width=string.len(ap)*6;if text_width>as then as=text_width end;ar.LuaString=ao;local ax=finale.FCCustomLuaWindow()ax:SetTitle(ar)local ay=ax:CreateStatic(0,0)format_ctrl(ay,16,as,ap)local az=ax:CreateEdit(0,20)format_ctrl(az,20,as,"")ax:CreateOkButton()ax:CreateCancelButton()function callback(at)end;ax:RegisterHandleCommand(callback)if ax:ExecuteModal(nil)==finale.EXECMODAL_OK then aq.LuaString=az:GetText(aq)return aq.LuaString end end;function o.is_finale_object(aA)return aA and type(aA)=="userdata"and aA.ClassName and aA.GetClassID and true or false end;function o.system_indent_set_to_prefs(Y,a3)a3=a3 or o.get_page_format_prefs()local aB=finale.FCMeasure()local aC=Y.FirstMeasure==1;if not aC and aB:Load(Y.FirstMeasure)then if aB.ShowFullNames then aC=true end end;if aC and a3.UseFirstSystemMargins then Y.LeftMargin=a3.FirstSystemLeft else Y.LeftMargin=a3.SystemLeft end;return Y:Save()end;function o.calc_script_name(aD)local aE=finale.FCString()if finenv.RunningLuaFilePath then aE.LuaString=finenv.RunningLuaFilePath()else aE:SetRunningLuaFilePath()end;local aF=finale.FCString()aE:SplitToPathAndFile(nil,aF)local D=aF.LuaString;if not aD then D=D:match("(.+)%..+")if not D or D==""then D=aF.LuaString end end;return D end;return o end)c("library.general_library",function(require,n,c,d)local o={}function o.finale_version(A,B,C)local D=bit32.bor(bit32.lshift(math.floor(A),24),bit32.lshift(math.floor(B),20))if C then D=bit32.bor(D,math.floor(C))end;return D end;function o.group_overlaps_region(E,F)if F:IsFullDocumentSpan()then return true end;local G=false;local H=finale.FCSystemStaves()H:LoadAllForRegion(F)for I in each(H)do if E:ContainsStaff(I:GetStaff())then G=true;break end end;if not G then return false end;if E.StartMeasure>F.EndMeasure or E.EndMeasure<F.StartMeasure then return false end;return true end;function o.group_is_contained_in_region(E,F)if not F:IsStaffIncluded(E.StartStaff)then return false end;if not F:IsStaffIncluded(E.EndStaff)then return false end;return true end;function o.staff_group_is_multistaff_instrument(E)local J=finale.FCMultiStaffInstruments()J:LoadAll()for K in each(J)do if K:ContainsStaff(E.StartStaff)and K.GroupID==E:GetItemID()then return true end end;return false end;function o.get_selected_region_or_whole_doc()local L=finenv.Region()if L:IsEmpty()then L:SetFullDocument()end;return L end;function o.get_first_cell_on_or_after_page(M)local N=M;local O=finale.FCPage()local P=false;while O:Load(N)do if O:GetFirstSystem()>0 then P=true;break end;N=N+1 end;if P then local Q=finale.FCStaffSystem()Q:Load(O:GetFirstSystem())return finale.FCCell(Q.FirstMeasure,Q.TopStaff)end;local R=finale.FCMusicRegion()R:SetFullDocument()return finale.FCCell(R.EndMeasure,R.EndStaff)end;function o.get_top_left_visible_cell()if not finenv.UI():IsPageView()then local S=finale.FCMusicRegion()S:SetFullDocument()return finale.FCCell(finenv.UI():GetCurrentMeasure(),S.StartStaff)end;return o.get_first_cell_on_or_after_page(finenv.UI():GetCurrentPage())end;function o.get_top_left_selected_or_visible_cell()local L=finenv.Region()if not L:IsEmpty()then return finale.FCCell(L.StartMeasure,L.StartStaff)end;return o.get_top_left_visible_cell()end;function o.is_default_measure_number_visible_on_cell(T,U,V,W)local X=finale.FCCurrentStaffSpec()if not X:LoadForCell(U,0)then return false end;if T:GetShowOnTopStaff()and U.Staff==V.TopStaff then return true end;if T:GetShowOnBottomStaff()and U.Staff==V:CalcBottomStaff()then return true end;if X.ShowMeasureNumbers then return not T:GetExcludeOtherStaves(W)end;return false end;function o.is_default_number_visible_and_left_aligned(T,U,Y,W,Z)if T.UseScoreInfoForParts then W=false end;if Z and T:GetShowOnMultiMeasureRests(W)then if finale.MNALIGN_LEFT~=T:GetMultiMeasureAlignment(W)then return false end elseif U.Measure==Y.FirstMeasure then if not T:GetShowOnSystemStart()then return false end;if finale.MNALIGN_LEFT~=T:GetStartAlignment(W)then return false end else if not T:GetShowMultiples(W)then return false end;if finale.MNALIGN_LEFT~=T:GetMultipleAlignment(W)then return false end end;return o.is_default_measure_number_visible_on_cell(T,U,Y,W)end;function o.update_layout(_,a0)_=_ or 1;a0=a0 or false;local a1=finale.FCPage()if a1:Load(_)then a1:UpdateLayout(a0)end end;function o.get_current_part()local a2=finale.FCParts()a2:LoadAll()return a2:GetCurrent()end;function o.get_page_format_prefs()local u=o.get_current_part()local a3=finale.FCPageFormatPrefs()local a4=false;if u:IsScore()then a4=a3:LoadScore()else a4=a3:LoadParts()end;return a3,a4 end;local a5=function(a6)local a7=finenv.UI():IsOnWindows()local a8=function(a9,aa)if finenv.UI():IsOnWindows()then return a9 and os.getenv(a9)or""else return aa and os.getenv(aa)or""end end;local ab=a6 and a8("LOCALAPPDATA","HOME")or a8("COMMONPROGRAMFILES")if not a7 then ab=ab.."/Library/Application Support"end;ab=ab.."/SMuFL/Fonts/"return ab end;function o.get_smufl_font_list()local ac={}local ad=function(a6)local ab=a5(a6)local ae=function()if finenv.UI():IsOnWindows()then return io.popen('dir "'..ab..'" /b /ad')else return io.popen('ls "'..ab..'"')end end;local af=function(ag)local ah=finale.FCString()ah.LuaString=ag;return finenv.UI():IsFontAvailable(ah)end;for ag in ae():lines()do if not ag:find("%.")then ag=ag:gsub(" Bold","")ag=ag:gsub(" Italic","")local ah=finale.FCString()ah.LuaString=ag;if ac[ag]or af(ag)then ac[ag]=a6 and"user"or"system"end end end end;ad(true)ad(false)return ac end;function o.get_smufl_metadata_file(ai)if not ai then ai=finale.FCFontInfo()ai:LoadFontPrefs(finale.FONTPREF_MUSIC)end;local aj=function(ak,ai)local al=ak..ai.Name.."/"..ai.Name..".json"return io.open(al,"r")end;local am=aj(a5(true),ai)if am then return am end;return aj(a5(false),ai)end;function o.is_font_smufl_font(ai)if not ai then ai=finale.FCFontInfo()ai:LoadFontPrefs(finale.FONTPREF_MUSIC)end;if finenv.RawFinaleVersion>=o.finale_version(27,1)then if nil~=ai.IsSMuFLFont then return ai.IsSMuFLFont end end;local an=o.get_smufl_metadata_file(ai)if nil~=an then io.close(an)return true end;return false end;function o.simple_input(ao,ap)local aq=finale.FCString()aq.LuaString=""local ar=finale.FCString()local as=160;function format_ctrl(at,au,av,aw)at:SetHeight(au)at:SetWidth(av)ar.LuaString=aw;at:SetText(ar)end;title_width=string.len(ao)*6+54;if title_width>as then as=title_width end;text_width=string.len(ap)*6;if text_width>as then as=text_width end;ar.LuaString=ao;local ax=finale.FCCustomLuaWindow()ax:SetTitle(ar)local ay=ax:CreateStatic(0,0)format_ctrl(ay,16,as,ap)local az=ax:CreateEdit(0,20)format_ctrl(az,20,as,"")ax:CreateOkButton()ax:CreateCancelButton()function callback(at)end;ax:RegisterHandleCommand(callback)if ax:ExecuteModal(nil)==finale.EXECMODAL_OK then aq.LuaString=az:GetText(aq)return aq.LuaString end end;function o.is_finale_object(aA)return aA and type(aA)=="userdata"and aA.ClassName and aA.GetClassID and true or false end;function o.system_indent_set_to_prefs(Y,a3)a3=a3 or o.get_page_format_prefs()local aB=finale.FCMeasure()local aC=Y.FirstMeasure==1;if not aC and aB:Load(Y.FirstMeasure)then if aB.ShowFullNames then aC=true end end;if aC and a3.UseFirstSystemMargins then Y.LeftMargin=a3.FirstSystemLeft else Y.LeftMargin=a3.SystemLeft end;return Y:Save()end;function o.calc_script_name(aD)local aE=finale.FCString()if finenv.RunningLuaFilePath then aE.LuaString=finenv.RunningLuaFilePath()else aE:SetRunningLuaFilePath()end;local aF=finale.FCString()aE:SplitToPathAndFile(nil,aF)local D=aF.LuaString;if not aD then D=D:match("(.+)%..+")if not D or D==""then D=aF.LuaString end end;return D end;return o end)return a("__root")