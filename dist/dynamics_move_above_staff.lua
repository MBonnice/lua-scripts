function plugindef()finaleplugin.RequireScore=false;finaleplugin.RequireSelection=true;finaleplugin.Author="Jacob Winkler"finaleplugin.Copyright="2021"finaleplugin.Version="1.0"return"Dynamics Above Staff","Dynamics Above Staff","Moves dynamics above staff"end;function dyn_above()local a=finenv.Region()local b=a.StartMeasure;local c=a.EndMeasure;local d=a.StartStaff;local e=a.EndStaff;local f=finale.FCMeasures()f:LoadRegion(a)local g=finale.FCSystemStaves()g:LoadAllForRegion(a)local h=finale.FCStaffSystems()h:LoadAll()local i=finale.FCStaffSystem()local j=h:FindMeasureNumber(b)local k=h:FindMeasureNumber(c)print("Start Staffsys is",j.ItemNo,", End is",k.ItemNo)local l=finale.FCBaseline()l.Mode=finale.BASELINEMODE_EXPRESSIONABOVE;l:LoadDefaultForMode(finale.BASELINEMODE_EXPRESSIONABOVE)baseline_off=l.VerticalOffset;print("Above Staff Baseline is",baseline_off)local m=-84;local n=0;local o=0;local p=0;local q=36;function metrics(r)print("metrics function called")local s=0;local t=0;f:LoadRegion(r)for u in each(f)do print("Analyzing measure",u.ItemNo)cell=finale.FCCell(u.ItemNo,r.StartStaff)cellmetrics=cell:CreateCellMetrics()staff_scale=cellmetrics:GetStaffScaling()/10000;if cellmetrics.ReferenceLinePos+q>s then s=cellmetrics.ReferenceLinePos+q end end;for v in eachentry(r)do local w=finale.FCEntryMetrics()w:Load(v)local x=w:GetTopPosition()/staff_scale;if x+q>s then s=x+q end end;t=s-cellmetrics.ReferenceLinePos+12;return s,t end;function expr_move(y,n)local z=finale.FCExpressions()z:LoadAllForRegion(y)for A in each(z)do local B=false;local C=A:CreateTextExpressionDef()local D=C:GetCategoryID()local E=finale.FCCategoryDef()if E:Load(D)then local F=E:CreateName()if F.LuaString=="Dynamics"then B=true end end;if B==true then print("VerticalPos",A.VerticalPos)local G=finale.FCPoint(0,0)cell=finale.FCCell(A.Measure,A.Staff)cellmetrics=cell:CreateCellMetrics()print("Vertical Target is",n)A:CalcMetricPos(G)print("Expression Y is",G.Y)A:SetVerticalPos(A.VerticalPos+n-G.Y)A:Save()end end end;function hairpin_move(y,o)local H=finale.FCSmartShapeMeasureMarks()H:LoadAllForRegion(y,true)for I in each(H)do local J=I:CreateSmartShape()if J:IsHairpin()then print("found hairpin")local K=J:GetTerminateSegmentLeft()local L=J:GetTerminateSegmentRight()K:SetEndpointOffsetY(o)L:SetEndpointOffsetY(o)J:Save()end end end;function analyze_staves()for M=j.ItemNo,k.ItemNo,1 do print("Analyzing staffsys",M)i:Load(M)local N=0;local O=0;if b>i.FirstMeasure then N=b else N=i.FirstMeasure end;if c<i.NextSysMeasure-1 then O=c else O=i.NextSysMeasure-1 end;print("Start Measure",N,"End",O)local r=finenv.Region()r:SetStartMeasure(N)r:SetEndMeasure(O)for P=d,e,1 do r:SetStartStaff(P)r:SetEndStaff(P)n,o=metrics(r)print("vert_target for staff",P,"is",n)expr_move(r,n)hairpin_move(r,o)end end end;analyze_staves()end;dyn_above()