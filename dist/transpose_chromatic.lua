local a,b,c,d=(function(e)local f={[{}]=true}local g;local h={}local require;local i={}g=function(j,k)if not h[j]then h[j]=k end end;require=function(j)local l=i[j]if l then if l==f then return nil end else if not h[j]then if not e then local m=type(j)=='string'and'\"'..j..'\"'or tostring(j)error('Tried to require '..m..', but no such module has been registered')else return e(j)end end;i[j]=f;l=h[j](require,i,g,h)i[j]=l end;return l end;return require,i,g,h end)(require)c("__root",function(require,n,c,d)function plugindef()finaleplugin.RequireSelection=false;finaleplugin.HandlesUndo=true;finaleplugin.Author="Robert Patterson"finaleplugin.Copyright="CC0 https://creativecommons.org/publicdomain/zero/1.0/"finaleplugin.Version="1.1"finaleplugin.Date="January 20, 2022"finaleplugin.CategoryTags="Pitch"finaleplugin.Notes=[[
        This script transposes the selected region by a chromatic interval. It works correctly even with
        microtone scales defined by custom key signatures.

        Normally the script opens a modeless window. However, if you invoke the plugin with a shift, option, or
        alt key pressed, it skips opening a window and uses the last settings you entered into the window.
        (This works with RGP Lua version 0.60 and higher.)

        If you are using custom key signatures with JW Lua or an early version of RGP Lua, you must create
        a custom_key_sig.config.txt file in a folder called `script_settings` within the same folder as the script.
        It should contains the following two lines that define the custom key signature you are using. Unfortunately,
        the JW Lua and early versions of RGP Lua do not allow scripts to read this information from the Finale document.

        (This example is for 31-EDO.)

        ```
        number_of_steps = 31
        diatonic_steps = {0, 5, 10, 13, 18, 23, 28}
        ```

        Later versions of RGP Lua (0.58 or higher) ignore this configuration file (if it exists) and read the correct
        information from the Finale document.
    ]]return"Transpose Chromatic...","Transpose Chromatic","Chromatic transposition of selected region (supports microtone systems)."end;if not finenv.RetainLuaState then interval_names={"Perfect Unison","Augmented Unison","Diminished Second","Minor Second","Major Second","Augmented Second","Diminished Third","Minor Third","Major Third","Augmented Third","Diminished Fourth","Perfect Fourth","Augmented Fourth","Diminished Fifth","Perfect Fifth","Augmented Fifth","Diminished Sixth","Minor Sixth","Major Sixth","Augmented Sixth","Diminished Seventh","Minor Seventh","Major Seventh","Augmented Seventh","Diminished Octave","Perfect Octave"}interval_disp_alts={{0,0},{0,1},{1,-2},{1,-1},{1,0},{1,1},{2,-2},{2,-1},{2,0},{2,1},{3,-1},{3,0},{3,1},{4,-1},{4,0},{4,1},{5,-2},{5,-1},{5,0},{5,1},{6,-2},{6,-1},{6,0},{6,1},{7,-1},{7,0}}end;if not finenv.IsRGPLua then local o=finale.FCString()o:SetRunningLuaFolderPath()package.path=package.path..";"..o.LuaString.."?.lua"end;local p=require("library.transposition")local q=require("library.note_entry")local r=require("library.mixin")function do_transpose_chromatic(s,t,u,v,w)if finenv.Region():IsEmpty()then return end;local x=s*interval_disp_alts[t][1]local y=s*interval_disp_alts[t][2]v=s*v;local z="Transpose Chromatic "..tostring(finenv.Region().StartMeasure)if finenv.Region().StartMeasure~=finenv.Region().EndMeasure then z=z.." - "..tostring(finenv.Region().EndMeasure)end;finenv.StartNewUndoBlock(z,false)local A=true;for B in eachentrysaved(finenv.Region())do local C=B.Count;local D=0;for E in each(B)do if w then D=D+1;if D>C then break end;local F=q.duplicate_note(E)if nil~=F then E=F end end;if not p.chromatic_transpose(E,x,y,u)then A=false end;p.change_octave(E,v)end end;if finenv.EndUndoBlock then finenv.EndUndoBlock(true)finenv.Region():Redraw()else finenv.StartNewUndoBlock(z,true)end;if not A then finenv.UI():AlertError("Finale is unable to represent some of the transposed pitches. These pitches were left at their original value.","Transposition Error")end;return A end;function create_dialog_box()local G=r.FCXCustomLuaWindow():SetTitle("Transpose Chromatic")local H=0;local I=26;local J=85;G:CreateStatic(0,H+2):SetText("Direction:")G:CreatePopup(J,H,"direction_choice"):AddStrings("Up","Down"):SetWidth(J):SetSelectedItem(0)H=H+I;static=G:CreateStatic(0,H+2):SetText("Interval:")G:CreatePopup(J,H,"interval_choice"):AddStrings(table.unpack(interval_names)):SetWidth(140):SetSelectedItem(0)H=H+I;G:CreateCheckbox(0,H+2,"do_simplify"):SetText("Simplify Spelling"):SetWidth(140):SetCheck(0)H=H+I;G:CreateStatic(0,H+2):SetText("Plus Octaves:")local K=J+(finenv.UI():IsOnMac()and 4 or 0)G:CreateEdit(K,H,"plus_octaves"):SetText("")H=H+I;G:CreateCheckbox(0,H+2,"do_preserve"):SetText("Preserve Existing Notes"):SetWidth(140):SetCheck(0)H=H+I;G:CreateOkButton()G:CreateCancelButton()G:RegisterHandleOkButtonPressed(function(self)local s=1;if self:GetControl("direction_choice"):GetSelectedItem()>0 then s=-1 end;local L=1+self:GetControl("interval_choice"):GetSelectedItem()local M=0~=self:GetControl("do_simplify"):GetCheck()local v=self:GetControl("plus_octaves"):GetInteger()local w=0~=self:GetControl("do_preserve"):GetCheck()do_transpose_chromatic(s,L,M,v,w)end)return G end;function transpose_chromatic()global_dialog=global_dialog or create_dialog_box()global_dialog:RunModeless()end;transpose_chromatic()end)c("library.mixin",function(require,n,c,d)local N={}function N.finale_version(O,P,Q)local R=bit32.bor(bit32.lshift(math.floor(O),24),bit32.lshift(math.floor(P),20))if Q then R=bit32.bor(R,math.floor(Q))end;return R end;function N.group_overlaps_region(S,T)if T:IsFullDocumentSpan()then return true end;local U=false;local V=finale.FCSystemStaves()V:LoadAllForRegion(T)for W in each(V)do if S:ContainsStaff(W:GetStaff())then U=true;break end end;if not U then return false end;if S.StartMeasure>T.EndMeasure or S.EndMeasure<T.StartMeasure then return false end;return true end;function N.group_is_contained_in_region(S,T)if not T:IsStaffIncluded(S.StartStaff)then return false end;if not T:IsStaffIncluded(S.EndStaff)then return false end;return true end;function N.staff_group_is_multistaff_instrument(S)local X=finale.FCMultiStaffInstruments()X:LoadAll()for Y in each(X)do if Y:ContainsStaff(S.StartStaff)and Y.GroupID==S:GetItemID()then return true end end;return false end;function N.get_selected_region_or_whole_doc()local Z=finenv.Region()if Z:IsEmpty()then Z:SetFullDocument()end;return Z end;function N.get_first_cell_on_or_after_page(_)local a0=_;local a1=finale.FCPage()local a2=false;while a1:Load(a0)do if a1:GetFirstSystem()>0 then a2=true;break end;a0=a0+1 end;if a2 then local a3=finale.FCStaffSystem()a3:Load(a1:GetFirstSystem())return finale.FCCell(a3.FirstMeasure,a3.TopStaff)end;local a4=finale.FCMusicRegion()a4:SetFullDocument()return finale.FCCell(a4.EndMeasure,a4.EndStaff)end;function N.get_top_left_visible_cell()if not finenv.UI():IsPageView()then local a5=finale.FCMusicRegion()a5:SetFullDocument()return finale.FCCell(finenv.UI():GetCurrentMeasure(),a5.StartStaff)end;return N.get_first_cell_on_or_after_page(finenv.UI():GetCurrentPage())end;function N.get_top_left_selected_or_visible_cell()local Z=finenv.Region()if not Z:IsEmpty()then return finale.FCCell(Z.StartMeasure,Z.StartStaff)end;return N.get_top_left_visible_cell()end;function N.is_default_measure_number_visible_on_cell(a6,a7,a8,a9)local aa=finale.FCCurrentStaffSpec()if not aa:LoadForCell(a7,0)then return false end;if a6:GetShowOnTopStaff()and a7.Staff==a8.TopStaff then return true end;if a6:GetShowOnBottomStaff()and a7.Staff==a8:CalcBottomStaff()then return true end;if aa.ShowMeasureNumbers then return not a6:GetExcludeOtherStaves(a9)end;return false end;function N.is_default_number_visible_and_left_aligned(a6,a7,ab,a9,ac)if a6.UseScoreInfoForParts then a9=false end;if ac and a6:GetShowOnMultiMeasureRests(a9)then if finale.MNALIGN_LEFT~=a6:GetMultiMeasureAlignment(a9)then return false end elseif a7.Measure==ab.FirstMeasure then if not a6:GetShowOnSystemStart()then return false end;if finale.MNALIGN_LEFT~=a6:GetStartAlignment(a9)then return false end else if not a6:GetShowMultiples(a9)then return false end;if finale.MNALIGN_LEFT~=a6:GetMultipleAlignment(a9)then return false end end;return N.is_default_measure_number_visible_on_cell(a6,a7,ab,a9)end;function N.update_layout(ad,ae)ad=ad or 1;ae=ae or false;local af=finale.FCPage()if af:Load(ad)then af:UpdateLayout(ae)end end;function N.get_current_part()local ag=finale.FCParts()ag:LoadAll()return ag:GetCurrent()end;function N.get_page_format_prefs()local ah=N.get_current_part()local ai=finale.FCPageFormatPrefs()local A=false;if ah:IsScore()then A=ai:LoadScore()else A=ai:LoadParts()end;return ai,A end;local aj=function(ak)local al=finenv.UI():IsOnWindows()local am=function(an,ao)if finenv.UI():IsOnWindows()then return an and os.getenv(an)or""else return ao and os.getenv(ao)or""end end;local ap=ak and am("LOCALAPPDATA","HOME")or am("COMMONPROGRAMFILES")if not al then ap=ap.."/Library/Application Support"end;ap=ap.."/SMuFL/Fonts/"return ap end;function N.get_smufl_font_list()local aq={}local ar=function(ak)local ap=aj(ak)local as=function()if finenv.UI():IsOnWindows()then return io.popen('dir "'..ap..'" /b /ad')else return io.popen('ls "'..ap..'"')end end;local at=function(au)local av=finale.FCString()av.LuaString=au;return finenv.UI():IsFontAvailable(av)end;for au in as():lines()do if not au:find("%.")then au=au:gsub(" Bold","")au=au:gsub(" Italic","")local av=finale.FCString()av.LuaString=au;if aq[au]or at(au)then aq[au]=ak and"user"or"system"end end end end;ar(true)ar(false)return aq end;function N.get_smufl_metadata_file(aw)if not aw then aw=finale.FCFontInfo()aw:LoadFontPrefs(finale.FONTPREF_MUSIC)end;local ax=function(ay,aw)local az=ay..aw.Name.."/"..aw.Name..".json"return io.open(az,"r")end;local aA=ax(aj(true),aw)if aA then return aA end;return ax(aj(false),aw)end;function N.is_font_smufl_font(aw)if not aw then aw=finale.FCFontInfo()aw:LoadFontPrefs(finale.FONTPREF_MUSIC)end;if finenv.RawFinaleVersion>=N.finale_version(27,1)then if nil~=aw.IsSMuFLFont then return aw.IsSMuFLFont end end;local aB=N.get_smufl_metadata_file(aw)if nil~=aB then io.close(aB)return true end;return false end;function N.simple_input(aC,aD)local aE=finale.FCString()aE.LuaString=""local aF=finale.FCString()local aG=160;function format_ctrl(aH,aI,aJ,aK)aH:SetHeight(aI)aH:SetWidth(aJ)aF.LuaString=aK;aH:SetText(aF)end;title_width=string.len(aC)*6+54;if title_width>aG then aG=title_width end;text_width=string.len(aD)*6;if text_width>aG then aG=text_width end;aF.LuaString=aC;local G=finale.FCCustomLuaWindow()G:SetTitle(aF)local aL=G:CreateStatic(0,0)format_ctrl(aL,16,aG,aD)local aM=G:CreateEdit(0,20)format_ctrl(aM,20,aG,"")G:CreateOkButton()G:CreateCancelButton()function callback(aH)end;G:RegisterHandleCommand(callback)if G:ExecuteModal(nil)==finale.EXECMODAL_OK then aE.LuaString=aM:GetText(aE)return aE.LuaString end end;function N.is_finale_object(aN)return aN and type(aN)=="userdata"and aN.ClassName and aN.GetClassID and true or false end;function N.system_indent_set_to_prefs(ab,ai)ai=ai or N.get_page_format_prefs()local aO=finale.FCMeasure()local aP=ab.FirstMeasure==1;if not aP and aO:Load(ab.FirstMeasure)then if aO.ShowFullNames then aP=true end end;if aP and ai.UseFirstSystemMargins then ab.LeftMargin=ai.FirstSystemLeft else ab.LeftMargin=ai.SystemLeft end;return ab:Save()end;function N.calc_script_name(aQ)local aR=finale.FCString()if finenv.RunningLuaFilePath then aR.LuaString=finenv.RunningLuaFilePath()else aR:SetRunningLuaFilePath()end;local aS=finale.FCString()aR:SplitToPathAndFile(nil,aS)local R=aS.LuaString;if not aQ then R=R:match("(.+)%..+")if not R or R==""then R=aS.LuaString end end;return R end;return N end)c("library.note_entry",function(require,n,c,d)local N={}function N.finale_version(O,P,Q)local R=bit32.bor(bit32.lshift(math.floor(O),24),bit32.lshift(math.floor(P),20))if Q then R=bit32.bor(R,math.floor(Q))end;return R end;function N.group_overlaps_region(S,T)if T:IsFullDocumentSpan()then return true end;local U=false;local V=finale.FCSystemStaves()V:LoadAllForRegion(T)for W in each(V)do if S:ContainsStaff(W:GetStaff())then U=true;break end end;if not U then return false end;if S.StartMeasure>T.EndMeasure or S.EndMeasure<T.StartMeasure then return false end;return true end;function N.group_is_contained_in_region(S,T)if not T:IsStaffIncluded(S.StartStaff)then return false end;if not T:IsStaffIncluded(S.EndStaff)then return false end;return true end;function N.staff_group_is_multistaff_instrument(S)local X=finale.FCMultiStaffInstruments()X:LoadAll()for Y in each(X)do if Y:ContainsStaff(S.StartStaff)and Y.GroupID==S:GetItemID()then return true end end;return false end;function N.get_selected_region_or_whole_doc()local Z=finenv.Region()if Z:IsEmpty()then Z:SetFullDocument()end;return Z end;function N.get_first_cell_on_or_after_page(_)local a0=_;local a1=finale.FCPage()local a2=false;while a1:Load(a0)do if a1:GetFirstSystem()>0 then a2=true;break end;a0=a0+1 end;if a2 then local a3=finale.FCStaffSystem()a3:Load(a1:GetFirstSystem())return finale.FCCell(a3.FirstMeasure,a3.TopStaff)end;local a4=finale.FCMusicRegion()a4:SetFullDocument()return finale.FCCell(a4.EndMeasure,a4.EndStaff)end;function N.get_top_left_visible_cell()if not finenv.UI():IsPageView()then local a5=finale.FCMusicRegion()a5:SetFullDocument()return finale.FCCell(finenv.UI():GetCurrentMeasure(),a5.StartStaff)end;return N.get_first_cell_on_or_after_page(finenv.UI():GetCurrentPage())end;function N.get_top_left_selected_or_visible_cell()local Z=finenv.Region()if not Z:IsEmpty()then return finale.FCCell(Z.StartMeasure,Z.StartStaff)end;return N.get_top_left_visible_cell()end;function N.is_default_measure_number_visible_on_cell(a6,a7,a8,a9)local aa=finale.FCCurrentStaffSpec()if not aa:LoadForCell(a7,0)then return false end;if a6:GetShowOnTopStaff()and a7.Staff==a8.TopStaff then return true end;if a6:GetShowOnBottomStaff()and a7.Staff==a8:CalcBottomStaff()then return true end;if aa.ShowMeasureNumbers then return not a6:GetExcludeOtherStaves(a9)end;return false end;function N.is_default_number_visible_and_left_aligned(a6,a7,ab,a9,ac)if a6.UseScoreInfoForParts then a9=false end;if ac and a6:GetShowOnMultiMeasureRests(a9)then if finale.MNALIGN_LEFT~=a6:GetMultiMeasureAlignment(a9)then return false end elseif a7.Measure==ab.FirstMeasure then if not a6:GetShowOnSystemStart()then return false end;if finale.MNALIGN_LEFT~=a6:GetStartAlignment(a9)then return false end else if not a6:GetShowMultiples(a9)then return false end;if finale.MNALIGN_LEFT~=a6:GetMultipleAlignment(a9)then return false end end;return N.is_default_measure_number_visible_on_cell(a6,a7,ab,a9)end;function N.update_layout(ad,ae)ad=ad or 1;ae=ae or false;local af=finale.FCPage()if af:Load(ad)then af:UpdateLayout(ae)end end;function N.get_current_part()local ag=finale.FCParts()ag:LoadAll()return ag:GetCurrent()end;function N.get_page_format_prefs()local ah=N.get_current_part()local ai=finale.FCPageFormatPrefs()local A=false;if ah:IsScore()then A=ai:LoadScore()else A=ai:LoadParts()end;return ai,A end;local aj=function(ak)local al=finenv.UI():IsOnWindows()local am=function(an,ao)if finenv.UI():IsOnWindows()then return an and os.getenv(an)or""else return ao and os.getenv(ao)or""end end;local ap=ak and am("LOCALAPPDATA","HOME")or am("COMMONPROGRAMFILES")if not al then ap=ap.."/Library/Application Support"end;ap=ap.."/SMuFL/Fonts/"return ap end;function N.get_smufl_font_list()local aq={}local ar=function(ak)local ap=aj(ak)local as=function()if finenv.UI():IsOnWindows()then return io.popen('dir "'..ap..'" /b /ad')else return io.popen('ls "'..ap..'"')end end;local at=function(au)local av=finale.FCString()av.LuaString=au;return finenv.UI():IsFontAvailable(av)end;for au in as():lines()do if not au:find("%.")then au=au:gsub(" Bold","")au=au:gsub(" Italic","")local av=finale.FCString()av.LuaString=au;if aq[au]or at(au)then aq[au]=ak and"user"or"system"end end end end;ar(true)ar(false)return aq end;function N.get_smufl_metadata_file(aw)if not aw then aw=finale.FCFontInfo()aw:LoadFontPrefs(finale.FONTPREF_MUSIC)end;local ax=function(ay,aw)local az=ay..aw.Name.."/"..aw.Name..".json"return io.open(az,"r")end;local aA=ax(aj(true),aw)if aA then return aA end;return ax(aj(false),aw)end;function N.is_font_smufl_font(aw)if not aw then aw=finale.FCFontInfo()aw:LoadFontPrefs(finale.FONTPREF_MUSIC)end;if finenv.RawFinaleVersion>=N.finale_version(27,1)then if nil~=aw.IsSMuFLFont then return aw.IsSMuFLFont end end;local aB=N.get_smufl_metadata_file(aw)if nil~=aB then io.close(aB)return true end;return false end;function N.simple_input(aC,aD)local aE=finale.FCString()aE.LuaString=""local aF=finale.FCString()local aG=160;function format_ctrl(aH,aI,aJ,aK)aH:SetHeight(aI)aH:SetWidth(aJ)aF.LuaString=aK;aH:SetText(aF)end;title_width=string.len(aC)*6+54;if title_width>aG then aG=title_width end;text_width=string.len(aD)*6;if text_width>aG then aG=text_width end;aF.LuaString=aC;local G=finale.FCCustomLuaWindow()G:SetTitle(aF)local aL=G:CreateStatic(0,0)format_ctrl(aL,16,aG,aD)local aM=G:CreateEdit(0,20)format_ctrl(aM,20,aG,"")G:CreateOkButton()G:CreateCancelButton()function callback(aH)end;G:RegisterHandleCommand(callback)if G:ExecuteModal(nil)==finale.EXECMODAL_OK then aE.LuaString=aM:GetText(aE)return aE.LuaString end end;function N.is_finale_object(aN)return aN and type(aN)=="userdata"and aN.ClassName and aN.GetClassID and true or false end;function N.system_indent_set_to_prefs(ab,ai)ai=ai or N.get_page_format_prefs()local aO=finale.FCMeasure()local aP=ab.FirstMeasure==1;if not aP and aO:Load(ab.FirstMeasure)then if aO.ShowFullNames then aP=true end end;if aP and ai.UseFirstSystemMargins then ab.LeftMargin=ai.FirstSystemLeft else ab.LeftMargin=ai.SystemLeft end;return ab:Save()end;function N.calc_script_name(aQ)local aR=finale.FCString()if finenv.RunningLuaFilePath then aR.LuaString=finenv.RunningLuaFilePath()else aR:SetRunningLuaFilePath()end;local aS=finale.FCString()aR:SplitToPathAndFile(nil,aS)local R=aS.LuaString;if not aQ then R=R:match("(.+)%..+")if not R or R==""then R=aS.LuaString end end;return R end;return N end)c("library.transposition",function(require,n,c,d)local N={}function N.finale_version(O,P,Q)local R=bit32.bor(bit32.lshift(math.floor(O),24),bit32.lshift(math.floor(P),20))if Q then R=bit32.bor(R,math.floor(Q))end;return R end;function N.group_overlaps_region(S,T)if T:IsFullDocumentSpan()then return true end;local U=false;local V=finale.FCSystemStaves()V:LoadAllForRegion(T)for W in each(V)do if S:ContainsStaff(W:GetStaff())then U=true;break end end;if not U then return false end;if S.StartMeasure>T.EndMeasure or S.EndMeasure<T.StartMeasure then return false end;return true end;function N.group_is_contained_in_region(S,T)if not T:IsStaffIncluded(S.StartStaff)then return false end;if not T:IsStaffIncluded(S.EndStaff)then return false end;return true end;function N.staff_group_is_multistaff_instrument(S)local X=finale.FCMultiStaffInstruments()X:LoadAll()for Y in each(X)do if Y:ContainsStaff(S.StartStaff)and Y.GroupID==S:GetItemID()then return true end end;return false end;function N.get_selected_region_or_whole_doc()local Z=finenv.Region()if Z:IsEmpty()then Z:SetFullDocument()end;return Z end;function N.get_first_cell_on_or_after_page(_)local a0=_;local a1=finale.FCPage()local a2=false;while a1:Load(a0)do if a1:GetFirstSystem()>0 then a2=true;break end;a0=a0+1 end;if a2 then local a3=finale.FCStaffSystem()a3:Load(a1:GetFirstSystem())return finale.FCCell(a3.FirstMeasure,a3.TopStaff)end;local a4=finale.FCMusicRegion()a4:SetFullDocument()return finale.FCCell(a4.EndMeasure,a4.EndStaff)end;function N.get_top_left_visible_cell()if not finenv.UI():IsPageView()then local a5=finale.FCMusicRegion()a5:SetFullDocument()return finale.FCCell(finenv.UI():GetCurrentMeasure(),a5.StartStaff)end;return N.get_first_cell_on_or_after_page(finenv.UI():GetCurrentPage())end;function N.get_top_left_selected_or_visible_cell()local Z=finenv.Region()if not Z:IsEmpty()then return finale.FCCell(Z.StartMeasure,Z.StartStaff)end;return N.get_top_left_visible_cell()end;function N.is_default_measure_number_visible_on_cell(a6,a7,a8,a9)local aa=finale.FCCurrentStaffSpec()if not aa:LoadForCell(a7,0)then return false end;if a6:GetShowOnTopStaff()and a7.Staff==a8.TopStaff then return true end;if a6:GetShowOnBottomStaff()and a7.Staff==a8:CalcBottomStaff()then return true end;if aa.ShowMeasureNumbers then return not a6:GetExcludeOtherStaves(a9)end;return false end;function N.is_default_number_visible_and_left_aligned(a6,a7,ab,a9,ac)if a6.UseScoreInfoForParts then a9=false end;if ac and a6:GetShowOnMultiMeasureRests(a9)then if finale.MNALIGN_LEFT~=a6:GetMultiMeasureAlignment(a9)then return false end elseif a7.Measure==ab.FirstMeasure then if not a6:GetShowOnSystemStart()then return false end;if finale.MNALIGN_LEFT~=a6:GetStartAlignment(a9)then return false end else if not a6:GetShowMultiples(a9)then return false end;if finale.MNALIGN_LEFT~=a6:GetMultipleAlignment(a9)then return false end end;return N.is_default_measure_number_visible_on_cell(a6,a7,ab,a9)end;function N.update_layout(ad,ae)ad=ad or 1;ae=ae or false;local af=finale.FCPage()if af:Load(ad)then af:UpdateLayout(ae)end end;function N.get_current_part()local ag=finale.FCParts()ag:LoadAll()return ag:GetCurrent()end;function N.get_page_format_prefs()local ah=N.get_current_part()local ai=finale.FCPageFormatPrefs()local A=false;if ah:IsScore()then A=ai:LoadScore()else A=ai:LoadParts()end;return ai,A end;local aj=function(ak)local al=finenv.UI():IsOnWindows()local am=function(an,ao)if finenv.UI():IsOnWindows()then return an and os.getenv(an)or""else return ao and os.getenv(ao)or""end end;local ap=ak and am("LOCALAPPDATA","HOME")or am("COMMONPROGRAMFILES")if not al then ap=ap.."/Library/Application Support"end;ap=ap.."/SMuFL/Fonts/"return ap end;function N.get_smufl_font_list()local aq={}local ar=function(ak)local ap=aj(ak)local as=function()if finenv.UI():IsOnWindows()then return io.popen('dir "'..ap..'" /b /ad')else return io.popen('ls "'..ap..'"')end end;local at=function(au)local av=finale.FCString()av.LuaString=au;return finenv.UI():IsFontAvailable(av)end;for au in as():lines()do if not au:find("%.")then au=au:gsub(" Bold","")au=au:gsub(" Italic","")local av=finale.FCString()av.LuaString=au;if aq[au]or at(au)then aq[au]=ak and"user"or"system"end end end end;ar(true)ar(false)return aq end;function N.get_smufl_metadata_file(aw)if not aw then aw=finale.FCFontInfo()aw:LoadFontPrefs(finale.FONTPREF_MUSIC)end;local ax=function(ay,aw)local az=ay..aw.Name.."/"..aw.Name..".json"return io.open(az,"r")end;local aA=ax(aj(true),aw)if aA then return aA end;return ax(aj(false),aw)end;function N.is_font_smufl_font(aw)if not aw then aw=finale.FCFontInfo()aw:LoadFontPrefs(finale.FONTPREF_MUSIC)end;if finenv.RawFinaleVersion>=N.finale_version(27,1)then if nil~=aw.IsSMuFLFont then return aw.IsSMuFLFont end end;local aB=N.get_smufl_metadata_file(aw)if nil~=aB then io.close(aB)return true end;return false end;function N.simple_input(aC,aD)local aE=finale.FCString()aE.LuaString=""local aF=finale.FCString()local aG=160;function format_ctrl(aH,aI,aJ,aK)aH:SetHeight(aI)aH:SetWidth(aJ)aF.LuaString=aK;aH:SetText(aF)end;title_width=string.len(aC)*6+54;if title_width>aG then aG=title_width end;text_width=string.len(aD)*6;if text_width>aG then aG=text_width end;aF.LuaString=aC;local G=finale.FCCustomLuaWindow()G:SetTitle(aF)local aL=G:CreateStatic(0,0)format_ctrl(aL,16,aG,aD)local aM=G:CreateEdit(0,20)format_ctrl(aM,20,aG,"")G:CreateOkButton()G:CreateCancelButton()function callback(aH)end;G:RegisterHandleCommand(callback)if G:ExecuteModal(nil)==finale.EXECMODAL_OK then aE.LuaString=aM:GetText(aE)return aE.LuaString end end;function N.is_finale_object(aN)return aN and type(aN)=="userdata"and aN.ClassName and aN.GetClassID and true or false end;function N.system_indent_set_to_prefs(ab,ai)ai=ai or N.get_page_format_prefs()local aO=finale.FCMeasure()local aP=ab.FirstMeasure==1;if not aP and aO:Load(ab.FirstMeasure)then if aO.ShowFullNames then aP=true end end;if aP and ai.UseFirstSystemMargins then ab.LeftMargin=ai.FirstSystemLeft else ab.LeftMargin=ai.SystemLeft end;return ab:Save()end;function N.calc_script_name(aQ)local aR=finale.FCString()if finenv.RunningLuaFilePath then aR.LuaString=finenv.RunningLuaFilePath()else aR:SetRunningLuaFilePath()end;local aS=finale.FCString()aR:SplitToPathAndFile(nil,aS)local R=aS.LuaString;if not aQ then R=R:match("(.+)%..+")if not R or R==""then R=aS.LuaString end end;return R end;return N end)return a("__root")