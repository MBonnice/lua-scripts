local a,b,c,d=(function(e)local f={[{}]=true}local g;local h={}local require;local i={}g=function(j,k)if not h[j]then h[j]=k end end;require=function(j)local l=i[j]if l then if l==f then return nil end else if not h[j]then if not e then local m=type(j)=='string'and'\"'..j..'\"'or tostring(j)error('Tried to require '..m..', but no such module has been registered')else return e(j)end end;i[j]=f;l=h[j](require,i,g,h)i[j]=l end;return l end;return require,i,g,h end)(require)c("__root",function(require,n,c,d)function plugindef()finaleplugin.Author="Robert Patterson"finaleplugin.Copyright="CC0 https://creativecommons.org/publicdomain/zero/1.0/"finaleplugin.Version="1.0"finaleplugin.Date="June 19, 2020"finaleplugin.CategoryTags="Measure"return"Measure Numbers Adjust for Key, Time, Repeat","Measure Numbers Adjust for Key, Time, Repeat","Adjusts all measure numbers left where there is a key signature, time signature, or start repeat."end;local o=require("library.general_library")local p=finale.FCSizePrefs()p:Load(1)local q=math.floor(p.ThinBarlineThickness/64.0+0.5)local r=0;function measure_numbers_adjust_for_leadin()local s=finale.FCStaffSystems()s:LoadAll()local t=finale.FCMeasureNumberRegions()t:LoadAll()local u=finale.FCParts()u:LoadAll()local v=u:GetCurrent()local w=not v:IsScore()local x=o.get_selected_region_or_whole_doc()for y in each(s)do local z=finale.FCMusicRegion()if y:CalcRegion(z)and z:IsOverlapping(x)then local A=0;local B=z.StartMeasure;for C=z.StartMeasure,z.EndMeasure do if C>A then local D=t:FindMeasure(C)if nil~=D then multimeasure_rest=finale.FCMultiMeasureRest()local E=multimeasure_rest:Load(C)if E then A=multimeasure_rest.EndMeasure end;if x:IsMeasureIncluded(C)then for F=z.StartSlot,z.EndSlot do local G=z:CalcStaffNumber(F)if x:IsStaffIncluded(G)then local H=finale.FCCell(C,G)if o.is_default_number_visible_and_left_aligned(D,H,y,w,E)then local I=0;if H.Measure~=y.FirstMeasure then local J=finale.FCCellMetrics()if J:LoadAtCell(H)then I=J.MusicStartPos-J:GetLeftEdge()local K=q;if nil~=J.GetRightBarlineWidth then local L=finale.FCCellMetrics()if L:LoadAtCell(finale.FCCell(B,G))then K=L.RightBarlineWidth;L:FreeMetrics()end end;I=I-K;if 0~=I then I=I-r;local M=J.StaffScaling/10000.0/(J.SystemScaling/10000.0)I=math.floor(I/M+0.5)local N=J.HorizontalStretch/10000.0;I=math.floor(I/N+0.5)end end;J:FreeMetrics()end;local O=finale.FCSeparateMeasureNumbers()O:LoadAllInCell(H)if O.Count>0 then for P in each(O)do P.HorizontalPosition=-I;P:Save()end elseif 0~=I then local P=finale.FCSeparateMeasureNumber()P:ConnectCell(H)P:AssignMeasureNumberRegion(D)P.HorizontalPosition=-I;if P:SaveNew()then local Q=finale.FCMeasure()Q:Load(H.Measure)Q:SetContainsManualMeasureNumbers(true)Q:Save()end end end end end end end;B=C end end end end end;measure_numbers_adjust_for_leadin()end)c("library.general_library",function(require,n,c,d)local o={}function o.finale_version(R,S,T)local U=bit32.bor(bit32.lshift(math.floor(R),24),bit32.lshift(math.floor(S),20))if T then U=bit32.bor(U,math.floor(T))end;return U end;function o.group_overlaps_region(V,W)if W:IsFullDocumentSpan()then return true end;local X=false;local Y=finale.FCSystemStaves()Y:LoadAllForRegion(W)for Z in each(Y)do if V:ContainsStaff(Z:GetStaff())then X=true;break end end;if not X then return false end;if V.StartMeasure>W.EndMeasure or V.EndMeasure<W.StartMeasure then return false end;return true end;function o.group_is_contained_in_region(V,W)if not W:IsStaffIncluded(V.StartStaff)then return false end;if not W:IsStaffIncluded(V.EndStaff)then return false end;return true end;function o.staff_group_is_multistaff_instrument(V)local _=finale.FCMultiStaffInstruments()_:LoadAll()for a0 in each(_)do if a0:ContainsStaff(V.StartStaff)and a0.GroupID==V:GetItemID()then return true end end;return false end;function o.get_selected_region_or_whole_doc()local x=finenv.Region()if x:IsEmpty()then x:SetFullDocument()end;return x end;function o.get_first_cell_on_or_after_page(a1)local a2=a1;local a3=finale.FCPage()local a4=false;while a3:Load(a2)do if a3:GetFirstSystem()>0 then a4=true;break end;a2=a2+1 end;if a4 then local a5=finale.FCStaffSystem()a5:Load(a3:GetFirstSystem())return finale.FCCell(a5.FirstMeasure,a5.TopStaff)end;local a6=finale.FCMusicRegion()a6:SetFullDocument()return finale.FCCell(a6.EndMeasure,a6.EndStaff)end;function o.get_top_left_visible_cell()if not finenv.UI():IsPageView()then local a7=finale.FCMusicRegion()a7:SetFullDocument()return finale.FCCell(finenv.UI():GetCurrentMeasure(),a7.StartStaff)end;return o.get_first_cell_on_or_after_page(finenv.UI():GetCurrentPage())end;function o.get_top_left_selected_or_visible_cell()local x=finenv.Region()if not x:IsEmpty()then return finale.FCCell(x.StartMeasure,x.StartStaff)end;return o.get_top_left_visible_cell()end;function o.is_default_measure_number_visible_on_cell(D,H,a8,w)local G=finale.FCCurrentStaffSpec()if not G:LoadForCell(H,0)then return false end;if D:GetShowOnTopStaff()and H.Staff==a8.TopStaff then return true end;if D:GetShowOnBottomStaff()and H.Staff==a8:CalcBottomStaff()then return true end;if G.ShowMeasureNumbers then return not D:GetExcludeOtherStaves(w)end;return false end;function o.is_default_number_visible_and_left_aligned(D,H,y,w,E)if D.UseScoreInfoForParts then w=false end;if E and D:GetShowOnMultiMeasureRests(w)then if finale.MNALIGN_LEFT~=D:GetMultiMeasureAlignment(w)then return false end elseif H.Measure==y.FirstMeasure then if not D:GetShowOnSystemStart()then return false end;if finale.MNALIGN_LEFT~=D:GetStartAlignment(w)then return false end else if not D:GetShowMultiples(w)then return false end;if finale.MNALIGN_LEFT~=D:GetMultipleAlignment(w)then return false end end;return o.is_default_measure_number_visible_on_cell(D,H,y,w)end;function o.update_layout(a9,aa)a9=a9 or 1;aa=aa or false;local ab=finale.FCPage()if ab:Load(a9)then ab:UpdateLayout(aa)end end;function o.get_current_part()local u=finale.FCParts()u:LoadAll()return u:GetCurrent()end;function o.get_page_format_prefs()local v=o.get_current_part()local ac=finale.FCPageFormatPrefs()local ad=false;if v:IsScore()then ad=ac:LoadScore()else ad=ac:LoadParts()end;return ac,ad end;function o.get_smufl_metadata_file(ae)if not ae then ae=finale.FCFontInfo()ae:LoadFontPrefs(finale.FONTPREF_MUSIC)end;local af=function(ag,ae)local ah=ag.."/SMuFL/Fonts/"..ae.Name.."/"..ae.Name..".json"return io.open(ah,"r")end;local ai=""if finenv.UI():IsOnWindows()then ai=os.getenv("LOCALAPPDATA")else ai=os.getenv("HOME").."/Library/Application Support"end;local aj=af(ai,ae)if nil~=aj then return aj end;local ak="/Library/Application Support"if finenv.UI():IsOnWindows()then ak=os.getenv("COMMONPROGRAMFILES")end;return af(ak,ae)end;function o.is_font_smufl_font(ae)if not ae then ae=finale.FCFontInfo()ae:LoadFontPrefs(finale.FONTPREF_MUSIC)end;if finenv.RawFinaleVersion>=o.finale_version(27,1)then if nil~=ae.IsSMuFLFont then return ae.IsSMuFLFont end end;local al=o.get_smufl_metadata_file(ae)if nil~=al then io.close(al)return true end;return false end;function o.simple_input(am,an)local ao=finale.FCString()ao.LuaString=""local ap=finale.FCString()local aq=160;function format_ctrl(ar,as,at,au)ar:SetHeight(as)ar:SetWidth(at)ap.LuaString=au;ar:SetText(ap)end;title_width=string.len(am)*6+54;if title_width>aq then aq=title_width end;text_width=string.len(an)*6;if text_width>aq then aq=text_width end;ap.LuaString=am;local av=finale.FCCustomLuaWindow()av:SetTitle(ap)local aw=av:CreateStatic(0,0)format_ctrl(aw,16,aq,an)local ax=av:CreateEdit(0,20)format_ctrl(ax,20,aq,"")av:CreateOkButton()av:CreateCancelButton()function callback(ar)end;av:RegisterHandleCommand(callback)if av:ExecuteModal(nil)==finale.EXECMODAL_OK then ao.LuaString=ax:GetText(ao)return ao.LuaString end end;function o.is_finale_object(ay)return ay and type(ay)=="userdata"and ay.ClassName and ay.GetClassID and true or false end;function o.system_indent_set_to_prefs(y,ac)ac=ac or o.get_page_format_prefs()local az=finale.FCMeasure()local aA=y.FirstMeasure==1;if not aA and az:Load(y.FirstMeasure)then if az.ShowFullNames then aA=true end end;if aA and ac.UseFirstSystemMargins then y.LeftMargin=ac.FirstSystemLeft else y.LeftMargin=ac.SystemLeft end;return y:Save()end;return o end)return a("__root")