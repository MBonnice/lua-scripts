local a,b,c,d=(function(e)local f={[{}]=true}local g;local h={}local require;local i={}g=function(j,k)if not h[j]then h[j]=k end end;require=function(j)local l=i[j]if l then if l==f then return nil end else if not h[j]then if not e then local m=type(j)=='string'and'\"'..j..'\"'or tostring(j)error('Tried to require '..m..', but no such module has been registered')else return e(j)end end;i[j]=f;l=h[j](require,i,g,h)i[j]=l end;return l end;return require,i,g,h end)(require)c("__root",function(require,n,c,d)function plugindef()finaleplugin.Author="Robert Patterson"finaleplugin.Copyright="CC0 https://creativecommons.org/publicdomain/zero/1.0/"finaleplugin.Version="1.0"finaleplugin.Date="June 19, 2020"finaleplugin.CategoryTags="Measure"return"Measure Numbers Adjust for Key, Time, Repeat","Measure Numbers Adjust for Key, Time, Repeat","Adjusts all measure numbers left where there is a key signature, time signature, or start repeat."end;local o=require("library.general_library")local p=finale.FCSizePrefs()p:Load(1)local q=math.floor(p.ThinBarlineThickness/64.0+0.5)local r=0;function measure_numbers_adjust_for_leadin()local s=finale.FCStaffSystems()s:LoadAll()local t=finale.FCMeasureNumberRegions()t:LoadAll()local u=finale.FCParts()u:LoadAll()local v=u:GetCurrent()local w=not v:IsScore()local x=o.get_selected_region_or_whole_doc()for y in each(s)do local z=finale.FCMusicRegion()if y:CalcRegion(z)and z:IsOverlapping(x)then local A=0;local B=z.StartMeasure;for C=z.StartMeasure,z.EndMeasure do if C>A then local D=t:FindMeasure(C)if nil~=D then multimeasure_rest=finale.FCMultiMeasureRest()local E=multimeasure_rest:Load(C)if E then A=multimeasure_rest.EndMeasure end;if x:IsMeasureIncluded(C)then for F=z.StartSlot,z.EndSlot do local G=z:CalcStaffNumber(F)if x:IsStaffIncluded(G)then local H=finale.FCCell(C,G)if o.is_default_number_visible_and_left_aligned(D,H,y,w,E)then local I=0;if H.Measure~=y.FirstMeasure then local J=finale.FCCellMetrics()if J:LoadAtCell(H)then I=J.MusicStartPos-J:GetLeftEdge()local K=q;if nil~=J.GetRightBarlineWidth then local L=finale.FCCellMetrics()if L:LoadAtCell(finale.FCCell(B,G))then K=L.RightBarlineWidth;L:FreeMetrics()end end;I=I-K;if 0~=I then I=I-r;local M=J.StaffScaling/10000.0/(J.SystemScaling/10000.0)I=math.floor(I/M+0.5)local N=J.HorizontalStretch/10000.0;I=math.floor(I/N+0.5)end end;J:FreeMetrics()end;local O=finale.FCSeparateMeasureNumbers()O:LoadAllInCell(H)if O.Count>0 then for P in each(O)do P.HorizontalPosition=-I;P:Save()end elseif 0~=I then local P=finale.FCSeparateMeasureNumber()P:ConnectCell(H)P:AssignMeasureNumberRegion(D)P.HorizontalPosition=-I;if P:SaveNew()then local Q=finale.FCMeasure()Q:Load(H.Measure)Q:SetContainsManualMeasureNumbers(true)Q:Save()end end end end end end end;B=C end end end end end;measure_numbers_adjust_for_leadin()end)c("library.general_library",function(require,n,c,d)local o={}function o.finale_version(R,S,T)local U=bit32.bor(bit32.lshift(math.floor(R),24),bit32.lshift(math.floor(S),20))if T then U=bit32.bor(U,math.floor(T))end;return U end;function o.group_overlaps_region(V,W)if W:IsFullDocumentSpan()then return true end;local X=false;local Y=finale.FCSystemStaves()Y:LoadAllForRegion(W)for Z in each(Y)do if V:ContainsStaff(Z:GetStaff())then X=true;break end end;if not X then return false end;if V.StartMeasure>W.EndMeasure or V.EndMeasure<W.StartMeasure then return false end;return true end;function o.group_is_contained_in_region(V,W)if not W:IsStaffIncluded(V.StartStaff)then return false end;if not W:IsStaffIncluded(V.EndStaff)then return false end;return true end;function o.staff_group_is_multistaff_instrument(V)local _=finale.FCMultiStaffInstruments()_:LoadAll()for a0 in each(_)do if a0:ContainsStaff(V.StartStaff)and a0.GroupID==V:GetItemID()then return true end end;return false end;function o.get_selected_region_or_whole_doc()local x=finenv.Region()if x:IsEmpty()then x:SetFullDocument()end;return x end;function o.get_first_cell_on_or_after_page(a1)local a2=a1;local a3=finale.FCPage()local a4=false;while a3:Load(a2)do if a3:GetFirstSystem()>0 then a4=true;break end;a2=a2+1 end;if a4 then local a5=finale.FCStaffSystem()a5:Load(a3:GetFirstSystem())return finale.FCCell(a5.FirstMeasure,a5.TopStaff)end;local a6=finale.FCMusicRegion()a6:SetFullDocument()return finale.FCCell(a6.EndMeasure,a6.EndStaff)end;function o.get_top_left_visible_cell()if not finenv.UI():IsPageView()then local a7=finale.FCMusicRegion()a7:SetFullDocument()return finale.FCCell(finenv.UI():GetCurrentMeasure(),a7.StartStaff)end;return o.get_first_cell_on_or_after_page(finenv.UI():GetCurrentPage())end;function o.get_top_left_selected_or_visible_cell()local x=finenv.Region()if not x:IsEmpty()then return finale.FCCell(x.StartMeasure,x.StartStaff)end;return o.get_top_left_visible_cell()end;function o.is_default_measure_number_visible_on_cell(D,H,a8,w)local G=finale.FCCurrentStaffSpec()if not G:LoadForCell(H,0)then return false end;if D:GetShowOnTopStaff()and H.Staff==a8.TopStaff then return true end;if D:GetShowOnBottomStaff()and H.Staff==a8:CalcBottomStaff()then return true end;if G.ShowMeasureNumbers then return not D:GetExcludeOtherStaves(w)end;return false end;function o.is_default_number_visible_and_left_aligned(D,H,y,w,E)if D.UseScoreInfoForParts then w=false end;if E and D:GetShowOnMultiMeasureRests(w)then if finale.MNALIGN_LEFT~=D:GetMultiMeasureAlignment(w)then return false end elseif H.Measure==y.FirstMeasure then if not D:GetShowOnSystemStart()then return false end;if finale.MNALIGN_LEFT~=D:GetStartAlignment(w)then return false end else if not D:GetShowMultiples(w)then return false end;if finale.MNALIGN_LEFT~=D:GetMultipleAlignment(w)then return false end end;return o.is_default_measure_number_visible_on_cell(D,H,y,w)end;function o.update_layout(a9,aa)a9=a9 or 1;aa=aa or false;local ab=finale.FCPage()if ab:Load(a9)then ab:UpdateLayout(aa)end end;function o.get_current_part()local u=finale.FCParts()u:LoadAll()return u:GetCurrent()end;function o.get_page_format_prefs()local v=o.get_current_part()local ac=finale.FCPageFormatPrefs()local ad=false;if v:IsScore()then ad=ac:LoadScore()else ad=ac:LoadParts()end;return ac,ad end;local ae=function(af)local ag=finenv.UI():IsOnWindows()local ah=function(ai,aj)if finenv.UI():IsOnWindows()then return ai and os.getenv(ai)or""else return aj and os.getenv(aj)or""end end;local ak=af and ah("LOCALAPPDATA","HOME")or ah("COMMONPROGRAMFILES")if not ag then ak=ak.."/Library/Application Support"end;ak=ak.."/SMuFL/Fonts/"return ak end;function o.get_smufl_font_list()local al={}local am=function(af)local ak=ae(af)local an=function()if finenv.UI():IsOnWindows()then return io.popen('dir "'..ak..'" /b /ad')else return io.popen('ls "'..ak..'"')end end;local ao=function(ap)local aq=finale.FCString()aq.LuaString=ap;return finenv.UI():IsFontAvailable(aq)end;for ap in an():lines()do if not ap:find("%.")then ap=ap:gsub(" Bold","")ap=ap:gsub(" Italic","")local aq=finale.FCString()aq.LuaString=ap;if al[ap]or ao(ap)then al[ap]=af and"user"or"system"end end end end;am(true)am(false)return al end;function o.get_smufl_metadata_file(ar)if not ar then ar=finale.FCFontInfo()ar:LoadFontPrefs(finale.FONTPREF_MUSIC)end;local as=function(at,ar)local au=at..ar.Name.."/"..ar.Name..".json"return io.open(au,"r")end;local av=as(ae(true),ar)if av then return av end;return as(ae(false),ar)end;function o.is_font_smufl_font(ar)if not ar then ar=finale.FCFontInfo()ar:LoadFontPrefs(finale.FONTPREF_MUSIC)end;if finenv.RawFinaleVersion>=o.finale_version(27,1)then if nil~=ar.IsSMuFLFont then return ar.IsSMuFLFont end end;local aw=o.get_smufl_metadata_file(ar)if nil~=aw then io.close(aw)return true end;return false end;function o.simple_input(ax,ay)local az=finale.FCString()az.LuaString=""local aA=finale.FCString()local aB=160;function format_ctrl(aC,aD,aE,aF)aC:SetHeight(aD)aC:SetWidth(aE)aA.LuaString=aF;aC:SetText(aA)end;title_width=string.len(ax)*6+54;if title_width>aB then aB=title_width end;text_width=string.len(ay)*6;if text_width>aB then aB=text_width end;aA.LuaString=ax;local aG=finale.FCCustomLuaWindow()aG:SetTitle(aA)local aH=aG:CreateStatic(0,0)format_ctrl(aH,16,aB,ay)local aI=aG:CreateEdit(0,20)format_ctrl(aI,20,aB,"")aG:CreateOkButton()aG:CreateCancelButton()function callback(aC)end;aG:RegisterHandleCommand(callback)if aG:ExecuteModal(nil)==finale.EXECMODAL_OK then az.LuaString=aI:GetText(az)return az.LuaString end end;function o.is_finale_object(aJ)return aJ and type(aJ)=="userdata"and aJ.ClassName and aJ.GetClassID and true or false end;function o.system_indent_set_to_prefs(y,ac)ac=ac or o.get_page_format_prefs()local aK=finale.FCMeasure()local aL=y.FirstMeasure==1;if not aL and aK:Load(y.FirstMeasure)then if aK.ShowFullNames then aL=true end end;if aL and ac.UseFirstSystemMargins then y.LeftMargin=ac.FirstSystemLeft else y.LeftMargin=ac.SystemLeft end;return y:Save()end;function o.calc_script_name(aM)local aN=finale.FCString()if finenv.RunningLuaFilePath then aN.LuaString=finenv.RunningLuaFilePath()else aN:SetRunningLuaFilePath()end;local aO=finale.FCString()aN:SplitToPathAndFile(nil,aO)local U=aO.LuaString;if not aM then U=U:match("(.+)%..+")if not U or U==""then U=aO.LuaString end end;return U end;return o end)return a("__root")