local a,b,c,d=(function(e)local f={[{}]=true}local g;local h={}local require;local i={}g=function(j,k)if not h[j]then h[j]=k end end;require=function(j)local l=i[j]if l then if l==f then return nil end else if not h[j]then if not e then local m=type(j)=='string'and'\"'..j..'\"'or tostring(j)error('Tried to require '..m..', but no such module has been registered')else return e(j)end end;i[j]=f;l=h[j](require,i,g,h)i[j]=l end;return l end;return require,i,g,h end)(require)c("__root",function(require,n,c,d)function plugindef()finaleplugin.Author="Robert Patterson"finaleplugin.Copyright="CC0 https://creativecommons.org/publicdomain/zero/1.0/"finaleplugin.Version="1.0"finaleplugin.Date="June 18, 2021"finaleplugin.CategoryTags="Layout"return"Load SMuFL Engraving Defaults","Load SMuFL Engraving Defaults","Loads engraving defaults for the current SMuFL Default Music Font."end;local o=require("lunajson.lunajson")local p=require("library.general_library")function smufl_load_engraving_defaults()local q=finale.FCFontInfo()q:LoadFontPrefs(finale.FONTPREF_MUSIC)local r=p.get_smufl_metadata_file(q)if nil==r then finenv.UI():AlertError("The current Default Music Font ("..q.Name..") is not a SMuFL font, or else the json file with its engraving defaults is not installed.","Default Music Font is not SMuFL")return end;local s=r:read("*all")io.close(r)local t=o.decode(s)local u=24.0;local v=64.0;local w=u*v;local x=finale.FCMusicCharacterPrefs()x:Load(1)local y=finale.FCDistancePrefs()y:Load(1)local z=finale.FCSizePrefs()z:Load(1)local A=finale.FCLyricsPrefs()A:Load(1)local B=finale.FCSmartShapePrefs()B:Load(1)local C=finale.FCRepeatPrefs()C:Load(1)local D=finale.FCTiePrefs()D:Load(1)local E=finale.FCTupletPrefs()E:Load(1)local F=0;local G=math.floor(z.BeamThickness/v+0.5)local H={staffLineThickness=function(I)z.StaffLineThickness=math.floor(w*I+0.5)end,stemThickness=function(I)z.StemLineThickness=math.floor(w*I+0.5)end,beamThickness=function(I)z.BeamThickness=math.floor(w*I+0.5)G=math.floor(u*I+0.5)end,beamSpacing=function(I)F=math.floor(u*I+0.5)end,legerLineThickness=function(I)z.LedgerLineThickness=math.floor(w*I+0.5)end,legerLineExtension=function(I)z.LedgerLeftHalf=math.floor(u*I+0.5)z.LedgerRightHalf=z.LedgerLeftHalf;z.LedgerLeftRestHalf=z.LedgerLeftHalf;z.LedgerRightRestHalf=z.LedgerLeftHalf end,slurEndpointThickness=function(I)z.ShapeSlurTipWidth=math.floor(u*I*10000.0+0.5)B.SlurTipWidth=math.floor(u*I*10000.0+0.5)end,slurMidpointThickness=function(I)B.SlurThicknessVerticalLeft=math.floor(u*I+0.5)B.SlurThicknessVerticalRight=math.floor(u*I+0.5)end,tieEndpointThickness=function(I)D.TipWidth=math.floor(u*I*10000.0+0.5)end,tieMidpointThickness=function(I)D.ThicknessLeft=math.floor(u*I+0.5)D.ThicknessRight=math.floor(u*I+0.5)end,thinBarlineThickness=function(I)z.ThinBarlineThickness=math.floor(w*I+0.5)C.ThinLineThickness=math.floor(w*I+0.5)end,thickBarlineThickness=function(I)z.HeavyBarlineThickness=math.floor(w*I+0.5)C.HeavyLineThickness=math.floor(w*I+0.5)end,dashedBarlineThickness=function(I)z.ThinBarlineThickness=math.floor(w*I+0.5)end,dashedBarlineDashLength=function(I)z.BarlineDashLength=math.floor(u*I+0.5)end,dashedBarlineGapLength=function(I)y.BarlineDashSpace=math.floor(u*I+0.5)end,barlineSeparation=function(I)y.BarlineDoubleSpace=math.floor(w*I+0.5)end,thinThickBarlineSeparation=function(I)y.BarlineFinalSpace=math.floor(w*I+0.5)C.SpaceBetweenLines=math.floor(w*I+0.5)end,repeatBarlineDotSeparation=function(I)local J=finale.FCTextMetrics()J:LoadSymbol(x.SymbolForwardRepeatDot,q,100)local K=u*I+J:CalcWidthEVPUs()C:SetForwardSpace(math.floor(K+0.5))C:SetBackwardSpace(math.floor(K+0.5))end,bracketThickness=function(I)end,subBracketThickness=function(I)end,hairpinThickness=function(I)B.HairpinLineWidth=math.floor(w*I+0.5)end,octaveLineThickness=function(I)B.LineWidth=math.floor(w*I+0.5)end,pedalLineThickness=function(I)end,repeatEndingLineThickness=function(I)C.EndingLineThickness=math.floor(w*I+0.5)end,arrowShaftThickness=function(I)end,lyricLineThickness=function(I)A.WordExtLineThickness=math.floor(w*I+0.5)end,textEnclosureThickness=function(I)z.EnclosureThickness=math.floor(w*I+0.5)local L=finale.FCTextExpressionDefs()L:LoadAll()for M in each(L)do if M.UseEnclosure then local N=M:CreateEnclosure()if nil~=N then N.LineWidth=z.EnclosureThickness;N:Save()end end end;local O=finale.FCMeasureNumberRegions()O:LoadAll()for P in each(O)do local Q=false;for R,S in pairs({false,true})do if P:GetUseEnclosureStart(S)then local T=P:GetEnclosureStart(S)if nil~=T then T.LineWidth=z.EnclosureThickness;Q=true end end;if P:GetUseEnclosureMultiple(S)then local U=P:GetEnclosureMultiple(S)if nil~=U then U.LineWidth=z.EnclosureThickness;Q=true end end end;if Q then P:Save()end end;local V=finale.FCSeparateMeasureNumbers()V:LoadAll()for W in each(V)do if W.UseEnclosure then local X=W:GetEnclosure()if nil~=X then X.LineWidth=z.EnclosureThickness end;W:Save()end end end,tupletBracketThickness=function(I)E.BracketThickness=math.floor(w*I+0.5)end,hBarThickness=function(I)end}for Y,I in pairs(t.engravingDefaults)do local Z=H[Y]if nil~=Z then Z(tonumber(I))end end;if 0~=F then y.SecondaryBeamSpace=F+G;local _="Finale "if _==q.Name:sub(1,#_)then y.SecondaryBeamSpace=F end end;y:Save()z:Save()A:Save()B:Save()C:Save()D:Save()E:Save()end;smufl_load_engraving_defaults()end)c("library.general_library",function(require,n,c,d)local p={}function p.finale_version(a0,a1,a2)local a3=bit32.bor(bit32.lshift(math.floor(a0),24),bit32.lshift(math.floor(a1),20))if a2 then a3=bit32.bor(a3,math.floor(a2))end;return a3 end;function p.group_overlaps_region(a4,P)if P:IsFullDocumentSpan()then return true end;local a5=false;local a6=finale.FCSystemStaves()a6:LoadAllForRegion(P)for a7 in each(a6)do if a4:ContainsStaff(a7:GetStaff())then a5=true;break end end;if not a5 then return false end;if a4.StartMeasure>P.EndMeasure or a4.EndMeasure<P.StartMeasure then return false end;return true end;function p.group_is_contained_in_region(a4,P)if not P:IsStaffIncluded(a4.StartStaff)then return false end;if not P:IsStaffIncluded(a4.EndStaff)then return false end;return true end;function p.staff_group_is_multistaff_instrument(a4)local a8=finale.FCMultiStaffInstruments()a8:LoadAll()for a9 in each(a8)do if a9:ContainsStaff(a4.StartStaff)and a9.GroupID==a4:GetItemID()then return true end end;return false end;function p.get_selected_region_or_whole_doc()local aa=finenv.Region()if aa:IsEmpty()then aa:SetFullDocument()end;return aa end;function p.get_first_cell_on_or_after_page(ab)local ac=ab;local ad=finale.FCPage()local Q=false;while ad:Load(ac)do if ad:GetFirstSystem()>0 then Q=true;break end;ac=ac+1 end;if Q then local ae=finale.FCStaffSystem()ae:Load(ad:GetFirstSystem())return finale.FCCell(ae.FirstMeasure,ae.TopStaff)end;local af=finale.FCMusicRegion()af:SetFullDocument()return finale.FCCell(af.EndMeasure,af.EndStaff)end;function p.get_top_left_visible_cell()if not finenv.UI():IsPageView()then local ag=finale.FCMusicRegion()ag:SetFullDocument()return finale.FCCell(finenv.UI():GetCurrentMeasure(),ag.StartStaff)end;return p.get_first_cell_on_or_after_page(finenv.UI():GetCurrentPage())end;function p.get_top_left_selected_or_visible_cell()local aa=finenv.Region()if not aa:IsEmpty()then return finale.FCCell(aa.StartMeasure,aa.StartStaff)end;return p.get_top_left_visible_cell()end;function p.is_default_measure_number_visible_on_cell(ah,ai,aj,ak)local al=finale.FCCurrentStaffSpec()if not al:LoadForCell(ai,0)then return false end;if ah:GetShowOnTopStaff()and ai.Staff==aj.TopStaff then return true end;if ah:GetShowOnBottomStaff()and ai.Staff==aj:CalcBottomStaff()then return true end;if al.ShowMeasureNumbers then return not ah:GetExcludeOtherStaves(ak)end;return false end;function p.is_default_number_visible_and_left_aligned(ah,ai,am,ak,an)if ah.UseScoreInfoForParts then ak=false end;if an and ah:GetShowOnMultiMeasureRests(ak)then if finale.MNALIGN_LEFT~=ah:GetMultiMeasureAlignment(ak)then return false end elseif ai.Measure==am.FirstMeasure then if not ah:GetShowOnSystemStart()then return false end;if finale.MNALIGN_LEFT~=ah:GetStartAlignment(ak)then return false end else if not ah:GetShowMultiples(ak)then return false end;if finale.MNALIGN_LEFT~=ah:GetMultipleAlignment(ak)then return false end end;return p.is_default_measure_number_visible_on_cell(ah,ai,am,ak)end;function p.update_layout(ao,ap)ao=ao or 1;ap=ap or false;local aq=finale.FCPage()if aq:Load(ao)then aq:UpdateLayout(ap)end end;function p.get_current_part()local ar=finale.FCParts()ar:LoadAll()return ar:GetCurrent()end;function p.get_page_format_prefs()local as=p.get_current_part()local at=finale.FCPageFormatPrefs()local au=false;if as:IsScore()then au=at:LoadScore()else au=at:LoadParts()end;return at,au end;local av=function(aw)local ax=finenv.UI():IsOnWindows()local ay=function(az,aA)if finenv.UI():IsOnWindows()then return az and os.getenv(az)or""else return aA and os.getenv(aA)or""end end;local aB=aw and ay("LOCALAPPDATA","HOME")or ay("COMMONPROGRAMFILES")if not ax then aB=aB.."/Library/Application Support"end;aB=aB.."/SMuFL/Fonts/"return aB end;function p.get_smufl_font_list()local aC={}local aD=function(aw)local aB=av(aw)local aE=function()if finenv.UI():IsOnWindows()then return io.popen('dir "'..aB..'" /b /ad')else return io.popen('ls "'..aB..'"')end end;local aF=function(aG)local aH=finale.FCString()aH.LuaString=aG;return finenv.UI():IsFontAvailable(aH)end;for aG in aE():lines()do if not aG:find("%.")then aG=aG:gsub(" Bold","")aG=aG:gsub(" Italic","")local aH=finale.FCString()aH.LuaString=aG;if aC[aG]or aF(aG)then aC[aG]=aw and"user"or"system"end end end end;aD(true)aD(false)return aC end;function p.get_smufl_metadata_file(q)if not q then q=finale.FCFontInfo()q:LoadFontPrefs(finale.FONTPREF_MUSIC)end;local aI=function(aJ,q)local aK=aJ..q.Name.."/"..q.Name..".json"return io.open(aK,"r")end;local aL=aI(av(true),q)if aL then return aL end;return aI(av(false),q)end;function p.is_font_smufl_font(q)if not q then q=finale.FCFontInfo()q:LoadFontPrefs(finale.FONTPREF_MUSIC)end;if finenv.RawFinaleVersion>=p.finale_version(27,1)then if nil~=q.IsSMuFLFont then return q.IsSMuFLFont end end;local aM=p.get_smufl_metadata_file(q)if nil~=aM then io.close(aM)return true end;return false end;function p.simple_input(aN,aO)local aP=finale.FCString()aP.LuaString=""local aQ=finale.FCString()local aR=160;function format_ctrl(aS,aT,aU,aV)aS:SetHeight(aT)aS:SetWidth(aU)aQ.LuaString=aV;aS:SetText(aQ)end;title_width=string.len(aN)*6+54;if title_width>aR then aR=title_width end;text_width=string.len(aO)*6;if text_width>aR then aR=text_width end;aQ.LuaString=aN;local aW=finale.FCCustomLuaWindow()aW:SetTitle(aQ)local aX=aW:CreateStatic(0,0)format_ctrl(aX,16,aR,aO)local aY=aW:CreateEdit(0,20)format_ctrl(aY,20,aR,"")aW:CreateOkButton()aW:CreateCancelButton()function callback(aS)end;aW:RegisterHandleCommand(callback)if aW:ExecuteModal(nil)==finale.EXECMODAL_OK then aP.LuaString=aY:GetText(aP)return aP.LuaString end end;function p.is_finale_object(aZ)return aZ and type(aZ)=="userdata"and aZ.ClassName and aZ.GetClassID and true or false end;function p.system_indent_set_to_prefs(am,at)at=at or p.get_page_format_prefs()local a_=finale.FCMeasure()local b0=am.FirstMeasure==1;if not b0 and a_:Load(am.FirstMeasure)then if a_.ShowFullNames then b0=true end end;if b0 and at.UseFirstSystemMargins then am.LeftMargin=at.FirstSystemLeft else am.LeftMargin=at.SystemLeft end;return am:Save()end;function p.calc_script_name(b1)local b2=finale.FCString()if finenv.RunningLuaFilePath then b2.LuaString=finenv.RunningLuaFilePath()else b2:SetRunningLuaFilePath()end;local b3=finale.FCString()b2:SplitToPathAndFile(nil,b3)local a3=b3.LuaString;if not b1 then a3=a3:match("(.+)%..+")if not a3 or a3==""then a3=b3.LuaString end end;return a3 end;return p end)c("lunajson.lunajson",function(require,n,c,d)local p={}function p.finale_version(a0,a1,a2)local a3=bit32.bor(bit32.lshift(math.floor(a0),24),bit32.lshift(math.floor(a1),20))if a2 then a3=bit32.bor(a3,math.floor(a2))end;return a3 end;function p.group_overlaps_region(a4,P)if P:IsFullDocumentSpan()then return true end;local a5=false;local a6=finale.FCSystemStaves()a6:LoadAllForRegion(P)for a7 in each(a6)do if a4:ContainsStaff(a7:GetStaff())then a5=true;break end end;if not a5 then return false end;if a4.StartMeasure>P.EndMeasure or a4.EndMeasure<P.StartMeasure then return false end;return true end;function p.group_is_contained_in_region(a4,P)if not P:IsStaffIncluded(a4.StartStaff)then return false end;if not P:IsStaffIncluded(a4.EndStaff)then return false end;return true end;function p.staff_group_is_multistaff_instrument(a4)local a8=finale.FCMultiStaffInstruments()a8:LoadAll()for a9 in each(a8)do if a9:ContainsStaff(a4.StartStaff)and a9.GroupID==a4:GetItemID()then return true end end;return false end;function p.get_selected_region_or_whole_doc()local aa=finenv.Region()if aa:IsEmpty()then aa:SetFullDocument()end;return aa end;function p.get_first_cell_on_or_after_page(ab)local ac=ab;local ad=finale.FCPage()local Q=false;while ad:Load(ac)do if ad:GetFirstSystem()>0 then Q=true;break end;ac=ac+1 end;if Q then local ae=finale.FCStaffSystem()ae:Load(ad:GetFirstSystem())return finale.FCCell(ae.FirstMeasure,ae.TopStaff)end;local af=finale.FCMusicRegion()af:SetFullDocument()return finale.FCCell(af.EndMeasure,af.EndStaff)end;function p.get_top_left_visible_cell()if not finenv.UI():IsPageView()then local ag=finale.FCMusicRegion()ag:SetFullDocument()return finale.FCCell(finenv.UI():GetCurrentMeasure(),ag.StartStaff)end;return p.get_first_cell_on_or_after_page(finenv.UI():GetCurrentPage())end;function p.get_top_left_selected_or_visible_cell()local aa=finenv.Region()if not aa:IsEmpty()then return finale.FCCell(aa.StartMeasure,aa.StartStaff)end;return p.get_top_left_visible_cell()end;function p.is_default_measure_number_visible_on_cell(ah,ai,aj,ak)local al=finale.FCCurrentStaffSpec()if not al:LoadForCell(ai,0)then return false end;if ah:GetShowOnTopStaff()and ai.Staff==aj.TopStaff then return true end;if ah:GetShowOnBottomStaff()and ai.Staff==aj:CalcBottomStaff()then return true end;if al.ShowMeasureNumbers then return not ah:GetExcludeOtherStaves(ak)end;return false end;function p.is_default_number_visible_and_left_aligned(ah,ai,am,ak,an)if ah.UseScoreInfoForParts then ak=false end;if an and ah:GetShowOnMultiMeasureRests(ak)then if finale.MNALIGN_LEFT~=ah:GetMultiMeasureAlignment(ak)then return false end elseif ai.Measure==am.FirstMeasure then if not ah:GetShowOnSystemStart()then return false end;if finale.MNALIGN_LEFT~=ah:GetStartAlignment(ak)then return false end else if not ah:GetShowMultiples(ak)then return false end;if finale.MNALIGN_LEFT~=ah:GetMultipleAlignment(ak)then return false end end;return p.is_default_measure_number_visible_on_cell(ah,ai,am,ak)end;function p.update_layout(ao,ap)ao=ao or 1;ap=ap or false;local aq=finale.FCPage()if aq:Load(ao)then aq:UpdateLayout(ap)end end;function p.get_current_part()local ar=finale.FCParts()ar:LoadAll()return ar:GetCurrent()end;function p.get_page_format_prefs()local as=p.get_current_part()local at=finale.FCPageFormatPrefs()local au=false;if as:IsScore()then au=at:LoadScore()else au=at:LoadParts()end;return at,au end;local av=function(aw)local ax=finenv.UI():IsOnWindows()local ay=function(az,aA)if finenv.UI():IsOnWindows()then return az and os.getenv(az)or""else return aA and os.getenv(aA)or""end end;local aB=aw and ay("LOCALAPPDATA","HOME")or ay("COMMONPROGRAMFILES")if not ax then aB=aB.."/Library/Application Support"end;aB=aB.."/SMuFL/Fonts/"return aB end;function p.get_smufl_font_list()local aC={}local aD=function(aw)local aB=av(aw)local aE=function()if finenv.UI():IsOnWindows()then return io.popen('dir "'..aB..'" /b /ad')else return io.popen('ls "'..aB..'"')end end;local aF=function(aG)local aH=finale.FCString()aH.LuaString=aG;return finenv.UI():IsFontAvailable(aH)end;for aG in aE():lines()do if not aG:find("%.")then aG=aG:gsub(" Bold","")aG=aG:gsub(" Italic","")local aH=finale.FCString()aH.LuaString=aG;if aC[aG]or aF(aG)then aC[aG]=aw and"user"or"system"end end end end;aD(true)aD(false)return aC end;function p.get_smufl_metadata_file(q)if not q then q=finale.FCFontInfo()q:LoadFontPrefs(finale.FONTPREF_MUSIC)end;local aI=function(aJ,q)local aK=aJ..q.Name.."/"..q.Name..".json"return io.open(aK,"r")end;local aL=aI(av(true),q)if aL then return aL end;return aI(av(false),q)end;function p.is_font_smufl_font(q)if not q then q=finale.FCFontInfo()q:LoadFontPrefs(finale.FONTPREF_MUSIC)end;if finenv.RawFinaleVersion>=p.finale_version(27,1)then if nil~=q.IsSMuFLFont then return q.IsSMuFLFont end end;local aM=p.get_smufl_metadata_file(q)if nil~=aM then io.close(aM)return true end;return false end;function p.simple_input(aN,aO)local aP=finale.FCString()aP.LuaString=""local aQ=finale.FCString()local aR=160;function format_ctrl(aS,aT,aU,aV)aS:SetHeight(aT)aS:SetWidth(aU)aQ.LuaString=aV;aS:SetText(aQ)end;title_width=string.len(aN)*6+54;if title_width>aR then aR=title_width end;text_width=string.len(aO)*6;if text_width>aR then aR=text_width end;aQ.LuaString=aN;local aW=finale.FCCustomLuaWindow()aW:SetTitle(aQ)local aX=aW:CreateStatic(0,0)format_ctrl(aX,16,aR,aO)local aY=aW:CreateEdit(0,20)format_ctrl(aY,20,aR,"")aW:CreateOkButton()aW:CreateCancelButton()function callback(aS)end;aW:RegisterHandleCommand(callback)if aW:ExecuteModal(nil)==finale.EXECMODAL_OK then aP.LuaString=aY:GetText(aP)return aP.LuaString end end;function p.is_finale_object(aZ)return aZ and type(aZ)=="userdata"and aZ.ClassName and aZ.GetClassID and true or false end;function p.system_indent_set_to_prefs(am,at)at=at or p.get_page_format_prefs()local a_=finale.FCMeasure()local b0=am.FirstMeasure==1;if not b0 and a_:Load(am.FirstMeasure)then if a_.ShowFullNames then b0=true end end;if b0 and at.UseFirstSystemMargins then am.LeftMargin=at.FirstSystemLeft else am.LeftMargin=at.SystemLeft end;return am:Save()end;function p.calc_script_name(b1)local b2=finale.FCString()if finenv.RunningLuaFilePath then b2.LuaString=finenv.RunningLuaFilePath()else b2:SetRunningLuaFilePath()end;local b3=finale.FCString()b2:SplitToPathAndFile(nil,b3)local a3=b3.LuaString;if not b1 then a3=a3:match("(.+)%..+")if not a3 or a3==""then a3=b3.LuaString end end;return a3 end;return p end)return a("__root")