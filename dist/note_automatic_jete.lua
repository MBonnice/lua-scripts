local a,b,c,d=(function(e)local f={[{}]=true}local g;local h={}local require;local i={}g=function(j,k)if not h[j]then h[j]=k end end;require=function(j)local l=i[j]if l then if l==f then return nil end else if not h[j]then if not e then local m=type(j)=='string'and'\"'..j..'\"'or tostring(j)error('Tried to require '..m..', but no such module has been registered')else return e(j)end end;i[j]=f;l=h[j](require,i,g,h)i[j]=l end;return l end;return require,i,g,h end)(require)c("__root",function(require,n,c,d)function plugindef()finaleplugin.RequireSelection=true;finaleplugin.Author="Robert Patterson"finaleplugin.Copyright="CC0 https://creativecommons.org/publicdomain/zero/1.0/"finaleplugin.Version="1.0"finaleplugin.Date="March 14, 2020"finaleplugin.CategoryTags="Note"finaleplugin.Notes=[[
        This script automatically creates a “jeté”-style bowing effect. These mimic examples shown on p. 404 of “Behind Bars"
        by Elaine Gould. For the best results with staccato dots, use an articulation with “Avoid Staff Lines” unchecked.

        By default, the script searches for articulations using the '.' character (ASCII code 46) for non-SMuFL fonts and
        the SMuFL dot character (UTF code 0xe4a2) for SMuFL fonts. This character must be the Main Character in Finale's
        articulation definition dialog. You can override this to search for a different character code using a
        configuration file. (See below.)

        To use the script, you enter the notes you want to display, and it removes the noteheads in between the first
        and last notehead, adjusts any staccato dots, and adds a gliss mark (tab slide) between the first and last notes,
        unless there is one already there. If you want a slur as well, add it manually before or after running the script.

        The steps to use this script are:

        1. Add the notes you want to display, with or without accidentals. Normally you choose notes with noteheads
        that follow a straight-line path as closely as possible. They can be reduced size or grace notes.
        2. Add staccato dots if you want them.
        3. Add a slur if you want it.
        4. Run the script on the pattern you just entered.

        The script takes the following actions:

        1. Searches for a selected pattern, skipping rests at the beginning and stopping at the first rest it encounters.
        2. Hides the noteheads on all but the first and (optionally) last entry.
        3. Hides accidentals on any noteheads that were hidden.
        4. Aligns the staccato dots in a straight line path. (The path may not be exactly straight
            if the articulation is set to avoid staff lines.)
        5. Adds a gliss mark (tab slide) between the first and last notes, if one does not already exist.
            If you have entered parallel chords, it adds a gliss mark for each note in the chord.

        By default, the script does not hide the last selected note (or any accidentals it may have). You can override
        this behavior with a configuration file or if you are using RGP Lua 0.59 or higher, you can cause the script
        to hide the last note by holding down Shift, Option (Mac), or Alt (Win) when you invoke it.

        To use a configuration file:

        1. If it does not exist, create a subfolder called `script_settings` in the folder where this script resides.
        2. Create a text file in the `script_settings` folder called `note_automatic_jete.config.txt`.
        3. Add either or both of the following lines to it.

        ```
        dot_character = 46           -- This may be any character code you wish to search use, including a SMuFL character code.
        hide_last_note = true        -- This value will be reversed if you hold down a modifier key when invoking the script. (See above.)
        ```
    ]]return"Automatic Jeté","Automatic Jete","Add gliss. marks, hide noteheads, and adjust staccato marks as needed for jeté bowing."end;local o=require("library.note_entry")local p=require("library.articulation")local q=require("library.configuration")local r=require("library.general_library")local s=4;local t={dot_character=46,hide_last_note=false}if r.is_font_smufl_font()then t.dot_character=0xe4a2 end;q.get_parameters("note_automatic_jete.config.txt",t)if finenv.QueryInvokedModifierKeys then if finenv.QueryInvokedModifierKeys(finale.CMDMODKEY_ALT)or finenv.QueryInvokedModifierKeys(finale.CMDMODKEY_SHIFT)then t.hide_last_note=not t.hide_last_note end end;function add_gliss_line_if_needed(u,v)local w=finale.FCSmartShapeEntryMarks(u.Entry)w:LoadAll()for x in each(w)do if x:CalcLeftMark()then local y=finale.FCSmartShape()if y:Load(x.ShapeNumber)then if y:IsTabSlide()then local z=y:GetTerminateSegmentRight()if z.EntryNumber==v.Entry.EntryNumber and z.NoteID==v.NoteID then return y end end end end end;local A=finale.FCSmartShape()A.ShapeType=finale.SMARTSHAPE_TABSLIDE;A.EntryBased=true;A.BeatAttached=false;A.MakeHorizontal=false;A.PresetShape=true;A.Visible=true;A:SetSlurFlags(false)A:SetEntryAttachedFlags(true)local B=A:GetTerminateSegmentLeft()B.Measure=u.Entry.Measure;B.Staff=u.Entry.Staff;B:SetEntry(u.Entry)B:SetNoteID(u.NoteID)local z=A:GetTerminateSegmentRight()z.Measure=v.Entry.Measure;z.Staff=v.Entry.Staff;z:SetEntry(v.Entry)z:SetNoteID(v.NoteID)if A:SaveNewEverything(u.Entry,v.Entry)then return A end;return nil end;function find_staccato_articulation(C,D)D=D or 0;local E=C:CreateArticulations()for F in each(E)do local G=finale.FCPoint(0,0)if F:CalcMetricPos(G)then if D==F.ID then return F,G elseif 0==D then local H=F:CreateArticulationDef()if nil~=H then if t.dot_character==H.MainSymbolChar then if p.is_note_side(F,G)then return F,G end end end end end end;return nil,nil end;function note_automatic_jete()local I=finenv.Region()for J=I.StartSlot,I.EndSlot do local K=finale.FCMusicRegion()K:SetCurrentSelection()K.StartSlot=J;K.EndSlot=J;for L=1,s do local M=nil;local N=nil;local O={}local P=nil;for C in eachentry(K)do if C.LayerNumber==L then if P and P<C.Measure-1 then break end;P=C.Measure;local Q=C:IsRest()if Q and nil~=M then break end;if not Q then if nil==M then M=C.EntryNumber end;N=C.EntryNumber;O[C.EntryNumber]=C end end end;if M~=N then local R=nil;local S=nil;local T=0;for C in eachentrysaved(K)do if nil~=O[C.EntryNumber]then if C.EntryNumber==M then local U=O[N]if nil~=U then local V=0;for W in each(C)do local X=o.calc_note_at_index(U,V)if nil~=W then add_gliss_line_if_needed(W,X)end;V=V+1 end;local Y=nil;Y,R=find_staccato_articulation(C)if nil~=Y then T=Y.ID;_,S=find_staccato_articulation(U,T)end end elseif C.EntryNumber~=N or t.hide_last_note then C.LedgerLines=false;C:SetAccidentals(false)for W in each(C)do W.Accidental=false;W.AccidentalFreeze=true;local Z=finale.FCNoteheadMod()Z:SetNoteEntry(C)Z:LoadAt(W)Z.CustomChar=string.byte(" ")Z:SaveAt(W)end end end end;if R and S and R.X~=S.X then local a0=(S.Y-R.Y)/(S.X-R.X)local a1=(S.X*R.Y-R.X*S.Y)/(S.X-R.X)finale.FCNoteEntry.MarkEntryMetricsForUpdate()for a2,C in pairs(O)do if C.EntryNumber~=M and C.EntryNumber~=N then local F,a3=find_staccato_articulation(C,T)if nil~=F then local a4=a0*a3.X+a1;local a5=F.VerticalPos;F.VerticalPos=F.VerticalPos-o.stem_sign(C)*(math.floor(a4+0.5)-a3.Y)F:Save()end end end end end end end end;note_automatic_jete()end)c("library.general_library",function(require,n,c,d)local r={}function r.finale_version(a6,a7,a8)local a9=bit32.bor(bit32.lshift(math.floor(a6),24),bit32.lshift(math.floor(a7),20))if a8 then a9=bit32.bor(a9,math.floor(a8))end;return a9 end;function r.group_overlaps_region(aa,ab)if ab:IsFullDocumentSpan()then return true end;local ac=false;local ad=finale.FCSystemStaves()ad:LoadAllForRegion(ab)for ae in each(ad)do if aa:ContainsStaff(ae:GetStaff())then ac=true;break end end;if not ac then return false end;if aa.StartMeasure>ab.EndMeasure or aa.EndMeasure<ab.StartMeasure then return false end;return true end;function r.group_is_contained_in_region(aa,ab)if not ab:IsStaffIncluded(aa.StartStaff)then return false end;if not ab:IsStaffIncluded(aa.EndStaff)then return false end;return true end;function r.staff_group_is_multistaff_instrument(aa)local af=finale.FCMultiStaffInstruments()af:LoadAll()for ag in each(af)do if ag:ContainsStaff(aa.StartStaff)and ag.GroupID==aa:GetItemID()then return true end end;return false end;function r.get_selected_region_or_whole_doc()local I=finenv.Region()if I:IsEmpty()then I:SetFullDocument()end;return I end;function r.get_first_cell_on_or_after_page(ah)local ai=ah;local aj=finale.FCPage()local ak=false;while aj:Load(ai)do if aj:GetFirstSystem()>0 then ak=true;break end;ai=ai+1 end;if ak then local al=finale.FCStaffSystem()al:Load(aj:GetFirstSystem())return finale.FCCell(al.FirstMeasure,al.TopStaff)end;local am=finale.FCMusicRegion()am:SetFullDocument()return finale.FCCell(am.EndMeasure,am.EndStaff)end;function r.get_top_left_visible_cell()if not finenv.UI():IsPageView()then local an=finale.FCMusicRegion()an:SetFullDocument()return finale.FCCell(finenv.UI():GetCurrentMeasure(),an.StartStaff)end;return r.get_first_cell_on_or_after_page(finenv.UI():GetCurrentPage())end;function r.get_top_left_selected_or_visible_cell()local I=finenv.Region()if not I:IsEmpty()then return finale.FCCell(I.StartMeasure,I.StartStaff)end;return r.get_top_left_visible_cell()end;function r.is_default_measure_number_visible_on_cell(ao,ap,aq,ar)local as=finale.FCCurrentStaffSpec()if not as:LoadForCell(ap,0)then return false end;if ao:GetShowOnTopStaff()and ap.Staff==aq.TopStaff then return true end;if ao:GetShowOnBottomStaff()and ap.Staff==aq:CalcBottomStaff()then return true end;if as.ShowMeasureNumbers then return not ao:GetExcludeOtherStaves(ar)end;return false end;function r.is_default_number_visible_and_left_aligned(ao,ap,at,ar,au)if ao.UseScoreInfoForParts then ar=false end;if au and ao:GetShowOnMultiMeasureRests(ar)then if finale.MNALIGN_LEFT~=ao:GetMultiMeasureAlignment(ar)then return false end elseif ap.Measure==at.FirstMeasure then if not ao:GetShowOnSystemStart()then return false end;if finale.MNALIGN_LEFT~=ao:GetStartAlignment(ar)then return false end else if not ao:GetShowMultiples(ar)then return false end;if finale.MNALIGN_LEFT~=ao:GetMultipleAlignment(ar)then return false end end;return r.is_default_measure_number_visible_on_cell(ao,ap,at,ar)end;function r.update_layout(av,aw)av=av or 1;aw=aw or false;local ax=finale.FCPage()if ax:Load(av)then ax:UpdateLayout(aw)end end;function r.get_current_part()local ay=finale.FCParts()ay:LoadAll()return ay:GetCurrent()end;function r.get_page_format_prefs()local az=r.get_current_part()local aA=finale.FCPageFormatPrefs()local aB=false;if az:IsScore()then aB=aA:LoadScore()else aB=aA:LoadParts()end;return aA,aB end;local aC=function(aD)local aE=finenv.UI():IsOnWindows()local aF=function(aG,aH)if finenv.UI():IsOnWindows()then return aG and os.getenv(aG)or""else return aH and os.getenv(aH)or""end end;local aI=aD and aF("LOCALAPPDATA","HOME")or aF("COMMONPROGRAMFILES")if not aE then aI=aI.."/Library/Application Support"end;aI=aI.."/SMuFL/Fonts/"return aI end;function r.get_smufl_font_list()local aJ={}local aK=function(aD)local aI=aC(aD)local aL=function()if finenv.UI():IsOnWindows()then return io.popen('dir "'..aI..'" /b /ad')else return io.popen('ls "'..aI..'"')end end;local aM=function(aN)local aO=finale.FCString()aO.LuaString=aN;return finenv.UI():IsFontAvailable(aO)end;for aN in aL():lines()do if not aN:find("%.")then aN=aN:gsub(" Bold","")aN=aN:gsub(" Italic","")local aO=finale.FCString()aO.LuaString=aN;if aJ[aN]or aM(aN)then aJ[aN]=aD and"user"or"system"end end end end;aK(true)aK(false)return aJ end;function r.get_smufl_metadata_file(aP)if not aP then aP=finale.FCFontInfo()aP:LoadFontPrefs(finale.FONTPREF_MUSIC)end;local aQ=function(aR,aP)local aS=aR..aP.Name.."/"..aP.Name..".json"return io.open(aS,"r")end;local aT=aQ(aC(true),aP)if aT then return aT end;return aQ(aC(false),aP)end;function r.is_font_smufl_font(aP)if not aP then aP=finale.FCFontInfo()aP:LoadFontPrefs(finale.FONTPREF_MUSIC)end;if finenv.RawFinaleVersion>=r.finale_version(27,1)then if nil~=aP.IsSMuFLFont then return aP.IsSMuFLFont end end;local aU=r.get_smufl_metadata_file(aP)if nil~=aU then io.close(aU)return true end;return false end;function r.simple_input(aV,aW)local aX=finale.FCString()aX.LuaString=""local aY=finale.FCString()local aZ=160;function format_ctrl(a_,b0,b1,b2)a_:SetHeight(b0)a_:SetWidth(b1)aY.LuaString=b2;a_:SetText(aY)end;title_width=string.len(aV)*6+54;if title_width>aZ then aZ=title_width end;text_width=string.len(aW)*6;if text_width>aZ then aZ=text_width end;aY.LuaString=aV;local b3=finale.FCCustomLuaWindow()b3:SetTitle(aY)local b4=b3:CreateStatic(0,0)format_ctrl(b4,16,aZ,aW)local b5=b3:CreateEdit(0,20)format_ctrl(b5,20,aZ,"")b3:CreateOkButton()b3:CreateCancelButton()function callback(a_)end;b3:RegisterHandleCommand(callback)if b3:ExecuteModal(nil)==finale.EXECMODAL_OK then aX.LuaString=b5:GetText(aX)return aX.LuaString end end;function r.is_finale_object(b6)return b6 and type(b6)=="userdata"and b6.ClassName and b6.GetClassID and true or false end;function r.system_indent_set_to_prefs(at,aA)aA=aA or r.get_page_format_prefs()local b7=finale.FCMeasure()local b8=at.FirstMeasure==1;if not b8 and b7:Load(at.FirstMeasure)then if b7.ShowFullNames then b8=true end end;if b8 and aA.UseFirstSystemMargins then at.LeftMargin=aA.FirstSystemLeft else at.LeftMargin=aA.SystemLeft end;return at:Save()end;function r.calc_script_name(b9)local ba=finale.FCString()if finenv.RunningLuaFilePath then ba.LuaString=finenv.RunningLuaFilePath()else ba:SetRunningLuaFilePath()end;local bb=finale.FCString()ba:SplitToPathAndFile(nil,bb)local a9=bb.LuaString;if not b9 then a9=a9:match("(.+)%..+")if not a9 or a9==""then a9=bb.LuaString end end;return a9 end;return r end)c("library.configuration",function(require,n,c,d)local r={}function r.finale_version(a6,a7,a8)local a9=bit32.bor(bit32.lshift(math.floor(a6),24),bit32.lshift(math.floor(a7),20))if a8 then a9=bit32.bor(a9,math.floor(a8))end;return a9 end;function r.group_overlaps_region(aa,ab)if ab:IsFullDocumentSpan()then return true end;local ac=false;local ad=finale.FCSystemStaves()ad:LoadAllForRegion(ab)for ae in each(ad)do if aa:ContainsStaff(ae:GetStaff())then ac=true;break end end;if not ac then return false end;if aa.StartMeasure>ab.EndMeasure or aa.EndMeasure<ab.StartMeasure then return false end;return true end;function r.group_is_contained_in_region(aa,ab)if not ab:IsStaffIncluded(aa.StartStaff)then return false end;if not ab:IsStaffIncluded(aa.EndStaff)then return false end;return true end;function r.staff_group_is_multistaff_instrument(aa)local af=finale.FCMultiStaffInstruments()af:LoadAll()for ag in each(af)do if ag:ContainsStaff(aa.StartStaff)and ag.GroupID==aa:GetItemID()then return true end end;return false end;function r.get_selected_region_or_whole_doc()local I=finenv.Region()if I:IsEmpty()then I:SetFullDocument()end;return I end;function r.get_first_cell_on_or_after_page(ah)local ai=ah;local aj=finale.FCPage()local ak=false;while aj:Load(ai)do if aj:GetFirstSystem()>0 then ak=true;break end;ai=ai+1 end;if ak then local al=finale.FCStaffSystem()al:Load(aj:GetFirstSystem())return finale.FCCell(al.FirstMeasure,al.TopStaff)end;local am=finale.FCMusicRegion()am:SetFullDocument()return finale.FCCell(am.EndMeasure,am.EndStaff)end;function r.get_top_left_visible_cell()if not finenv.UI():IsPageView()then local an=finale.FCMusicRegion()an:SetFullDocument()return finale.FCCell(finenv.UI():GetCurrentMeasure(),an.StartStaff)end;return r.get_first_cell_on_or_after_page(finenv.UI():GetCurrentPage())end;function r.get_top_left_selected_or_visible_cell()local I=finenv.Region()if not I:IsEmpty()then return finale.FCCell(I.StartMeasure,I.StartStaff)end;return r.get_top_left_visible_cell()end;function r.is_default_measure_number_visible_on_cell(ao,ap,aq,ar)local as=finale.FCCurrentStaffSpec()if not as:LoadForCell(ap,0)then return false end;if ao:GetShowOnTopStaff()and ap.Staff==aq.TopStaff then return true end;if ao:GetShowOnBottomStaff()and ap.Staff==aq:CalcBottomStaff()then return true end;if as.ShowMeasureNumbers then return not ao:GetExcludeOtherStaves(ar)end;return false end;function r.is_default_number_visible_and_left_aligned(ao,ap,at,ar,au)if ao.UseScoreInfoForParts then ar=false end;if au and ao:GetShowOnMultiMeasureRests(ar)then if finale.MNALIGN_LEFT~=ao:GetMultiMeasureAlignment(ar)then return false end elseif ap.Measure==at.FirstMeasure then if not ao:GetShowOnSystemStart()then return false end;if finale.MNALIGN_LEFT~=ao:GetStartAlignment(ar)then return false end else if not ao:GetShowMultiples(ar)then return false end;if finale.MNALIGN_LEFT~=ao:GetMultipleAlignment(ar)then return false end end;return r.is_default_measure_number_visible_on_cell(ao,ap,at,ar)end;function r.update_layout(av,aw)av=av or 1;aw=aw or false;local ax=finale.FCPage()if ax:Load(av)then ax:UpdateLayout(aw)end end;function r.get_current_part()local ay=finale.FCParts()ay:LoadAll()return ay:GetCurrent()end;function r.get_page_format_prefs()local az=r.get_current_part()local aA=finale.FCPageFormatPrefs()local aB=false;if az:IsScore()then aB=aA:LoadScore()else aB=aA:LoadParts()end;return aA,aB end;local aC=function(aD)local aE=finenv.UI():IsOnWindows()local aF=function(aG,aH)if finenv.UI():IsOnWindows()then return aG and os.getenv(aG)or""else return aH and os.getenv(aH)or""end end;local aI=aD and aF("LOCALAPPDATA","HOME")or aF("COMMONPROGRAMFILES")if not aE then aI=aI.."/Library/Application Support"end;aI=aI.."/SMuFL/Fonts/"return aI end;function r.get_smufl_font_list()local aJ={}local aK=function(aD)local aI=aC(aD)local aL=function()if finenv.UI():IsOnWindows()then return io.popen('dir "'..aI..'" /b /ad')else return io.popen('ls "'..aI..'"')end end;local aM=function(aN)local aO=finale.FCString()aO.LuaString=aN;return finenv.UI():IsFontAvailable(aO)end;for aN in aL():lines()do if not aN:find("%.")then aN=aN:gsub(" Bold","")aN=aN:gsub(" Italic","")local aO=finale.FCString()aO.LuaString=aN;if aJ[aN]or aM(aN)then aJ[aN]=aD and"user"or"system"end end end end;aK(true)aK(false)return aJ end;function r.get_smufl_metadata_file(aP)if not aP then aP=finale.FCFontInfo()aP:LoadFontPrefs(finale.FONTPREF_MUSIC)end;local aQ=function(aR,aP)local aS=aR..aP.Name.."/"..aP.Name..".json"return io.open(aS,"r")end;local aT=aQ(aC(true),aP)if aT then return aT end;return aQ(aC(false),aP)end;function r.is_font_smufl_font(aP)if not aP then aP=finale.FCFontInfo()aP:LoadFontPrefs(finale.FONTPREF_MUSIC)end;if finenv.RawFinaleVersion>=r.finale_version(27,1)then if nil~=aP.IsSMuFLFont then return aP.IsSMuFLFont end end;local aU=r.get_smufl_metadata_file(aP)if nil~=aU then io.close(aU)return true end;return false end;function r.simple_input(aV,aW)local aX=finale.FCString()aX.LuaString=""local aY=finale.FCString()local aZ=160;function format_ctrl(a_,b0,b1,b2)a_:SetHeight(b0)a_:SetWidth(b1)aY.LuaString=b2;a_:SetText(aY)end;title_width=string.len(aV)*6+54;if title_width>aZ then aZ=title_width end;text_width=string.len(aW)*6;if text_width>aZ then aZ=text_width end;aY.LuaString=aV;local b3=finale.FCCustomLuaWindow()b3:SetTitle(aY)local b4=b3:CreateStatic(0,0)format_ctrl(b4,16,aZ,aW)local b5=b3:CreateEdit(0,20)format_ctrl(b5,20,aZ,"")b3:CreateOkButton()b3:CreateCancelButton()function callback(a_)end;b3:RegisterHandleCommand(callback)if b3:ExecuteModal(nil)==finale.EXECMODAL_OK then aX.LuaString=b5:GetText(aX)return aX.LuaString end end;function r.is_finale_object(b6)return b6 and type(b6)=="userdata"and b6.ClassName and b6.GetClassID and true or false end;function r.system_indent_set_to_prefs(at,aA)aA=aA or r.get_page_format_prefs()local b7=finale.FCMeasure()local b8=at.FirstMeasure==1;if not b8 and b7:Load(at.FirstMeasure)then if b7.ShowFullNames then b8=true end end;if b8 and aA.UseFirstSystemMargins then at.LeftMargin=aA.FirstSystemLeft else at.LeftMargin=aA.SystemLeft end;return at:Save()end;function r.calc_script_name(b9)local ba=finale.FCString()if finenv.RunningLuaFilePath then ba.LuaString=finenv.RunningLuaFilePath()else ba:SetRunningLuaFilePath()end;local bb=finale.FCString()ba:SplitToPathAndFile(nil,bb)local a9=bb.LuaString;if not b9 then a9=a9:match("(.+)%..+")if not a9 or a9==""then a9=bb.LuaString end end;return a9 end;return r end)c("library.articulation",function(require,n,c,d)local r={}function r.finale_version(a6,a7,a8)local a9=bit32.bor(bit32.lshift(math.floor(a6),24),bit32.lshift(math.floor(a7),20))if a8 then a9=bit32.bor(a9,math.floor(a8))end;return a9 end;function r.group_overlaps_region(aa,ab)if ab:IsFullDocumentSpan()then return true end;local ac=false;local ad=finale.FCSystemStaves()ad:LoadAllForRegion(ab)for ae in each(ad)do if aa:ContainsStaff(ae:GetStaff())then ac=true;break end end;if not ac then return false end;if aa.StartMeasure>ab.EndMeasure or aa.EndMeasure<ab.StartMeasure then return false end;return true end;function r.group_is_contained_in_region(aa,ab)if not ab:IsStaffIncluded(aa.StartStaff)then return false end;if not ab:IsStaffIncluded(aa.EndStaff)then return false end;return true end;function r.staff_group_is_multistaff_instrument(aa)local af=finale.FCMultiStaffInstruments()af:LoadAll()for ag in each(af)do if ag:ContainsStaff(aa.StartStaff)and ag.GroupID==aa:GetItemID()then return true end end;return false end;function r.get_selected_region_or_whole_doc()local I=finenv.Region()if I:IsEmpty()then I:SetFullDocument()end;return I end;function r.get_first_cell_on_or_after_page(ah)local ai=ah;local aj=finale.FCPage()local ak=false;while aj:Load(ai)do if aj:GetFirstSystem()>0 then ak=true;break end;ai=ai+1 end;if ak then local al=finale.FCStaffSystem()al:Load(aj:GetFirstSystem())return finale.FCCell(al.FirstMeasure,al.TopStaff)end;local am=finale.FCMusicRegion()am:SetFullDocument()return finale.FCCell(am.EndMeasure,am.EndStaff)end;function r.get_top_left_visible_cell()if not finenv.UI():IsPageView()then local an=finale.FCMusicRegion()an:SetFullDocument()return finale.FCCell(finenv.UI():GetCurrentMeasure(),an.StartStaff)end;return r.get_first_cell_on_or_after_page(finenv.UI():GetCurrentPage())end;function r.get_top_left_selected_or_visible_cell()local I=finenv.Region()if not I:IsEmpty()then return finale.FCCell(I.StartMeasure,I.StartStaff)end;return r.get_top_left_visible_cell()end;function r.is_default_measure_number_visible_on_cell(ao,ap,aq,ar)local as=finale.FCCurrentStaffSpec()if not as:LoadForCell(ap,0)then return false end;if ao:GetShowOnTopStaff()and ap.Staff==aq.TopStaff then return true end;if ao:GetShowOnBottomStaff()and ap.Staff==aq:CalcBottomStaff()then return true end;if as.ShowMeasureNumbers then return not ao:GetExcludeOtherStaves(ar)end;return false end;function r.is_default_number_visible_and_left_aligned(ao,ap,at,ar,au)if ao.UseScoreInfoForParts then ar=false end;if au and ao:GetShowOnMultiMeasureRests(ar)then if finale.MNALIGN_LEFT~=ao:GetMultiMeasureAlignment(ar)then return false end elseif ap.Measure==at.FirstMeasure then if not ao:GetShowOnSystemStart()then return false end;if finale.MNALIGN_LEFT~=ao:GetStartAlignment(ar)then return false end else if not ao:GetShowMultiples(ar)then return false end;if finale.MNALIGN_LEFT~=ao:GetMultipleAlignment(ar)then return false end end;return r.is_default_measure_number_visible_on_cell(ao,ap,at,ar)end;function r.update_layout(av,aw)av=av or 1;aw=aw or false;local ax=finale.FCPage()if ax:Load(av)then ax:UpdateLayout(aw)end end;function r.get_current_part()local ay=finale.FCParts()ay:LoadAll()return ay:GetCurrent()end;function r.get_page_format_prefs()local az=r.get_current_part()local aA=finale.FCPageFormatPrefs()local aB=false;if az:IsScore()then aB=aA:LoadScore()else aB=aA:LoadParts()end;return aA,aB end;local aC=function(aD)local aE=finenv.UI():IsOnWindows()local aF=function(aG,aH)if finenv.UI():IsOnWindows()then return aG and os.getenv(aG)or""else return aH and os.getenv(aH)or""end end;local aI=aD and aF("LOCALAPPDATA","HOME")or aF("COMMONPROGRAMFILES")if not aE then aI=aI.."/Library/Application Support"end;aI=aI.."/SMuFL/Fonts/"return aI end;function r.get_smufl_font_list()local aJ={}local aK=function(aD)local aI=aC(aD)local aL=function()if finenv.UI():IsOnWindows()then return io.popen('dir "'..aI..'" /b /ad')else return io.popen('ls "'..aI..'"')end end;local aM=function(aN)local aO=finale.FCString()aO.LuaString=aN;return finenv.UI():IsFontAvailable(aO)end;for aN in aL():lines()do if not aN:find("%.")then aN=aN:gsub(" Bold","")aN=aN:gsub(" Italic","")local aO=finale.FCString()aO.LuaString=aN;if aJ[aN]or aM(aN)then aJ[aN]=aD and"user"or"system"end end end end;aK(true)aK(false)return aJ end;function r.get_smufl_metadata_file(aP)if not aP then aP=finale.FCFontInfo()aP:LoadFontPrefs(finale.FONTPREF_MUSIC)end;local aQ=function(aR,aP)local aS=aR..aP.Name.."/"..aP.Name..".json"return io.open(aS,"r")end;local aT=aQ(aC(true),aP)if aT then return aT end;return aQ(aC(false),aP)end;function r.is_font_smufl_font(aP)if not aP then aP=finale.FCFontInfo()aP:LoadFontPrefs(finale.FONTPREF_MUSIC)end;if finenv.RawFinaleVersion>=r.finale_version(27,1)then if nil~=aP.IsSMuFLFont then return aP.IsSMuFLFont end end;local aU=r.get_smufl_metadata_file(aP)if nil~=aU then io.close(aU)return true end;return false end;function r.simple_input(aV,aW)local aX=finale.FCString()aX.LuaString=""local aY=finale.FCString()local aZ=160;function format_ctrl(a_,b0,b1,b2)a_:SetHeight(b0)a_:SetWidth(b1)aY.LuaString=b2;a_:SetText(aY)end;title_width=string.len(aV)*6+54;if title_width>aZ then aZ=title_width end;text_width=string.len(aW)*6;if text_width>aZ then aZ=text_width end;aY.LuaString=aV;local b3=finale.FCCustomLuaWindow()b3:SetTitle(aY)local b4=b3:CreateStatic(0,0)format_ctrl(b4,16,aZ,aW)local b5=b3:CreateEdit(0,20)format_ctrl(b5,20,aZ,"")b3:CreateOkButton()b3:CreateCancelButton()function callback(a_)end;b3:RegisterHandleCommand(callback)if b3:ExecuteModal(nil)==finale.EXECMODAL_OK then aX.LuaString=b5:GetText(aX)return aX.LuaString end end;function r.is_finale_object(b6)return b6 and type(b6)=="userdata"and b6.ClassName and b6.GetClassID and true or false end;function r.system_indent_set_to_prefs(at,aA)aA=aA or r.get_page_format_prefs()local b7=finale.FCMeasure()local b8=at.FirstMeasure==1;if not b8 and b7:Load(at.FirstMeasure)then if b7.ShowFullNames then b8=true end end;if b8 and aA.UseFirstSystemMargins then at.LeftMargin=aA.FirstSystemLeft else at.LeftMargin=aA.SystemLeft end;return at:Save()end;function r.calc_script_name(b9)local ba=finale.FCString()if finenv.RunningLuaFilePath then ba.LuaString=finenv.RunningLuaFilePath()else ba:SetRunningLuaFilePath()end;local bb=finale.FCString()ba:SplitToPathAndFile(nil,bb)local a9=bb.LuaString;if not b9 then a9=a9:match("(.+)%..+")if not a9 or a9==""then a9=bb.LuaString end end;return a9 end;return r end)c("library.note_entry",function(require,n,c,d)local r={}function r.finale_version(a6,a7,a8)local a9=bit32.bor(bit32.lshift(math.floor(a6),24),bit32.lshift(math.floor(a7),20))if a8 then a9=bit32.bor(a9,math.floor(a8))end;return a9 end;function r.group_overlaps_region(aa,ab)if ab:IsFullDocumentSpan()then return true end;local ac=false;local ad=finale.FCSystemStaves()ad:LoadAllForRegion(ab)for ae in each(ad)do if aa:ContainsStaff(ae:GetStaff())then ac=true;break end end;if not ac then return false end;if aa.StartMeasure>ab.EndMeasure or aa.EndMeasure<ab.StartMeasure then return false end;return true end;function r.group_is_contained_in_region(aa,ab)if not ab:IsStaffIncluded(aa.StartStaff)then return false end;if not ab:IsStaffIncluded(aa.EndStaff)then return false end;return true end;function r.staff_group_is_multistaff_instrument(aa)local af=finale.FCMultiStaffInstruments()af:LoadAll()for ag in each(af)do if ag:ContainsStaff(aa.StartStaff)and ag.GroupID==aa:GetItemID()then return true end end;return false end;function r.get_selected_region_or_whole_doc()local I=finenv.Region()if I:IsEmpty()then I:SetFullDocument()end;return I end;function r.get_first_cell_on_or_after_page(ah)local ai=ah;local aj=finale.FCPage()local ak=false;while aj:Load(ai)do if aj:GetFirstSystem()>0 then ak=true;break end;ai=ai+1 end;if ak then local al=finale.FCStaffSystem()al:Load(aj:GetFirstSystem())return finale.FCCell(al.FirstMeasure,al.TopStaff)end;local am=finale.FCMusicRegion()am:SetFullDocument()return finale.FCCell(am.EndMeasure,am.EndStaff)end;function r.get_top_left_visible_cell()if not finenv.UI():IsPageView()then local an=finale.FCMusicRegion()an:SetFullDocument()return finale.FCCell(finenv.UI():GetCurrentMeasure(),an.StartStaff)end;return r.get_first_cell_on_or_after_page(finenv.UI():GetCurrentPage())end;function r.get_top_left_selected_or_visible_cell()local I=finenv.Region()if not I:IsEmpty()then return finale.FCCell(I.StartMeasure,I.StartStaff)end;return r.get_top_left_visible_cell()end;function r.is_default_measure_number_visible_on_cell(ao,ap,aq,ar)local as=finale.FCCurrentStaffSpec()if not as:LoadForCell(ap,0)then return false end;if ao:GetShowOnTopStaff()and ap.Staff==aq.TopStaff then return true end;if ao:GetShowOnBottomStaff()and ap.Staff==aq:CalcBottomStaff()then return true end;if as.ShowMeasureNumbers then return not ao:GetExcludeOtherStaves(ar)end;return false end;function r.is_default_number_visible_and_left_aligned(ao,ap,at,ar,au)if ao.UseScoreInfoForParts then ar=false end;if au and ao:GetShowOnMultiMeasureRests(ar)then if finale.MNALIGN_LEFT~=ao:GetMultiMeasureAlignment(ar)then return false end elseif ap.Measure==at.FirstMeasure then if not ao:GetShowOnSystemStart()then return false end;if finale.MNALIGN_LEFT~=ao:GetStartAlignment(ar)then return false end else if not ao:GetShowMultiples(ar)then return false end;if finale.MNALIGN_LEFT~=ao:GetMultipleAlignment(ar)then return false end end;return r.is_default_measure_number_visible_on_cell(ao,ap,at,ar)end;function r.update_layout(av,aw)av=av or 1;aw=aw or false;local ax=finale.FCPage()if ax:Load(av)then ax:UpdateLayout(aw)end end;function r.get_current_part()local ay=finale.FCParts()ay:LoadAll()return ay:GetCurrent()end;function r.get_page_format_prefs()local az=r.get_current_part()local aA=finale.FCPageFormatPrefs()local aB=false;if az:IsScore()then aB=aA:LoadScore()else aB=aA:LoadParts()end;return aA,aB end;local aC=function(aD)local aE=finenv.UI():IsOnWindows()local aF=function(aG,aH)if finenv.UI():IsOnWindows()then return aG and os.getenv(aG)or""else return aH and os.getenv(aH)or""end end;local aI=aD and aF("LOCALAPPDATA","HOME")or aF("COMMONPROGRAMFILES")if not aE then aI=aI.."/Library/Application Support"end;aI=aI.."/SMuFL/Fonts/"return aI end;function r.get_smufl_font_list()local aJ={}local aK=function(aD)local aI=aC(aD)local aL=function()if finenv.UI():IsOnWindows()then return io.popen('dir "'..aI..'" /b /ad')else return io.popen('ls "'..aI..'"')end end;local aM=function(aN)local aO=finale.FCString()aO.LuaString=aN;return finenv.UI():IsFontAvailable(aO)end;for aN in aL():lines()do if not aN:find("%.")then aN=aN:gsub(" Bold","")aN=aN:gsub(" Italic","")local aO=finale.FCString()aO.LuaString=aN;if aJ[aN]or aM(aN)then aJ[aN]=aD and"user"or"system"end end end end;aK(true)aK(false)return aJ end;function r.get_smufl_metadata_file(aP)if not aP then aP=finale.FCFontInfo()aP:LoadFontPrefs(finale.FONTPREF_MUSIC)end;local aQ=function(aR,aP)local aS=aR..aP.Name.."/"..aP.Name..".json"return io.open(aS,"r")end;local aT=aQ(aC(true),aP)if aT then return aT end;return aQ(aC(false),aP)end;function r.is_font_smufl_font(aP)if not aP then aP=finale.FCFontInfo()aP:LoadFontPrefs(finale.FONTPREF_MUSIC)end;if finenv.RawFinaleVersion>=r.finale_version(27,1)then if nil~=aP.IsSMuFLFont then return aP.IsSMuFLFont end end;local aU=r.get_smufl_metadata_file(aP)if nil~=aU then io.close(aU)return true end;return false end;function r.simple_input(aV,aW)local aX=finale.FCString()aX.LuaString=""local aY=finale.FCString()local aZ=160;function format_ctrl(a_,b0,b1,b2)a_:SetHeight(b0)a_:SetWidth(b1)aY.LuaString=b2;a_:SetText(aY)end;title_width=string.len(aV)*6+54;if title_width>aZ then aZ=title_width end;text_width=string.len(aW)*6;if text_width>aZ then aZ=text_width end;aY.LuaString=aV;local b3=finale.FCCustomLuaWindow()b3:SetTitle(aY)local b4=b3:CreateStatic(0,0)format_ctrl(b4,16,aZ,aW)local b5=b3:CreateEdit(0,20)format_ctrl(b5,20,aZ,"")b3:CreateOkButton()b3:CreateCancelButton()function callback(a_)end;b3:RegisterHandleCommand(callback)if b3:ExecuteModal(nil)==finale.EXECMODAL_OK then aX.LuaString=b5:GetText(aX)return aX.LuaString end end;function r.is_finale_object(b6)return b6 and type(b6)=="userdata"and b6.ClassName and b6.GetClassID and true or false end;function r.system_indent_set_to_prefs(at,aA)aA=aA or r.get_page_format_prefs()local b7=finale.FCMeasure()local b8=at.FirstMeasure==1;if not b8 and b7:Load(at.FirstMeasure)then if b7.ShowFullNames then b8=true end end;if b8 and aA.UseFirstSystemMargins then at.LeftMargin=aA.FirstSystemLeft else at.LeftMargin=aA.SystemLeft end;return at:Save()end;function r.calc_script_name(b9)local ba=finale.FCString()if finenv.RunningLuaFilePath then ba.LuaString=finenv.RunningLuaFilePath()else ba:SetRunningLuaFilePath()end;local bb=finale.FCString()ba:SplitToPathAndFile(nil,bb)local a9=bb.LuaString;if not b9 then a9=a9:match("(.+)%..+")if not a9 or a9==""then a9=bb.LuaString end end;return a9 end;return r end)return a("__root")