local a,b,c,d=(function(e)local f={[{}]=true}local g;local h={}local require;local i={}g=function(j,k)if not h[j]then h[j]=k end end;require=function(j)local l=i[j]if l then if l==f then return nil end else if not h[j]then if not e then local m=type(j)=='string'and'\"'..j..'\"'or tostring(j)error('Tried to require '..m..', but no such module has been registered')else return e(j)end end;i[j]=f;l=h[j](require,i,g,h)i[j]=l end;return l end;return require,i,g,h end)(require)c("__root",function(require,n,c,d)function plugindef()finaleplugin.RequireSelection=false;finaleplugin.Author="Robert Patterson"finaleplugin.Copyright="CC0 https://creativecommons.org/publicdomain/zero/1.0/"finaleplugin.Version="1.0"finaleplugin.Date="March 8, 2021"finaleplugin.CategoryTags="Multimeasure Rest"return"Widen Multimeasure Rests to Tempo Mark","Widen Multimeasure Rests to Tempo Mark","Widens any multimeasure rest with a tempo mark to be wide enough for the mark."end;local o=require("library.general_library")local p=require("library.configuration")local q=require("library.enigma_string")local r=require("library.expression")local s={additional_padding=0}p.get_parameters("mmrest_widen_to_tempo_mark.config.txt",s)function get_expression_offset(t,u)local v=finale.FCCellMetrics()if not v:LoadAtCell(u)then return 0 end;local w=finale.FCPoint(0,0)if not t:CalcMetricPos(w)then return 0 end;local x=w.X-v.MusicStartPos;v:FreeMetrics()return x end;function mmrest_widen_to_tempo_mark()local y=finale.FCMeasures()local z=o.get_selected_region_or_whole_doc()y:LoadRegion(z)for A in each(y)do local B=finale.FCMultiMeasureRest()if B:Load(A.ItemNo)then local C=finale.FCExpressions()C:LoadAllForItem(A.ItemNo)local D=B.Width;local E=false;local F=B.Width;local G=false;for H in each(C)do if not H:IsShape()then local I=finale.FCTextExpressionDef()if I:Load(H.ID)then if finale.DEFAULTCATID_TEMPOMARKS==I.CategoryID then local J=r.calc_text_width(I,true)+s.additional_padding;if H.Staff<=0 then if J>D then D=J;E=true end else local u=finale.FCCell(A.ItemNo,H.Staff)local J=J+get_expression_offset(H,u)if J>F then G=true;F=J end end end end end end;if G then B.Width=F;B:Save()elseif E then B.Width=D;B:Save()end end end;o.update_layout()end;mmrest_widen_to_tempo_mark()end)c("library.expression",function(require,n,c,d)local o={}function o.finale_version(K,L,M)local x=bit32.bor(bit32.lshift(math.floor(K),24),bit32.lshift(math.floor(L),20))if M then x=bit32.bor(x,math.floor(M))end;return x end;function o.group_overlaps_region(N,O)if O:IsFullDocumentSpan()then return true end;local P=false;local Q=finale.FCSystemStaves()Q:LoadAllForRegion(O)for R in each(Q)do if N:ContainsStaff(R:GetStaff())then P=true;break end end;if not P then return false end;if N.StartMeasure>O.EndMeasure or N.EndMeasure<O.StartMeasure then return false end;return true end;function o.group_is_contained_in_region(N,O)if not O:IsStaffIncluded(N.StartStaff)then return false end;if not O:IsStaffIncluded(N.EndStaff)then return false end;return true end;function o.staff_group_is_multistaff_instrument(N)local S=finale.FCMultiStaffInstruments()S:LoadAll()for T in each(S)do if T:ContainsStaff(N.StartStaff)and T.GroupID==N:GetItemID()then return true end end;return false end;function o.get_selected_region_or_whole_doc()local z=finenv.Region()if z:IsEmpty()then z:SetFullDocument()end;return z end;function o.get_first_cell_on_or_after_page(U)local V=U;local W=finale.FCPage()local X=false;while W:Load(V)do if W:GetFirstSystem()>0 then X=true;break end;V=V+1 end;if X then local Y=finale.FCStaffSystem()Y:Load(W:GetFirstSystem())return finale.FCCell(Y.FirstMeasure,Y.TopStaff)end;local Z=finale.FCMusicRegion()Z:SetFullDocument()return finale.FCCell(Z.EndMeasure,Z.EndStaff)end;function o.get_top_left_visible_cell()if not finenv.UI():IsPageView()then local _=finale.FCMusicRegion()_:SetFullDocument()return finale.FCCell(finenv.UI():GetCurrentMeasure(),_.StartStaff)end;return o.get_first_cell_on_or_after_page(finenv.UI():GetCurrentPage())end;function o.get_top_left_selected_or_visible_cell()local z=finenv.Region()if not z:IsEmpty()then return finale.FCCell(z.StartMeasure,z.StartStaff)end;return o.get_top_left_visible_cell()end;function o.is_default_measure_number_visible_on_cell(a0,u,a1,a2)local a3=finale.FCCurrentStaffSpec()if not a3:LoadForCell(u,0)then return false end;if a0:GetShowOnTopStaff()and u.Staff==a1.TopStaff then return true end;if a0:GetShowOnBottomStaff()and u.Staff==a1:CalcBottomStaff()then return true end;if a3.ShowMeasureNumbers then return not a0:GetExcludeOtherStaves(a2)end;return false end;function o.is_default_number_visible_and_left_aligned(a0,u,a4,a2,a5)if a0.UseScoreInfoForParts then a2=false end;if a5 and a0:GetShowOnMultiMeasureRests(a2)then if finale.MNALIGN_LEFT~=a0:GetMultiMeasureAlignment(a2)then return false end elseif u.Measure==a4.FirstMeasure then if not a0:GetShowOnSystemStart()then return false end;if finale.MNALIGN_LEFT~=a0:GetStartAlignment(a2)then return false end else if not a0:GetShowMultiples(a2)then return false end;if finale.MNALIGN_LEFT~=a0:GetMultipleAlignment(a2)then return false end end;return o.is_default_measure_number_visible_on_cell(a0,u,a4,a2)end;function o.update_layout(a6,a7)a6=a6 or 1;a7=a7 or false;local a8=finale.FCPage()if a8:Load(a6)then a8:UpdateLayout(a7)end end;function o.get_current_part()local a9=finale.FCParts()a9:LoadAll()return a9:GetCurrent()end;function o.get_page_format_prefs()local aa=o.get_current_part()local ab=finale.FCPageFormatPrefs()local ac=false;if aa:IsScore()then ac=ab:LoadScore()else ac=ab:LoadParts()end;return ab,ac end;local ad=function(ae)local af=finenv.UI():IsOnWindows()local ag=function(ah,ai)if finenv.UI():IsOnWindows()then return ah and os.getenv(ah)or""else return ai and os.getenv(ai)or""end end;local aj=ae and ag("LOCALAPPDATA","HOME")or ag("COMMONPROGRAMFILES")if not af then aj=aj.."/Library/Application Support"end;aj=aj.."/SMuFL/Fonts/"return aj end;function o.get_smufl_font_list()local ak={}local al=function(ae)local aj=ad(ae)local am=function()if finenv.UI():IsOnWindows()then return io.popen('dir "'..aj..'" /b /ad')else return io.popen('ls "'..aj..'"')end end;local an=function(ao)local ap=finale.FCString()ap.LuaString=ao;return finenv.UI():IsFontAvailable(ap)end;for ao in am():lines()do if not ao:find("%.")then ao=ao:gsub(" Bold","")ao=ao:gsub(" Italic","")local ap=finale.FCString()ap.LuaString=ao;if ak[ao]or an(ao)then ak[ao]=ae and"user"or"system"end end end end;al(true)al(false)return ak end;function o.get_smufl_metadata_file(aq)if not aq then aq=finale.FCFontInfo()aq:LoadFontPrefs(finale.FONTPREF_MUSIC)end;local ar=function(as,aq)local at=as..aq.Name.."/"..aq.Name..".json"return io.open(at,"r")end;local au=ar(ad(true),aq)if au then return au end;return ar(ad(false),aq)end;function o.is_font_smufl_font(aq)if not aq then aq=finale.FCFontInfo()aq:LoadFontPrefs(finale.FONTPREF_MUSIC)end;if finenv.RawFinaleVersion>=o.finale_version(27,1)then if nil~=aq.IsSMuFLFont then return aq.IsSMuFLFont end end;local av=o.get_smufl_metadata_file(aq)if nil~=av then io.close(av)return true end;return false end;function o.simple_input(aw,ax)local ay=finale.FCString()ay.LuaString=""local az=finale.FCString()local aA=160;function format_ctrl(aB,aC,aD,aE)aB:SetHeight(aC)aB:SetWidth(aD)az.LuaString=aE;aB:SetText(az)end;title_width=string.len(aw)*6+54;if title_width>aA then aA=title_width end;text_width=string.len(ax)*6;if text_width>aA then aA=text_width end;az.LuaString=aw;local aF=finale.FCCustomLuaWindow()aF:SetTitle(az)local aG=aF:CreateStatic(0,0)format_ctrl(aG,16,aA,ax)local aH=aF:CreateEdit(0,20)format_ctrl(aH,20,aA,"")aF:CreateOkButton()aF:CreateCancelButton()function callback(aB)end;aF:RegisterHandleCommand(callback)if aF:ExecuteModal(nil)==finale.EXECMODAL_OK then ay.LuaString=aH:GetText(ay)return ay.LuaString end end;function o.is_finale_object(aI)return aI and type(aI)=="userdata"and aI.ClassName and aI.GetClassID and true or false end;function o.system_indent_set_to_prefs(a4,ab)ab=ab or o.get_page_format_prefs()local aJ=finale.FCMeasure()local aK=a4.FirstMeasure==1;if not aK and aJ:Load(a4.FirstMeasure)then if aJ.ShowFullNames then aK=true end end;if aK and ab.UseFirstSystemMargins then a4.LeftMargin=ab.FirstSystemLeft else a4.LeftMargin=ab.SystemLeft end;return a4:Save()end;function o.calc_script_name(aL)local aM=finale.FCString()if finenv.RunningLuaFilePath then aM.LuaString=finenv.RunningLuaFilePath()else aM:SetRunningLuaFilePath()end;local aN=finale.FCString()aM:SplitToPathAndFile(nil,aN)local x=aN.LuaString;if not aL then x=x:match("(.+)%..+")if not x or x==""then x=aN.LuaString end end;return x end;return o end)c("library.enigma_string",function(require,n,c,d)local o={}function o.finale_version(K,L,M)local x=bit32.bor(bit32.lshift(math.floor(K),24),bit32.lshift(math.floor(L),20))if M then x=bit32.bor(x,math.floor(M))end;return x end;function o.group_overlaps_region(N,O)if O:IsFullDocumentSpan()then return true end;local P=false;local Q=finale.FCSystemStaves()Q:LoadAllForRegion(O)for R in each(Q)do if N:ContainsStaff(R:GetStaff())then P=true;break end end;if not P then return false end;if N.StartMeasure>O.EndMeasure or N.EndMeasure<O.StartMeasure then return false end;return true end;function o.group_is_contained_in_region(N,O)if not O:IsStaffIncluded(N.StartStaff)then return false end;if not O:IsStaffIncluded(N.EndStaff)then return false end;return true end;function o.staff_group_is_multistaff_instrument(N)local S=finale.FCMultiStaffInstruments()S:LoadAll()for T in each(S)do if T:ContainsStaff(N.StartStaff)and T.GroupID==N:GetItemID()then return true end end;return false end;function o.get_selected_region_or_whole_doc()local z=finenv.Region()if z:IsEmpty()then z:SetFullDocument()end;return z end;function o.get_first_cell_on_or_after_page(U)local V=U;local W=finale.FCPage()local X=false;while W:Load(V)do if W:GetFirstSystem()>0 then X=true;break end;V=V+1 end;if X then local Y=finale.FCStaffSystem()Y:Load(W:GetFirstSystem())return finale.FCCell(Y.FirstMeasure,Y.TopStaff)end;local Z=finale.FCMusicRegion()Z:SetFullDocument()return finale.FCCell(Z.EndMeasure,Z.EndStaff)end;function o.get_top_left_visible_cell()if not finenv.UI():IsPageView()then local _=finale.FCMusicRegion()_:SetFullDocument()return finale.FCCell(finenv.UI():GetCurrentMeasure(),_.StartStaff)end;return o.get_first_cell_on_or_after_page(finenv.UI():GetCurrentPage())end;function o.get_top_left_selected_or_visible_cell()local z=finenv.Region()if not z:IsEmpty()then return finale.FCCell(z.StartMeasure,z.StartStaff)end;return o.get_top_left_visible_cell()end;function o.is_default_measure_number_visible_on_cell(a0,u,a1,a2)local a3=finale.FCCurrentStaffSpec()if not a3:LoadForCell(u,0)then return false end;if a0:GetShowOnTopStaff()and u.Staff==a1.TopStaff then return true end;if a0:GetShowOnBottomStaff()and u.Staff==a1:CalcBottomStaff()then return true end;if a3.ShowMeasureNumbers then return not a0:GetExcludeOtherStaves(a2)end;return false end;function o.is_default_number_visible_and_left_aligned(a0,u,a4,a2,a5)if a0.UseScoreInfoForParts then a2=false end;if a5 and a0:GetShowOnMultiMeasureRests(a2)then if finale.MNALIGN_LEFT~=a0:GetMultiMeasureAlignment(a2)then return false end elseif u.Measure==a4.FirstMeasure then if not a0:GetShowOnSystemStart()then return false end;if finale.MNALIGN_LEFT~=a0:GetStartAlignment(a2)then return false end else if not a0:GetShowMultiples(a2)then return false end;if finale.MNALIGN_LEFT~=a0:GetMultipleAlignment(a2)then return false end end;return o.is_default_measure_number_visible_on_cell(a0,u,a4,a2)end;function o.update_layout(a6,a7)a6=a6 or 1;a7=a7 or false;local a8=finale.FCPage()if a8:Load(a6)then a8:UpdateLayout(a7)end end;function o.get_current_part()local a9=finale.FCParts()a9:LoadAll()return a9:GetCurrent()end;function o.get_page_format_prefs()local aa=o.get_current_part()local ab=finale.FCPageFormatPrefs()local ac=false;if aa:IsScore()then ac=ab:LoadScore()else ac=ab:LoadParts()end;return ab,ac end;local ad=function(ae)local af=finenv.UI():IsOnWindows()local ag=function(ah,ai)if finenv.UI():IsOnWindows()then return ah and os.getenv(ah)or""else return ai and os.getenv(ai)or""end end;local aj=ae and ag("LOCALAPPDATA","HOME")or ag("COMMONPROGRAMFILES")if not af then aj=aj.."/Library/Application Support"end;aj=aj.."/SMuFL/Fonts/"return aj end;function o.get_smufl_font_list()local ak={}local al=function(ae)local aj=ad(ae)local am=function()if finenv.UI():IsOnWindows()then return io.popen('dir "'..aj..'" /b /ad')else return io.popen('ls "'..aj..'"')end end;local an=function(ao)local ap=finale.FCString()ap.LuaString=ao;return finenv.UI():IsFontAvailable(ap)end;for ao in am():lines()do if not ao:find("%.")then ao=ao:gsub(" Bold","")ao=ao:gsub(" Italic","")local ap=finale.FCString()ap.LuaString=ao;if ak[ao]or an(ao)then ak[ao]=ae and"user"or"system"end end end end;al(true)al(false)return ak end;function o.get_smufl_metadata_file(aq)if not aq then aq=finale.FCFontInfo()aq:LoadFontPrefs(finale.FONTPREF_MUSIC)end;local ar=function(as,aq)local at=as..aq.Name.."/"..aq.Name..".json"return io.open(at,"r")end;local au=ar(ad(true),aq)if au then return au end;return ar(ad(false),aq)end;function o.is_font_smufl_font(aq)if not aq then aq=finale.FCFontInfo()aq:LoadFontPrefs(finale.FONTPREF_MUSIC)end;if finenv.RawFinaleVersion>=o.finale_version(27,1)then if nil~=aq.IsSMuFLFont then return aq.IsSMuFLFont end end;local av=o.get_smufl_metadata_file(aq)if nil~=av then io.close(av)return true end;return false end;function o.simple_input(aw,ax)local ay=finale.FCString()ay.LuaString=""local az=finale.FCString()local aA=160;function format_ctrl(aB,aC,aD,aE)aB:SetHeight(aC)aB:SetWidth(aD)az.LuaString=aE;aB:SetText(az)end;title_width=string.len(aw)*6+54;if title_width>aA then aA=title_width end;text_width=string.len(ax)*6;if text_width>aA then aA=text_width end;az.LuaString=aw;local aF=finale.FCCustomLuaWindow()aF:SetTitle(az)local aG=aF:CreateStatic(0,0)format_ctrl(aG,16,aA,ax)local aH=aF:CreateEdit(0,20)format_ctrl(aH,20,aA,"")aF:CreateOkButton()aF:CreateCancelButton()function callback(aB)end;aF:RegisterHandleCommand(callback)if aF:ExecuteModal(nil)==finale.EXECMODAL_OK then ay.LuaString=aH:GetText(ay)return ay.LuaString end end;function o.is_finale_object(aI)return aI and type(aI)=="userdata"and aI.ClassName and aI.GetClassID and true or false end;function o.system_indent_set_to_prefs(a4,ab)ab=ab or o.get_page_format_prefs()local aJ=finale.FCMeasure()local aK=a4.FirstMeasure==1;if not aK and aJ:Load(a4.FirstMeasure)then if aJ.ShowFullNames then aK=true end end;if aK and ab.UseFirstSystemMargins then a4.LeftMargin=ab.FirstSystemLeft else a4.LeftMargin=ab.SystemLeft end;return a4:Save()end;function o.calc_script_name(aL)local aM=finale.FCString()if finenv.RunningLuaFilePath then aM.LuaString=finenv.RunningLuaFilePath()else aM:SetRunningLuaFilePath()end;local aN=finale.FCString()aM:SplitToPathAndFile(nil,aN)local x=aN.LuaString;if not aL then x=x:match("(.+)%..+")if not x or x==""then x=aN.LuaString end end;return x end;return o end)c("library.configuration",function(require,n,c,d)local o={}function o.finale_version(K,L,M)local x=bit32.bor(bit32.lshift(math.floor(K),24),bit32.lshift(math.floor(L),20))if M then x=bit32.bor(x,math.floor(M))end;return x end;function o.group_overlaps_region(N,O)if O:IsFullDocumentSpan()then return true end;local P=false;local Q=finale.FCSystemStaves()Q:LoadAllForRegion(O)for R in each(Q)do if N:ContainsStaff(R:GetStaff())then P=true;break end end;if not P then return false end;if N.StartMeasure>O.EndMeasure or N.EndMeasure<O.StartMeasure then return false end;return true end;function o.group_is_contained_in_region(N,O)if not O:IsStaffIncluded(N.StartStaff)then return false end;if not O:IsStaffIncluded(N.EndStaff)then return false end;return true end;function o.staff_group_is_multistaff_instrument(N)local S=finale.FCMultiStaffInstruments()S:LoadAll()for T in each(S)do if T:ContainsStaff(N.StartStaff)and T.GroupID==N:GetItemID()then return true end end;return false end;function o.get_selected_region_or_whole_doc()local z=finenv.Region()if z:IsEmpty()then z:SetFullDocument()end;return z end;function o.get_first_cell_on_or_after_page(U)local V=U;local W=finale.FCPage()local X=false;while W:Load(V)do if W:GetFirstSystem()>0 then X=true;break end;V=V+1 end;if X then local Y=finale.FCStaffSystem()Y:Load(W:GetFirstSystem())return finale.FCCell(Y.FirstMeasure,Y.TopStaff)end;local Z=finale.FCMusicRegion()Z:SetFullDocument()return finale.FCCell(Z.EndMeasure,Z.EndStaff)end;function o.get_top_left_visible_cell()if not finenv.UI():IsPageView()then local _=finale.FCMusicRegion()_:SetFullDocument()return finale.FCCell(finenv.UI():GetCurrentMeasure(),_.StartStaff)end;return o.get_first_cell_on_or_after_page(finenv.UI():GetCurrentPage())end;function o.get_top_left_selected_or_visible_cell()local z=finenv.Region()if not z:IsEmpty()then return finale.FCCell(z.StartMeasure,z.StartStaff)end;return o.get_top_left_visible_cell()end;function o.is_default_measure_number_visible_on_cell(a0,u,a1,a2)local a3=finale.FCCurrentStaffSpec()if not a3:LoadForCell(u,0)then return false end;if a0:GetShowOnTopStaff()and u.Staff==a1.TopStaff then return true end;if a0:GetShowOnBottomStaff()and u.Staff==a1:CalcBottomStaff()then return true end;if a3.ShowMeasureNumbers then return not a0:GetExcludeOtherStaves(a2)end;return false end;function o.is_default_number_visible_and_left_aligned(a0,u,a4,a2,a5)if a0.UseScoreInfoForParts then a2=false end;if a5 and a0:GetShowOnMultiMeasureRests(a2)then if finale.MNALIGN_LEFT~=a0:GetMultiMeasureAlignment(a2)then return false end elseif u.Measure==a4.FirstMeasure then if not a0:GetShowOnSystemStart()then return false end;if finale.MNALIGN_LEFT~=a0:GetStartAlignment(a2)then return false end else if not a0:GetShowMultiples(a2)then return false end;if finale.MNALIGN_LEFT~=a0:GetMultipleAlignment(a2)then return false end end;return o.is_default_measure_number_visible_on_cell(a0,u,a4,a2)end;function o.update_layout(a6,a7)a6=a6 or 1;a7=a7 or false;local a8=finale.FCPage()if a8:Load(a6)then a8:UpdateLayout(a7)end end;function o.get_current_part()local a9=finale.FCParts()a9:LoadAll()return a9:GetCurrent()end;function o.get_page_format_prefs()local aa=o.get_current_part()local ab=finale.FCPageFormatPrefs()local ac=false;if aa:IsScore()then ac=ab:LoadScore()else ac=ab:LoadParts()end;return ab,ac end;local ad=function(ae)local af=finenv.UI():IsOnWindows()local ag=function(ah,ai)if finenv.UI():IsOnWindows()then return ah and os.getenv(ah)or""else return ai and os.getenv(ai)or""end end;local aj=ae and ag("LOCALAPPDATA","HOME")or ag("COMMONPROGRAMFILES")if not af then aj=aj.."/Library/Application Support"end;aj=aj.."/SMuFL/Fonts/"return aj end;function o.get_smufl_font_list()local ak={}local al=function(ae)local aj=ad(ae)local am=function()if finenv.UI():IsOnWindows()then return io.popen('dir "'..aj..'" /b /ad')else return io.popen('ls "'..aj..'"')end end;local an=function(ao)local ap=finale.FCString()ap.LuaString=ao;return finenv.UI():IsFontAvailable(ap)end;for ao in am():lines()do if not ao:find("%.")then ao=ao:gsub(" Bold","")ao=ao:gsub(" Italic","")local ap=finale.FCString()ap.LuaString=ao;if ak[ao]or an(ao)then ak[ao]=ae and"user"or"system"end end end end;al(true)al(false)return ak end;function o.get_smufl_metadata_file(aq)if not aq then aq=finale.FCFontInfo()aq:LoadFontPrefs(finale.FONTPREF_MUSIC)end;local ar=function(as,aq)local at=as..aq.Name.."/"..aq.Name..".json"return io.open(at,"r")end;local au=ar(ad(true),aq)if au then return au end;return ar(ad(false),aq)end;function o.is_font_smufl_font(aq)if not aq then aq=finale.FCFontInfo()aq:LoadFontPrefs(finale.FONTPREF_MUSIC)end;if finenv.RawFinaleVersion>=o.finale_version(27,1)then if nil~=aq.IsSMuFLFont then return aq.IsSMuFLFont end end;local av=o.get_smufl_metadata_file(aq)if nil~=av then io.close(av)return true end;return false end;function o.simple_input(aw,ax)local ay=finale.FCString()ay.LuaString=""local az=finale.FCString()local aA=160;function format_ctrl(aB,aC,aD,aE)aB:SetHeight(aC)aB:SetWidth(aD)az.LuaString=aE;aB:SetText(az)end;title_width=string.len(aw)*6+54;if title_width>aA then aA=title_width end;text_width=string.len(ax)*6;if text_width>aA then aA=text_width end;az.LuaString=aw;local aF=finale.FCCustomLuaWindow()aF:SetTitle(az)local aG=aF:CreateStatic(0,0)format_ctrl(aG,16,aA,ax)local aH=aF:CreateEdit(0,20)format_ctrl(aH,20,aA,"")aF:CreateOkButton()aF:CreateCancelButton()function callback(aB)end;aF:RegisterHandleCommand(callback)if aF:ExecuteModal(nil)==finale.EXECMODAL_OK then ay.LuaString=aH:GetText(ay)return ay.LuaString end end;function o.is_finale_object(aI)return aI and type(aI)=="userdata"and aI.ClassName and aI.GetClassID and true or false end;function o.system_indent_set_to_prefs(a4,ab)ab=ab or o.get_page_format_prefs()local aJ=finale.FCMeasure()local aK=a4.FirstMeasure==1;if not aK and aJ:Load(a4.FirstMeasure)then if aJ.ShowFullNames then aK=true end end;if aK and ab.UseFirstSystemMargins then a4.LeftMargin=ab.FirstSystemLeft else a4.LeftMargin=ab.SystemLeft end;return a4:Save()end;function o.calc_script_name(aL)local aM=finale.FCString()if finenv.RunningLuaFilePath then aM.LuaString=finenv.RunningLuaFilePath()else aM:SetRunningLuaFilePath()end;local aN=finale.FCString()aM:SplitToPathAndFile(nil,aN)local x=aN.LuaString;if not aL then x=x:match("(.+)%..+")if not x or x==""then x=aN.LuaString end end;return x end;return o end)c("library.general_library",function(require,n,c,d)local o={}function o.finale_version(K,L,M)local x=bit32.bor(bit32.lshift(math.floor(K),24),bit32.lshift(math.floor(L),20))if M then x=bit32.bor(x,math.floor(M))end;return x end;function o.group_overlaps_region(N,O)if O:IsFullDocumentSpan()then return true end;local P=false;local Q=finale.FCSystemStaves()Q:LoadAllForRegion(O)for R in each(Q)do if N:ContainsStaff(R:GetStaff())then P=true;break end end;if not P then return false end;if N.StartMeasure>O.EndMeasure or N.EndMeasure<O.StartMeasure then return false end;return true end;function o.group_is_contained_in_region(N,O)if not O:IsStaffIncluded(N.StartStaff)then return false end;if not O:IsStaffIncluded(N.EndStaff)then return false end;return true end;function o.staff_group_is_multistaff_instrument(N)local S=finale.FCMultiStaffInstruments()S:LoadAll()for T in each(S)do if T:ContainsStaff(N.StartStaff)and T.GroupID==N:GetItemID()then return true end end;return false end;function o.get_selected_region_or_whole_doc()local z=finenv.Region()if z:IsEmpty()then z:SetFullDocument()end;return z end;function o.get_first_cell_on_or_after_page(U)local V=U;local W=finale.FCPage()local X=false;while W:Load(V)do if W:GetFirstSystem()>0 then X=true;break end;V=V+1 end;if X then local Y=finale.FCStaffSystem()Y:Load(W:GetFirstSystem())return finale.FCCell(Y.FirstMeasure,Y.TopStaff)end;local Z=finale.FCMusicRegion()Z:SetFullDocument()return finale.FCCell(Z.EndMeasure,Z.EndStaff)end;function o.get_top_left_visible_cell()if not finenv.UI():IsPageView()then local _=finale.FCMusicRegion()_:SetFullDocument()return finale.FCCell(finenv.UI():GetCurrentMeasure(),_.StartStaff)end;return o.get_first_cell_on_or_after_page(finenv.UI():GetCurrentPage())end;function o.get_top_left_selected_or_visible_cell()local z=finenv.Region()if not z:IsEmpty()then return finale.FCCell(z.StartMeasure,z.StartStaff)end;return o.get_top_left_visible_cell()end;function o.is_default_measure_number_visible_on_cell(a0,u,a1,a2)local a3=finale.FCCurrentStaffSpec()if not a3:LoadForCell(u,0)then return false end;if a0:GetShowOnTopStaff()and u.Staff==a1.TopStaff then return true end;if a0:GetShowOnBottomStaff()and u.Staff==a1:CalcBottomStaff()then return true end;if a3.ShowMeasureNumbers then return not a0:GetExcludeOtherStaves(a2)end;return false end;function o.is_default_number_visible_and_left_aligned(a0,u,a4,a2,a5)if a0.UseScoreInfoForParts then a2=false end;if a5 and a0:GetShowOnMultiMeasureRests(a2)then if finale.MNALIGN_LEFT~=a0:GetMultiMeasureAlignment(a2)then return false end elseif u.Measure==a4.FirstMeasure then if not a0:GetShowOnSystemStart()then return false end;if finale.MNALIGN_LEFT~=a0:GetStartAlignment(a2)then return false end else if not a0:GetShowMultiples(a2)then return false end;if finale.MNALIGN_LEFT~=a0:GetMultipleAlignment(a2)then return false end end;return o.is_default_measure_number_visible_on_cell(a0,u,a4,a2)end;function o.update_layout(a6,a7)a6=a6 or 1;a7=a7 or false;local a8=finale.FCPage()if a8:Load(a6)then a8:UpdateLayout(a7)end end;function o.get_current_part()local a9=finale.FCParts()a9:LoadAll()return a9:GetCurrent()end;function o.get_page_format_prefs()local aa=o.get_current_part()local ab=finale.FCPageFormatPrefs()local ac=false;if aa:IsScore()then ac=ab:LoadScore()else ac=ab:LoadParts()end;return ab,ac end;local ad=function(ae)local af=finenv.UI():IsOnWindows()local ag=function(ah,ai)if finenv.UI():IsOnWindows()then return ah and os.getenv(ah)or""else return ai and os.getenv(ai)or""end end;local aj=ae and ag("LOCALAPPDATA","HOME")or ag("COMMONPROGRAMFILES")if not af then aj=aj.."/Library/Application Support"end;aj=aj.."/SMuFL/Fonts/"return aj end;function o.get_smufl_font_list()local ak={}local al=function(ae)local aj=ad(ae)local am=function()if finenv.UI():IsOnWindows()then return io.popen('dir "'..aj..'" /b /ad')else return io.popen('ls "'..aj..'"')end end;local an=function(ao)local ap=finale.FCString()ap.LuaString=ao;return finenv.UI():IsFontAvailable(ap)end;for ao in am():lines()do if not ao:find("%.")then ao=ao:gsub(" Bold","")ao=ao:gsub(" Italic","")local ap=finale.FCString()ap.LuaString=ao;if ak[ao]or an(ao)then ak[ao]=ae and"user"or"system"end end end end;al(true)al(false)return ak end;function o.get_smufl_metadata_file(aq)if not aq then aq=finale.FCFontInfo()aq:LoadFontPrefs(finale.FONTPREF_MUSIC)end;local ar=function(as,aq)local at=as..aq.Name.."/"..aq.Name..".json"return io.open(at,"r")end;local au=ar(ad(true),aq)if au then return au end;return ar(ad(false),aq)end;function o.is_font_smufl_font(aq)if not aq then aq=finale.FCFontInfo()aq:LoadFontPrefs(finale.FONTPREF_MUSIC)end;if finenv.RawFinaleVersion>=o.finale_version(27,1)then if nil~=aq.IsSMuFLFont then return aq.IsSMuFLFont end end;local av=o.get_smufl_metadata_file(aq)if nil~=av then io.close(av)return true end;return false end;function o.simple_input(aw,ax)local ay=finale.FCString()ay.LuaString=""local az=finale.FCString()local aA=160;function format_ctrl(aB,aC,aD,aE)aB:SetHeight(aC)aB:SetWidth(aD)az.LuaString=aE;aB:SetText(az)end;title_width=string.len(aw)*6+54;if title_width>aA then aA=title_width end;text_width=string.len(ax)*6;if text_width>aA then aA=text_width end;az.LuaString=aw;local aF=finale.FCCustomLuaWindow()aF:SetTitle(az)local aG=aF:CreateStatic(0,0)format_ctrl(aG,16,aA,ax)local aH=aF:CreateEdit(0,20)format_ctrl(aH,20,aA,"")aF:CreateOkButton()aF:CreateCancelButton()function callback(aB)end;aF:RegisterHandleCommand(callback)if aF:ExecuteModal(nil)==finale.EXECMODAL_OK then ay.LuaString=aH:GetText(ay)return ay.LuaString end end;function o.is_finale_object(aI)return aI and type(aI)=="userdata"and aI.ClassName and aI.GetClassID and true or false end;function o.system_indent_set_to_prefs(a4,ab)ab=ab or o.get_page_format_prefs()local aJ=finale.FCMeasure()local aK=a4.FirstMeasure==1;if not aK and aJ:Load(a4.FirstMeasure)then if aJ.ShowFullNames then aK=true end end;if aK and ab.UseFirstSystemMargins then a4.LeftMargin=ab.FirstSystemLeft else a4.LeftMargin=ab.SystemLeft end;return a4:Save()end;function o.calc_script_name(aL)local aM=finale.FCString()if finenv.RunningLuaFilePath then aM.LuaString=finenv.RunningLuaFilePath()else aM:SetRunningLuaFilePath()end;local aN=finale.FCString()aM:SplitToPathAndFile(nil,aN)local x=aN.LuaString;if not aL then x=x:match("(.+)%..+")if not x or x==""then x=aN.LuaString end end;return x end;return o end)return a("__root")