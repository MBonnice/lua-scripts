function plugindef()finaleplugin.RequireSelection=true;finaleplugin.Author="Carl Vine"finaleplugin.AuthorURL="http://carlvine.com"finaleplugin.Copyright="CC0 https://creativecommons.org/publicdomain/zero/1.0/"finaleplugin.Version="v1.46"finaleplugin.Date="2022/05/16"finaleplugin.Notes=[[
        Chords on layer 1 in the selected region are split into independent layers on the same staff. 
        Multiple measures and staves can be selected at once. 
        More than four notes in a chord are deposited on layer 4. 
        As a special case, if a staff contains only single-note entries, they are duplicated to layer 2. 
        Markings on the original are not copied to other layers.
    ]]return"Staff Explode To Layers","Staff Explode To Layers","Staff Explode Chords into independent layers"end;function get_note_count(a)local b=0;for c in eachentry(a)do if c.Count>b then b=c.Count end end;return b end;function explode_one_slot(d)local a=finenv.Region()a.StartSlot=d;a.EndSlot=d;local e=get_note_count(a)if e==0 then return end;local f=a.StartMeasure;local g=a.EndMeasure;local h=a:CalcStaffNumber(d)local i=e==1 and 1 or 0;local j={}j[1]=finale.FCNoteEntryLayer(0,h,f,g)j[1]:Load()for k=2,e+i do j[k]=j[1]:CreateCloneEntries(k-1,h,f)j[k]:Save()j[k]:CloneTuplets(j[1])j[k]:Save()end;if i>0 then return end;for c in eachentrysaved(a)do if c:IsNote()then local l=c.LayerNumber;local m=l-1;local n=c.Count-l;if m>0 then for k=1,m do c:DeleteNote(c:CalcHighestNote(nil))end end;if n>0 and l<4 then for k=1,n do c:DeleteNote(c:CalcLowestNote(nil))end end end end end;function staff_layer_explode()local a=finenv.Region()local e=get_note_count(a)if e==0 then finenv.UI():AlertNeutral("","Please select a region\nwith some notes in it!")return end;for d=a.StartSlot,a.EndSlot do explode_one_slot(d)end end;staff_layer_explode()