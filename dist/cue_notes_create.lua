local a,b,c,d=(function(e)local f={[{}]=true}local g;local h={}local require;local i={}g=function(j,k)if not h[j]then h[j]=k end end;require=function(j)local l=i[j]if l then if l==f then return nil end else if not h[j]then if not e then local m=type(j)=='string'and'\"'..j..'\"'or tostring(j)error('Tried to require '..m..', but no such module has been registered')else return e(j)end end;i[j]=f;l=h[j](require,i,g,h)i[j]=l end;return l end;return require,i,g,h end)(require)c("__root",function(require,n,c,d)function plugindef()finaleplugin.RequireSelection=true;finaleplugin.Author="Carl Vine"finaleplugin.AuthorURL="http://carlvine.com"finaleplugin.Copyright="CC0 https://creativecommons.org/publicdomain/zero/1.0/"finaleplugin.Version="v0.63"finaleplugin.Date="2022/05/22"finaleplugin.Notes=[[
This script is keyboard-centric requiring minimal mouse action. It takes music in Layer 1 from one staff in the selected region and creates a "Cue" version on another chosen staff. The cue copy is reduced in size and muted, and can duplicate chosen markings from the original. It is shifted to the chosen layer with a (real) whole-note rest placed in layer 1.

Your preferences are saved after each script run in a "config" file inside a folder called "script_settings" in the same file location as this script. If your choices aren't being saved then you need to create that folder. If that still doesn't work you need to use another folder for your Lua scripts that has fewer access restrictions. 

If using RGPLua (v0.58 or later) the script automatically creates a new expression category called "Cue Names" if it does not exist. If using JWLua, before running the script you must create an Expression Category called "Cue Names" containing at least one text expression.

    ]]return"Cue Notes Create","Cue Notes Create","Copy as cue notes to another staff"end;local o=require("library.configuration")local p=require("library.clef")local q=require("library.layer")local r={copy_articulations=false,copy_expressions=false,copy_smartshapes=false,copy_slurs=true,copy_clef=false,mute_cuenotes=true,cuenote_percent=70,cuenote_layer=3,freeze_up_down=0,cue_category_name="Cue Names",cue_font_smaller=1,prefs_folder="script_settings",prefs_file="cue_notes_create.config"}o.get_parameters(r.prefs_file,r)function save_config_file()local s=finenv:RunningLuaFolderPath()..r.prefs_folder;local t=s..'/'..r.prefs_file;local u=io.open(t,"w")if nil==u then os.execute('mkdir "'..s..'"')u=io.open(t,"w")if nil==u then return end end;for v,w in pairs(r)do if type(w)=="boolean"then w=w and"true"or"false"elseif type(w)=="string"then w='"'..w..'"'end;u:write(v," = ",w,"\n")end;u:close()end;function show_error(x)local y={only_one_staff="Please select just one staff\n as the source for the new cue",empty_region="Please select a region\nwith some notes in it!",first_make_expression_category="You must first create a new Text Expression Category called \""..r.cue_category_name.."\" containing at least one entry"}finenv.UI():AlertNeutral("script: "..plugindef(),y[x])return-1 end;function should_overwrite_existing_music()local z=finenv.UI():AlertOkCancel("script: "..plugindef(),"Overwrite existing music?")local A=z==0;return A end;function region_is_empty(B)for C in eachentry(B)do if C.Count>0 then return false end end;return true end;function new_cue_name(D)local E=finale.FCCustomWindow()local F=finale.FCString()F.LuaString=plugindef()E:SetTitle(F)F.LuaString="New cue name:"E:CreateStatic(0,20):SetText(F)local G=E:CreateEdit(0,40)G:SetWidth(200)local H=finale.FCStaff()H:Load(D)G:SetText(H:CreateDisplayFullNameString())E:CreateOkButton()E:CreateCancelButton()local I=E:ExecuteModal(nil)==finale.EXECMODAL_OK;G:GetText(F)return I,F.LuaString end;function choose_name_index(J)local E=finale.FCCustomWindow()local F=finale.FCString()F.LuaString=plugindef()E:SetTitle(F)F.LuaString="Select cue name:"E:CreateStatic(0,20):SetText(F)local K=E:CreateListBox(0,40)K:SetWidth(200)F.LuaString="*** new name ***"K:AddString(F)for v,w in ipairs(J)do F.LuaString=w[1]K:AddString(F)end;E:CreateOkButton()E:CreateCancelButton()return E:ExecuteModal(nil)==finale.EXECMODAL_OK,K:GetSelectedItem()end;function create_new_expression(L,M)local N=finale.FCCategoryDef()N:Load(M)local O=N:CreateTextFontInfo()local F=finale.FCString()F.LuaString="^fontTxt"..O:CreateEnigmaString(finale.FCString()).LuaString..L;local P=finale.FCTextExpressionDef()P:SaveNewTextBlock(F)P:AssignToCategory(N)P:SetUseCategoryPos(true)P:SetUseCategoryFont(true)P:SaveNew()return P:GetItemNo()end;function choose_destination_staff(D)local K={}local Q=finenv.Region()local R=Q.StartSlot;Q:SetFullMeasureStack()local H=finale.FCStaff()for S=Q.StartSlot,Q.EndSlot do local T=Q:CalcStaffNumber(S)if T~=D then H:Load(T)table.insert(K,{T,H:CreateDisplayFullNameString().LuaString})end end;Q.StartSlot=R;Q.EndSlot=R;local U={210,310,360}local V=20;local W=finenv.UI():IsOnMac()and 3 or 0;local X={"copy_articulations","copy_expressions","copy_smartshapes","copy_slurs","copy_clef","mute_cuenotes","cuenote_percent","cuenote_layer","freeze_up_down"}local Y=6;local Z={}local F=finale.FCString()local E=finale.FCCustomLuaWindow()F.LuaString=plugindef()E:SetTitle(F)local _=E:CreateStatic(0,0)F.LuaString="Select destination staff:"_:SetText(F)_:SetWidth(200)local a0=E:CreateListBox(0,V)a0.UseCheckboxes=true;a0:SetWidth(200)for v,w in ipairs(K)do F.LuaString=w[2]a0:AddString(F)end;F.LuaString="Cue Options:"E:CreateStatic(U[1],0):SetText(F)for v,w in ipairs(X)do F.LuaString=string.gsub(w,'_',' ')if v<=Y then Z[v]=E:CreateCheckbox(U[1],v*V)Z[v]:SetText(F)Z[v]:SetWidth(120)local a1=r[w]and 1 or 0;Z[v]:SetCheck(a1)elseif v<#X then F.LuaString=F.LuaString..":"E:CreateStatic(U[1],v*V):SetText(F)Z[v]=E:CreateEdit(U[2],v*V-W)Z[v]:SetInteger(r[w])Z[v]:SetWidth(50)end end;local a2=E:CreatePopup(U[1],#X*V+5)F.LuaString="Stems: natural direction"a2:AddString(F)F.LuaString="Stems: freeze up"a2:AddString(F)F.LuaString="Stems: freeze down"a2:AddString(F)a2:SetWidth(160)a2:SetSelectedItem(r.freeze_up_down)local a3=E:CreateButton(U[3],V*2)F.LuaString="Clear All"a3:SetWidth(80)a3:SetText(F)E:RegisterHandleControlEvent(a3,function()for v=1,Y do Z[v]:SetCheck(0)end;a0:SetKeyboardFocus()end)local a4=E:CreateButton(U[3],V*4)F.LuaString="Set All"a4:SetWidth(80)a4:SetText(F)E:RegisterHandleControlEvent(a4,function()for v=1,Y do Z[v]:SetCheck(1)end;a0:SetKeyboardFocus()end)E:CreateOkButton()E:CreateCancelButton()local I=E:ExecuteModal(nil)==finale.EXECMODAL_OK;local a5=a0:GetSelectedItem()local a6=K[a5+1][1]for v,w in ipairs(X)do if v<=Y then r[w]=Z[v]:GetCheck()==1 elseif v<#X then local a7=Z[v]:GetInteger()if v==#Z and(a7<2 or a7>4)then a7=4 end;r[w]=a7 end end;r.freeze_up_down=a2:GetSelectedItem()return I,a6 end;function fix_text_expressions(B)local a8=finale.FCExpressions()a8:LoadAllForRegion(B)for a9 in eachbackwards(a8)do if a9.StaffGroupID==0 then if r.copy_expressions then a9.LayerAssignment=r.cuenote_layer;a9.ScaleWithEntry=true;a9:Save()else a9:DeleteData()end end end end;function copy_to_destination(aa,ab)local ac=finale.FCMusicRegion()ac:SetRegion(aa)ac:CopyMusic()ac.StartStaff=ab;ac.EndStaff=ab;if not region_is_empty(ac)and not should_overwrite_existing_music()then ac:ReleaseMusic()return false end;ac:PasteMusic()ac:ReleaseMusic()for ad=2,4 do q.clear(ac,ad)end;for C in eachentrysaved(ac)do if C:IsNote()and r.mute_cuenotes then C.Playback=false end;C:SetNoteDetailFlag(true)local ae=finale.FCEntryAlterMod()ae:SetNoteEntry(C)ae:SetResize(r.cuenote_percent)ae:Save()if not r.copy_articulations and C:GetArticulationFlag()then for af in each(C:CreateArticulations())do af:DeleteData()end;C:SetArticulationFlag(false)end;if r.freeze_up_down>0 then C.FreezeStem=true;C.StemUp=r.freeze_up_down==1 end end;q.swap(ac,1,r.cuenote_layer)if not r.copy_clef then p.restore_default_clef(ac.StartMeasure,ac.EndMeasure,ab)end;fix_text_expressions(ac)if not r.copy_smartshapes or not r.copy_slurs then local ag=finale.FCSmartShapeMeasureMarks()ag:LoadAllForRegion(ac,true)for ah in each(ag)do local ai=ah:CreateSmartShape()if ai:IsSlur()and not r.copy_slurs or not ai:IsSlur()and not r.copy_smartshapes then ai:DeleteData()end end end;for aj=ac.StartMeasure,ac.EndMeasure do local ak=finale.FCNoteEntryCell(aj,ab)ak:Load()local al=ak:AppendEntriesInLayer(1,1)if al then al.Duration=finale.WHOLE_NOTE;al.Legality=true;al:MakeRest()ak:Save()end end;return true end;function new_expression_category(am)local I=false;local an=0;if not finenv.IsRGPLua then return I,an end;local ao=finale.FCCategoryDef()ao:Load(finale.DEFAULTCATID_TECHNIQUETEXT)local F=finale.FCString()F.LuaString=am;ao:SetName(F)ao:SetVerticalAlignmentPoint(finale.ALIGNVERT_STAFF_REFERENCE_LINE)ao:SetVerticalBaselineOffset(30)ao:SetHorizontalAlignmentPoint(finale.ALIGNHORIZ_CLICKPOS)ao:SetHorizontalOffset(-18)local O=ao:CreateTextFontInfo()O.Size=O.Size-r.cue_font_smaller;ao:SetTextFontInfo(O)I=ao:SaveNewWithType(finale.DEFAULTCATID_TECHNIQUETEXT)if I then an=ao:GetID()end;return I,an end;function assign_expression_to_staff(T,ap,aq,ar)local as=finale.FCExpression()as:SetStaff(T)as:SetVisible(true)as:SetMeasurePos(aq)as:SetScaleWithEntry(false)as:SetPartAssignment(true)as:SetScoreAssignment(true)as:SetID(ar)as:SaveNewToCell(finale.FCCell(ap,T))end;function create_cue_notes()local at={}local aa=finenv.Region()local au=aa.StartStaff;local I,av,aw,ax,ay,az,ab,as;if aa:CalcStaffSpan()>1 then return show_error("only_one_staff")elseif region_is_empty(aa)then return show_error("empty_region")end;av=finale.FCCategoryDef()aw=finale.FCTextExpressionDefs()aw:LoadAll()for aA in each(aw)do av:Load(aA.CategoryID)if string.find(av:CreateName().LuaString,r.cue_category_name)then ax=aA.CategoryID;local F=aA:CreateTextString()F:TrimEnigmaTags()table.insert(at,{F.LuaString,aA.ItemNo})end end;if#at==0 then I,ax=new_expression_category(r.cue_category_name)if not I then return show_error("first_make_expression_category")end end;I,az=choose_name_index(at)if not I then return end;if az==0 then I,as=new_cue_name(au)if not I or as==""then return end;ay=create_new_expression(as,ax)else ay=at[az][2]end;I,ab=choose_destination_staff(au)if not I then return end;save_config_file()if not copy_to_destination(aa,ab)then return end;assign_expression_to_staff(ab,aa.StartMeasure,0,ay)aa:SetInDocument()end;create_cue_notes()end)c("library.layer",function(require,n,c,d)local aB={}function aB.finale_version(aC,aD,aE)local aF=bit32.bor(bit32.lshift(math.floor(aC),24),bit32.lshift(math.floor(aD),20))if aE then aF=bit32.bor(aF,math.floor(aE))end;return aF end;function aB.group_overlaps_region(aG,B)if B:IsFullDocumentSpan()then return true end;local aH=false;local aI=finale.FCSystemStaves()aI:LoadAllForRegion(B)for aJ in each(aI)do if aG:ContainsStaff(aJ:GetStaff())then aH=true;break end end;if not aH then return false end;if aG.StartMeasure>B.EndMeasure or aG.EndMeasure<B.StartMeasure then return false end;return true end;function aB.group_is_contained_in_region(aG,B)if not B:IsStaffIncluded(aG.StartStaff)then return false end;if not B:IsStaffIncluded(aG.EndStaff)then return false end;return true end;function aB.staff_group_is_multistaff_instrument(aG)local aK=finale.FCMultiStaffInstruments()aK:LoadAll()for aL in each(aK)do if aL:ContainsStaff(aG.StartStaff)and aL.GroupID==aG:GetItemID()then return true end end;return false end;function aB.get_selected_region_or_whole_doc()local aM=finenv.Region()if aM:IsEmpty()then aM:SetFullDocument()end;return aM end;function aB.get_first_cell_on_or_after_page(aN)local aO=aN;local aP=finale.FCPage()local aQ=false;while aP:Load(aO)do if aP:GetFirstSystem()>0 then aQ=true;break end;aO=aO+1 end;if aQ then local aR=finale.FCStaffSystem()aR:Load(aP:GetFirstSystem())return finale.FCCell(aR.FirstMeasure,aR.TopStaff)end;local aS=finale.FCMusicRegion()aS:SetFullDocument()return finale.FCCell(aS.EndMeasure,aS.EndStaff)end;function aB.get_top_left_visible_cell()if not finenv.UI():IsPageView()then local aT=finale.FCMusicRegion()aT:SetFullDocument()return finale.FCCell(finenv.UI():GetCurrentMeasure(),aT.StartStaff)end;return aB.get_first_cell_on_or_after_page(finenv.UI():GetCurrentPage())end;function aB.get_top_left_selected_or_visible_cell()local aM=finenv.Region()if not aM:IsEmpty()then return finale.FCCell(aM.StartMeasure,aM.StartStaff)end;return aB.get_top_left_visible_cell()end;function aB.is_default_measure_number_visible_on_cell(aU,aV,aW,aX)local H=finale.FCCurrentStaffSpec()if not H:LoadForCell(aV,0)then return false end;if aU:GetShowOnTopStaff()and aV.Staff==aW.TopStaff then return true end;if aU:GetShowOnBottomStaff()and aV.Staff==aW:CalcBottomStaff()then return true end;if H.ShowMeasureNumbers then return not aU:GetExcludeOtherStaves(aX)end;return false end;function aB.is_default_number_visible_and_left_aligned(aU,aV,aY,aX,aZ)if aU.UseScoreInfoForParts then aX=false end;if aZ and aU:GetShowOnMultiMeasureRests(aX)then if finale.MNALIGN_LEFT~=aU:GetMultiMeasureAlignment(aX)then return false end elseif aV.Measure==aY.FirstMeasure then if not aU:GetShowOnSystemStart()then return false end;if finale.MNALIGN_LEFT~=aU:GetStartAlignment(aX)then return false end else if not aU:GetShowMultiples(aX)then return false end;if finale.MNALIGN_LEFT~=aU:GetMultipleAlignment(aX)then return false end end;return aB.is_default_measure_number_visible_on_cell(aU,aV,aY,aX)end;function aB.update_layout(a_,b0)a_=a_ or 1;b0=b0 or false;local b1=finale.FCPage()if b1:Load(a_)then b1:UpdateLayout(b0)end end;function aB.get_current_part()local b2=finale.FCParts()b2:LoadAll()return b2:GetCurrent()end;function aB.get_page_format_prefs()local b3=aB.get_current_part()local b4=finale.FCPageFormatPrefs()local b5=false;if b3:IsScore()then b5=b4:LoadScore()else b5=b4:LoadParts()end;return b4,b5 end;function aB.get_smufl_metadata_file(b6)if not b6 then b6=finale.FCFontInfo()b6:LoadFontPrefs(finale.FONTPREF_MUSIC)end;local b7=function(b8,b6)local t=b8 .."/SMuFL/Fonts/"..b6.Name.."/"..b6.Name..".json"return io.open(t,"r")end;local b9=""if finenv.UI():IsOnWindows()then b9=os.getenv("LOCALAPPDATA")else b9=os.getenv("HOME").."/Library/Application Support"end;local ba=b7(b9,b6)if nil~=ba then return ba end;local bb="/Library/Application Support"if finenv.UI():IsOnWindows()then bb=os.getenv("COMMONPROGRAMFILES")end;return b7(bb,b6)end;function aB.is_font_smufl_font(b6)if not b6 then b6=finale.FCFontInfo()b6:LoadFontPrefs(finale.FONTPREF_MUSIC)end;if finenv.RawFinaleVersion>=aB.finale_version(27,1)then if nil~=b6.IsSMuFLFont then return b6.IsSMuFLFont end end;local bc=aB.get_smufl_metadata_file(b6)if nil~=bc then io.close(bc)return true end;return false end;function aB.simple_input(bd,be)local bf=finale.FCString()bf.LuaString=""local F=finale.FCString()local bg=160;function format_ctrl(bh,bi,bj,bk)bh:SetHeight(bi)bh:SetWidth(bj)F.LuaString=bk;bh:SetText(F)end;title_width=string.len(bd)*6+54;if title_width>bg then bg=title_width end;text_width=string.len(be)*6;if text_width>bg then bg=text_width end;F.LuaString=bd;local E=finale.FCCustomLuaWindow()E:SetTitle(F)local bl=E:CreateStatic(0,0)format_ctrl(bl,16,bg,be)local bm=E:CreateEdit(0,20)format_ctrl(bm,20,bg,"")E:CreateOkButton()E:CreateCancelButton()function callback(bh)end;E:RegisterHandleCommand(callback)if E:ExecuteModal(nil)==finale.EXECMODAL_OK then bf.LuaString=bm:GetText(bf)return bf.LuaString end end;function aB.is_finale_object(bn)return bn and type(bn)=="userdata"and bn.ClassName and bn.GetClassID and true or false end;function aB.system_indent_set_to_prefs(aY,b4)b4=b4 or aB.get_page_format_prefs()local bo=finale.FCMeasure()local bp=aY.FirstMeasure==1;if not bp and bo:Load(aY.FirstMeasure)then if bo.ShowFullNames then bp=true end end;if bp and b4.UseFirstSystemMargins then aY.LeftMargin=b4.FirstSystemLeft else aY.LeftMargin=b4.SystemLeft end;return aY:Save()end;return aB end)c("library.clef",function(require,n,c,d)local aB={}function aB.finale_version(aC,aD,aE)local aF=bit32.bor(bit32.lshift(math.floor(aC),24),bit32.lshift(math.floor(aD),20))if aE then aF=bit32.bor(aF,math.floor(aE))end;return aF end;function aB.group_overlaps_region(aG,B)if B:IsFullDocumentSpan()then return true end;local aH=false;local aI=finale.FCSystemStaves()aI:LoadAllForRegion(B)for aJ in each(aI)do if aG:ContainsStaff(aJ:GetStaff())then aH=true;break end end;if not aH then return false end;if aG.StartMeasure>B.EndMeasure or aG.EndMeasure<B.StartMeasure then return false end;return true end;function aB.group_is_contained_in_region(aG,B)if not B:IsStaffIncluded(aG.StartStaff)then return false end;if not B:IsStaffIncluded(aG.EndStaff)then return false end;return true end;function aB.staff_group_is_multistaff_instrument(aG)local aK=finale.FCMultiStaffInstruments()aK:LoadAll()for aL in each(aK)do if aL:ContainsStaff(aG.StartStaff)and aL.GroupID==aG:GetItemID()then return true end end;return false end;function aB.get_selected_region_or_whole_doc()local aM=finenv.Region()if aM:IsEmpty()then aM:SetFullDocument()end;return aM end;function aB.get_first_cell_on_or_after_page(aN)local aO=aN;local aP=finale.FCPage()local aQ=false;while aP:Load(aO)do if aP:GetFirstSystem()>0 then aQ=true;break end;aO=aO+1 end;if aQ then local aR=finale.FCStaffSystem()aR:Load(aP:GetFirstSystem())return finale.FCCell(aR.FirstMeasure,aR.TopStaff)end;local aS=finale.FCMusicRegion()aS:SetFullDocument()return finale.FCCell(aS.EndMeasure,aS.EndStaff)end;function aB.get_top_left_visible_cell()if not finenv.UI():IsPageView()then local aT=finale.FCMusicRegion()aT:SetFullDocument()return finale.FCCell(finenv.UI():GetCurrentMeasure(),aT.StartStaff)end;return aB.get_first_cell_on_or_after_page(finenv.UI():GetCurrentPage())end;function aB.get_top_left_selected_or_visible_cell()local aM=finenv.Region()if not aM:IsEmpty()then return finale.FCCell(aM.StartMeasure,aM.StartStaff)end;return aB.get_top_left_visible_cell()end;function aB.is_default_measure_number_visible_on_cell(aU,aV,aW,aX)local H=finale.FCCurrentStaffSpec()if not H:LoadForCell(aV,0)then return false end;if aU:GetShowOnTopStaff()and aV.Staff==aW.TopStaff then return true end;if aU:GetShowOnBottomStaff()and aV.Staff==aW:CalcBottomStaff()then return true end;if H.ShowMeasureNumbers then return not aU:GetExcludeOtherStaves(aX)end;return false end;function aB.is_default_number_visible_and_left_aligned(aU,aV,aY,aX,aZ)if aU.UseScoreInfoForParts then aX=false end;if aZ and aU:GetShowOnMultiMeasureRests(aX)then if finale.MNALIGN_LEFT~=aU:GetMultiMeasureAlignment(aX)then return false end elseif aV.Measure==aY.FirstMeasure then if not aU:GetShowOnSystemStart()then return false end;if finale.MNALIGN_LEFT~=aU:GetStartAlignment(aX)then return false end else if not aU:GetShowMultiples(aX)then return false end;if finale.MNALIGN_LEFT~=aU:GetMultipleAlignment(aX)then return false end end;return aB.is_default_measure_number_visible_on_cell(aU,aV,aY,aX)end;function aB.update_layout(a_,b0)a_=a_ or 1;b0=b0 or false;local b1=finale.FCPage()if b1:Load(a_)then b1:UpdateLayout(b0)end end;function aB.get_current_part()local b2=finale.FCParts()b2:LoadAll()return b2:GetCurrent()end;function aB.get_page_format_prefs()local b3=aB.get_current_part()local b4=finale.FCPageFormatPrefs()local b5=false;if b3:IsScore()then b5=b4:LoadScore()else b5=b4:LoadParts()end;return b4,b5 end;function aB.get_smufl_metadata_file(b6)if not b6 then b6=finale.FCFontInfo()b6:LoadFontPrefs(finale.FONTPREF_MUSIC)end;local b7=function(b8,b6)local t=b8 .."/SMuFL/Fonts/"..b6.Name.."/"..b6.Name..".json"return io.open(t,"r")end;local b9=""if finenv.UI():IsOnWindows()then b9=os.getenv("LOCALAPPDATA")else b9=os.getenv("HOME").."/Library/Application Support"end;local ba=b7(b9,b6)if nil~=ba then return ba end;local bb="/Library/Application Support"if finenv.UI():IsOnWindows()then bb=os.getenv("COMMONPROGRAMFILES")end;return b7(bb,b6)end;function aB.is_font_smufl_font(b6)if not b6 then b6=finale.FCFontInfo()b6:LoadFontPrefs(finale.FONTPREF_MUSIC)end;if finenv.RawFinaleVersion>=aB.finale_version(27,1)then if nil~=b6.IsSMuFLFont then return b6.IsSMuFLFont end end;local bc=aB.get_smufl_metadata_file(b6)if nil~=bc then io.close(bc)return true end;return false end;function aB.simple_input(bd,be)local bf=finale.FCString()bf.LuaString=""local F=finale.FCString()local bg=160;function format_ctrl(bh,bi,bj,bk)bh:SetHeight(bi)bh:SetWidth(bj)F.LuaString=bk;bh:SetText(F)end;title_width=string.len(bd)*6+54;if title_width>bg then bg=title_width end;text_width=string.len(be)*6;if text_width>bg then bg=text_width end;F.LuaString=bd;local E=finale.FCCustomLuaWindow()E:SetTitle(F)local bl=E:CreateStatic(0,0)format_ctrl(bl,16,bg,be)local bm=E:CreateEdit(0,20)format_ctrl(bm,20,bg,"")E:CreateOkButton()E:CreateCancelButton()function callback(bh)end;E:RegisterHandleCommand(callback)if E:ExecuteModal(nil)==finale.EXECMODAL_OK then bf.LuaString=bm:GetText(bf)return bf.LuaString end end;function aB.is_finale_object(bn)return bn and type(bn)=="userdata"and bn.ClassName and bn.GetClassID and true or false end;function aB.system_indent_set_to_prefs(aY,b4)b4=b4 or aB.get_page_format_prefs()local bo=finale.FCMeasure()local bp=aY.FirstMeasure==1;if not bp and bo:Load(aY.FirstMeasure)then if bo.ShowFullNames then bp=true end end;if bp and b4.UseFirstSystemMargins then aY.LeftMargin=b4.FirstSystemLeft else aY.LeftMargin=b4.SystemLeft end;return aY:Save()end;return aB end)c("library.configuration",function(require,n,c,d)local aB={}function aB.finale_version(aC,aD,aE)local aF=bit32.bor(bit32.lshift(math.floor(aC),24),bit32.lshift(math.floor(aD),20))if aE then aF=bit32.bor(aF,math.floor(aE))end;return aF end;function aB.group_overlaps_region(aG,B)if B:IsFullDocumentSpan()then return true end;local aH=false;local aI=finale.FCSystemStaves()aI:LoadAllForRegion(B)for aJ in each(aI)do if aG:ContainsStaff(aJ:GetStaff())then aH=true;break end end;if not aH then return false end;if aG.StartMeasure>B.EndMeasure or aG.EndMeasure<B.StartMeasure then return false end;return true end;function aB.group_is_contained_in_region(aG,B)if not B:IsStaffIncluded(aG.StartStaff)then return false end;if not B:IsStaffIncluded(aG.EndStaff)then return false end;return true end;function aB.staff_group_is_multistaff_instrument(aG)local aK=finale.FCMultiStaffInstruments()aK:LoadAll()for aL in each(aK)do if aL:ContainsStaff(aG.StartStaff)and aL.GroupID==aG:GetItemID()then return true end end;return false end;function aB.get_selected_region_or_whole_doc()local aM=finenv.Region()if aM:IsEmpty()then aM:SetFullDocument()end;return aM end;function aB.get_first_cell_on_or_after_page(aN)local aO=aN;local aP=finale.FCPage()local aQ=false;while aP:Load(aO)do if aP:GetFirstSystem()>0 then aQ=true;break end;aO=aO+1 end;if aQ then local aR=finale.FCStaffSystem()aR:Load(aP:GetFirstSystem())return finale.FCCell(aR.FirstMeasure,aR.TopStaff)end;local aS=finale.FCMusicRegion()aS:SetFullDocument()return finale.FCCell(aS.EndMeasure,aS.EndStaff)end;function aB.get_top_left_visible_cell()if not finenv.UI():IsPageView()then local aT=finale.FCMusicRegion()aT:SetFullDocument()return finale.FCCell(finenv.UI():GetCurrentMeasure(),aT.StartStaff)end;return aB.get_first_cell_on_or_after_page(finenv.UI():GetCurrentPage())end;function aB.get_top_left_selected_or_visible_cell()local aM=finenv.Region()if not aM:IsEmpty()then return finale.FCCell(aM.StartMeasure,aM.StartStaff)end;return aB.get_top_left_visible_cell()end;function aB.is_default_measure_number_visible_on_cell(aU,aV,aW,aX)local H=finale.FCCurrentStaffSpec()if not H:LoadForCell(aV,0)then return false end;if aU:GetShowOnTopStaff()and aV.Staff==aW.TopStaff then return true end;if aU:GetShowOnBottomStaff()and aV.Staff==aW:CalcBottomStaff()then return true end;if H.ShowMeasureNumbers then return not aU:GetExcludeOtherStaves(aX)end;return false end;function aB.is_default_number_visible_and_left_aligned(aU,aV,aY,aX,aZ)if aU.UseScoreInfoForParts then aX=false end;if aZ and aU:GetShowOnMultiMeasureRests(aX)then if finale.MNALIGN_LEFT~=aU:GetMultiMeasureAlignment(aX)then return false end elseif aV.Measure==aY.FirstMeasure then if not aU:GetShowOnSystemStart()then return false end;if finale.MNALIGN_LEFT~=aU:GetStartAlignment(aX)then return false end else if not aU:GetShowMultiples(aX)then return false end;if finale.MNALIGN_LEFT~=aU:GetMultipleAlignment(aX)then return false end end;return aB.is_default_measure_number_visible_on_cell(aU,aV,aY,aX)end;function aB.update_layout(a_,b0)a_=a_ or 1;b0=b0 or false;local b1=finale.FCPage()if b1:Load(a_)then b1:UpdateLayout(b0)end end;function aB.get_current_part()local b2=finale.FCParts()b2:LoadAll()return b2:GetCurrent()end;function aB.get_page_format_prefs()local b3=aB.get_current_part()local b4=finale.FCPageFormatPrefs()local b5=false;if b3:IsScore()then b5=b4:LoadScore()else b5=b4:LoadParts()end;return b4,b5 end;function aB.get_smufl_metadata_file(b6)if not b6 then b6=finale.FCFontInfo()b6:LoadFontPrefs(finale.FONTPREF_MUSIC)end;local b7=function(b8,b6)local t=b8 .."/SMuFL/Fonts/"..b6.Name.."/"..b6.Name..".json"return io.open(t,"r")end;local b9=""if finenv.UI():IsOnWindows()then b9=os.getenv("LOCALAPPDATA")else b9=os.getenv("HOME").."/Library/Application Support"end;local ba=b7(b9,b6)if nil~=ba then return ba end;local bb="/Library/Application Support"if finenv.UI():IsOnWindows()then bb=os.getenv("COMMONPROGRAMFILES")end;return b7(bb,b6)end;function aB.is_font_smufl_font(b6)if not b6 then b6=finale.FCFontInfo()b6:LoadFontPrefs(finale.FONTPREF_MUSIC)end;if finenv.RawFinaleVersion>=aB.finale_version(27,1)then if nil~=b6.IsSMuFLFont then return b6.IsSMuFLFont end end;local bc=aB.get_smufl_metadata_file(b6)if nil~=bc then io.close(bc)return true end;return false end;function aB.simple_input(bd,be)local bf=finale.FCString()bf.LuaString=""local F=finale.FCString()local bg=160;function format_ctrl(bh,bi,bj,bk)bh:SetHeight(bi)bh:SetWidth(bj)F.LuaString=bk;bh:SetText(F)end;title_width=string.len(bd)*6+54;if title_width>bg then bg=title_width end;text_width=string.len(be)*6;if text_width>bg then bg=text_width end;F.LuaString=bd;local E=finale.FCCustomLuaWindow()E:SetTitle(F)local bl=E:CreateStatic(0,0)format_ctrl(bl,16,bg,be)local bm=E:CreateEdit(0,20)format_ctrl(bm,20,bg,"")E:CreateOkButton()E:CreateCancelButton()function callback(bh)end;E:RegisterHandleCommand(callback)if E:ExecuteModal(nil)==finale.EXECMODAL_OK then bf.LuaString=bm:GetText(bf)return bf.LuaString end end;function aB.is_finale_object(bn)return bn and type(bn)=="userdata"and bn.ClassName and bn.GetClassID and true or false end;function aB.system_indent_set_to_prefs(aY,b4)b4=b4 or aB.get_page_format_prefs()local bo=finale.FCMeasure()local bp=aY.FirstMeasure==1;if not bp and bo:Load(aY.FirstMeasure)then if bo.ShowFullNames then bp=true end end;if bp and b4.UseFirstSystemMargins then aY.LeftMargin=b4.FirstSystemLeft else aY.LeftMargin=b4.SystemLeft end;return aY:Save()end;return aB end)return a("__root")