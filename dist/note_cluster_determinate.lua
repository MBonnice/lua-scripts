local a,b,c,d=(function(e)local f={[{}]=true}local g;local h={}local require;local i={}g=function(j,k)if not h[j]then h[j]=k end end;require=function(j)local l=i[j]if l then if l==f then return nil end else if not h[j]then if not e then local m=type(j)=='string'and'\"'..j..'\"'or tostring(j)error('Tried to require '..m..', but no such module has been registered')else return e(j)end end;i[j]=f;l=h[j](require,i,g,h)i[j]=l end;return l end;return require,i,g,h end)(require)c("__root",function(require,o,c,d)function plugindef()finaleplugin.RequireSelection=true;finaleplugin.Author="Jacob Winkler"finaleplugin.Copyright="Â©2019 Jacob Winkler"finaleplugin.AuthorEmail="jacob.winkler@mac.com"finaleplugin.Version="1.0"finaleplugin.Date="11/02/2019"return"Cluster - Determinate","Cluster - Determinate","Creates a determinate cluster."end;local p=require("library.note_entry")local q=finenv.Region()local r={}local s={}local t={}local u={}local v=-20;local function w(x)local y={}for z in eachentrysaved(q)do z.FreezeStem=false;table.insert(y,z:CalcStemUp())end;r.copy(1,2)r.copy(1,3)local A=1;local B=1;for p in eachentrysaved(x)do local C=p:CalcDisplacementRange(nil)local D=y[A]if p.LayerNumber==1 then D=y[A]if p:IsNote()then if C>2 then delete_bottom_notes(p)else delete_middle_notes(p)p.FreezeStem=true;p.StemUp=D end elseif p:IsRest()then p:SetRestDisplacement(6)end;if D==false and C>2 then hide_stems(p,D)end;A=A+1 elseif p.LayerNumber==2 then D=y[B]if p:IsNote()and C>2 then delete_top_notes(p)else p:MakeRest()p.Visible=false;p:SetRestDisplacement(4)end;if D==true then hide_stems(p,D)end;B=B+1 elseif p.LayerNumber==3 then if p:IsNote()then for E in each(p)do E.AccidentalFreeze=true;E.Accidental=false end;p.FreezeStem=true;p.StemUp=true;hide_stems(p,true)delete_top_bottom_notes(p)elseif p:IsRest()then p:SetRestDisplacement(2)end;p.Visible=false end;p.CheckAccidentals=true;if p:IsNote()then n=1;for E in each(p)do E.NoteID=n;n=n+1 end end end end;function hide_stems(z,D)local F=finale.FCCustomStemMod()F:SetNoteEntry(z)if D then D=false else D=true end;F:UseUpStemData(D)if F:LoadFirst()then F.ShapeID=0;F:Save()else F.ShapeID=0;F:SaveNew()end;z:SetBeamBeat(true)end;function r.copy(G,H)local q=finenv.Region()local I=q.StartMeasure;local J=q.EndMeasure;local K=finale.FCSystemStaves()K:LoadAllForRegion(q)G=G-1;H=H-1;for L in each(K)do local M=L.Staff;local N=finale.FCNoteEntryLayer(G,M,I,J)N:Load()local O=N:CreateCloneEntries(H,M,I)O:Save()O:CloneTuplets(N)O:Save()end end;function delete_bottom_notes(z)while z.Count>1 do local P=z:CalcLowestNote(nil)p.delete_note(P)end end;function delete_top_notes(z)while z.Count>1 do local Q=z:CalcHighestNote(nil)p.delete_note(Q)end end;function delete_top_bottom_notes(z)local Q=z:CalcHighestNote(nil)p.delete_note(Q)local P=z:CalcLowestNote(nil)p.delete_note(P)end;function delete_middle_notes(z)while z.Count>2 do local n=1;for E in each(z)do E.NoteID=n;n=n+1 end;for E in each(z)do if E.NoteID==2 then p.delete_note(E)end end end end;local function R()local S=false;local T=0;local U=64*24*.5;local V=finale.FCCustomSmartLineDefs()V:LoadAll()for W in each(V)do if W.LineStyle==finale.CUSTOMLINE_SOLID and W.LineWidth==U then if W.StartArrowheadStyle==finale.CLENDPOINT_NONE and W.EndArrowheadStyle==finale.CLENDPOINT_NONE then if W.Horizontal==false then T=W.ItemNo;S=true end end end end;if S==false then local W=finale.FCCustomSmartLineDef()W.Horizontal=false;W.LineStyle=finale.CUSTOMLINE_SOLID;W.StartArrowheadStyle=finale.CLENDPOINT_NONE;W.EndArrowheadStyle=finale.CLENDPOINT_NONE;W.LineWidth=U;W:SaveNew()T=W.ItemNo end;return T end;local function X()local S=false;local T=0;local U=64*24*.333;local Y=finale.FCCustomSmartLineDefs()Y:LoadAll()for W in each(Y)do if W.LineStyle==finale.CUSTOMLINE_SOLID and W.LineWidth==U then if W.StartArrowheadStyle==finale.CLENDPOINT_NONE and W.EndArrowheadStyle==finale.CLENDPOINT_NONE then if W.Horizontal==false then T=W.ItemNo;S=true end end end end;if S==false then local W=finale.FCCustomSmartLineDef()W.Horizontal=false;W.LineStyle=finale.CUSTOMLINE_SOLID;W.StartArrowheadStyle=finale.CLENDPOINT_NONE;W.EndArrowheadStyle=finale.CLENDPOINT_NONE;W.LineWidth=U;W:SaveNew()T=W.ItemNo end;return T end;function add_cluster_line(Z,_,a0)if Z:IsNote()and Z.Count==1 and _:IsNote()then local a1=finale.FCSmartShape()local a2=Z:CalcHighestNote(nil)local a3=a2:CalcNoteheadWidth()local a4=a2:CalcStaffPosition()local a5=_:CalcHighestNote(nil)local a6=a5:CalcStaffPosition()local a7=0;local a8=0;if Z.Duration>=2048 and Z.Duration<4096 then a7=9;a8=a7 elseif Z.Duration>=4096 then a7=10;a8=11.5 end;a4=a4*12-a7;a6=a6*12+a8;a1.ShapeType=finale.SMARTSHAPE_CUSTOM;a1.EntryBased=false;a1.MakeHorizontal=false;a1.BeatAttached=true;a1.PresetShape=true;a1.Visible=true;a1.LineID=a0;local a9=a1:GetTerminateSegmentLeft()a9:SetMeasure(Z.Measure)a9:SetStaff(Z.Staff)a9:SetMeasurePos(Z.MeasurePos)a9:SetEndpointOffsetX(a3/2)a9:SetEndpointOffsetY(a4)local aa=a1:GetTerminateSegmentRight()aa:SetMeasure(_.Measure)aa:SetStaff(_.Staff)aa:SetMeasurePos(_.MeasurePos)aa:SetEndpointOffsetX(a3/2)aa:SetEndpointOffsetY(a6)a1:SaveNewEverything(nil,nil)end end;function add_short_cluster_line(z,ab)if z:IsNote()and z.Count>1 then local a1=finale.FCSmartShape()local Z=z:CalcHighestNote(nil)local ac=Z:CalcStaffPosition()*12+12;local _=z:CalcLowestNote(nil)local ad=_:CalcStaffPosition()*12-12;a1.ShapeType=finale.SMARTSHAPE_CUSTOM;a1.EntryBased=false;a1.MakeHorizontal=false;a1.PresetShape=true;a1.Visible=true;a1.BeatAttached=true;a1.LineID=ab;local a9=a1:GetTerminateSegmentLeft()a9:SetMeasure(z.Measure)a9:SetStaff(z.Staff)a9:SetMeasurePos(z.MeasurePos)a9:SetEndpointOffsetX(v)a9:SetEndpointOffsetY(ac)local aa=a1:GetTerminateSegmentRight()aa:SetMeasure(z.Measure)aa:SetStaff(z.Staff)aa:SetMeasurePos(z.MeasurePos)aa:SetEndpointOffsetX(v)aa:SetEndpointOffsetY(ad)a1:SaveNewEverything(nil,nil)end end;local a0=R()local ab=X()for ae=q:GetStartStaff(),q:GetEndStaff()do local af=0;for ag in pairs(s)do s[ag]=nil end;for ag in pairs(t)do t[ag]=nil end;for ag in pairs(u)do u[ag]=nil end;q:SetStartStaff(ae)q:SetEndStaff(ae)local ah=finale.FCMeasures()ah:LoadRegion(q)w(q)for z in eachentrysaved(q)do if z.LayerNumber==1 then table.insert(s,z)table.insert(u,z.Measure)af=af+1 elseif z.LayerNumber==2 then table.insert(t,z)end end;for A=1,af do add_short_cluster_line(s[A],ab)add_cluster_line(s[A],t[A],a0)end end;for p in eachentrysaved(finenv.Region())do if p:IsNote()and p.Count>1 then for E in each(p)do if E.Accidental==true then local ai=finale.FCAccidentalMod()ai:SetNoteEntry(p)ai:SetUseCustomVerticalPos(true)ai:SetHorizontalPos(v*1.5)ai:SaveAt(E)end end end end end)c("library.note_entry",function(require,o,c,d)local aj={}function aj.finale_version(ak,al,am)local an=bit32.bor(bit32.lshift(math.floor(ak),24),bit32.lshift(math.floor(al),20))if am then an=bit32.bor(an,math.floor(am))end;return an end;function aj.group_overlaps_region(ao,q)if q:IsFullDocumentSpan()then return true end;local ap=false;local aq=finale.FCSystemStaves()aq:LoadAllForRegion(q)for ar in each(aq)do if ao:ContainsStaff(ar:GetStaff())then ap=true;break end end;if not ap then return false end;if ao.StartMeasure>q.EndMeasure or ao.EndMeasure<q.StartMeasure then return false end;return true end;function aj.group_is_contained_in_region(ao,q)if not q:IsStaffIncluded(ao.StartStaff)then return false end;if not q:IsStaffIncluded(ao.EndStaff)then return false end;return true end;function aj.staff_group_is_multistaff_instrument(ao)local as=finale.FCMultiStaffInstruments()as:LoadAll()for at in each(as)do if at:ContainsStaff(ao.StartStaff)and at.GroupID==ao:GetItemID()then return true end end;return false end;function aj.get_selected_region_or_whole_doc()local au=finenv.Region()if au:IsEmpty()then au:SetFullDocument()end;return au end;function aj.get_first_cell_on_or_after_page(av)local aw=av;local ax=finale.FCPage()local ay=false;while ax:Load(aw)do if ax:GetFirstSystem()>0 then ay=true;break end;aw=aw+1 end;if ay then local az=finale.FCStaffSystem()az:Load(ax:GetFirstSystem())return finale.FCCell(az.FirstMeasure,az.TopStaff)end;local aA=finale.FCMusicRegion()aA:SetFullDocument()return finale.FCCell(aA.EndMeasure,aA.EndStaff)end;function aj.get_top_left_visible_cell()if not finenv.UI():IsPageView()then local aB=finale.FCMusicRegion()aB:SetFullDocument()return finale.FCCell(finenv.UI():GetCurrentMeasure(),aB.StartStaff)end;return aj.get_first_cell_on_or_after_page(finenv.UI():GetCurrentPage())end;function aj.get_top_left_selected_or_visible_cell()local au=finenv.Region()if not au:IsEmpty()then return finale.FCCell(au.StartMeasure,au.StartStaff)end;return aj.get_top_left_visible_cell()end;function aj.is_default_measure_number_visible_on_cell(aC,aD,aE,aF)local aG=finale.FCCurrentStaffSpec()if not aG:LoadForCell(aD,0)then return false end;if aC:GetShowOnTopStaff()and aD.Staff==aE.TopStaff then return true end;if aC:GetShowOnBottomStaff()and aD.Staff==aE:CalcBottomStaff()then return true end;if aG.ShowMeasureNumbers then return not aC:GetExcludeOtherStaves(aF)end;return false end;function aj.is_default_number_visible_and_left_aligned(aC,aD,aH,aF,aI)if aC.UseScoreInfoForParts then aF=false end;if aI and aC:GetShowOnMultiMeasureRests(aF)then if finale.MNALIGN_LEFT~=aC:GetMultiMeasureAlignment(aF)then return false end elseif aD.Measure==aH.FirstMeasure then if not aC:GetShowOnSystemStart()then return false end;if finale.MNALIGN_LEFT~=aC:GetStartAlignment(aF)then return false end else if not aC:GetShowMultiples(aF)then return false end;if finale.MNALIGN_LEFT~=aC:GetMultipleAlignment(aF)then return false end end;return aj.is_default_measure_number_visible_on_cell(aC,aD,aH,aF)end;function aj.update_layout(aJ,aK)aJ=aJ or 1;aK=aK or false;local aL=finale.FCPage()if aL:Load(aJ)then aL:UpdateLayout(aK)end end;function aj.get_current_part()local aM=finale.FCParts()aM:LoadAll()return aM:GetCurrent()end;function aj.get_page_format_prefs()local aN=aj.get_current_part()local aO=finale.FCPageFormatPrefs()local aP=false;if aN:IsScore()then aP=aO:LoadScore()else aP=aO:LoadParts()end;return aO,aP end;local aQ=function(aR)local aS=finenv.UI():IsOnWindows()local aT=function(aU,aV)if finenv.UI():IsOnWindows()then return aU and os.getenv(aU)or""else return aV and os.getenv(aV)or""end end;local aW=aR and aT("LOCALAPPDATA","HOME")or aT("COMMONPROGRAMFILES")if not aS then aW=aW.."/Library/Application Support"end;aW=aW.."/SMuFL/Fonts/"return aW end;function aj.get_smufl_font_list()local aX={}local aY=function(aR)local aW=aQ(aR)local aZ=function()if finenv.UI():IsOnWindows()then return io.popen('dir "'..aW..'" /b /ad')else return io.popen('ls "'..aW..'"')end end;local a_=function(b0)local b1=finale.FCString()b1.LuaString=b0;return finenv.UI():IsFontAvailable(b1)end;for b0 in aZ():lines()do if not b0:find("%.")then b0=b0:gsub(" Bold","")b0=b0:gsub(" Italic","")local b1=finale.FCString()b1.LuaString=b0;if aX[b0]or a_(b0)then aX[b0]=aR and"user"or"system"end end end end;aY(true)aY(false)return aX end;function aj.get_smufl_metadata_file(b2)if not b2 then b2=finale.FCFontInfo()b2:LoadFontPrefs(finale.FONTPREF_MUSIC)end;local b3=function(b4,b2)local b5=b4 ..b2.Name.."/"..b2.Name..".json"return io.open(b5,"r")end;local b6=b3(aQ(true),b2)if b6 then return b6 end;return b3(aQ(false),b2)end;function aj.is_font_smufl_font(b2)if not b2 then b2=finale.FCFontInfo()b2:LoadFontPrefs(finale.FONTPREF_MUSIC)end;if finenv.RawFinaleVersion>=aj.finale_version(27,1)then if nil~=b2.IsSMuFLFont then return b2.IsSMuFLFont end end;local b7=aj.get_smufl_metadata_file(b2)if nil~=b7 then io.close(b7)return true end;return false end;function aj.simple_input(b8,b9)local ba=finale.FCString()ba.LuaString=""local bb=finale.FCString()local bc=160;function format_ctrl(bd,be,bf,bg)bd:SetHeight(be)bd:SetWidth(bf)bb.LuaString=bg;bd:SetText(bb)end;title_width=string.len(b8)*6+54;if title_width>bc then bc=title_width end;text_width=string.len(b9)*6;if text_width>bc then bc=text_width end;bb.LuaString=b8;local bh=finale.FCCustomLuaWindow()bh:SetTitle(bb)local bi=bh:CreateStatic(0,0)format_ctrl(bi,16,bc,b9)local bj=bh:CreateEdit(0,20)format_ctrl(bj,20,bc,"")bh:CreateOkButton()bh:CreateCancelButton()function callback(bd)end;bh:RegisterHandleCommand(callback)if bh:ExecuteModal(nil)==finale.EXECMODAL_OK then ba.LuaString=bj:GetText(ba)return ba.LuaString end end;function aj.is_finale_object(bk)return bk and type(bk)=="userdata"and bk.ClassName and bk.GetClassID and true or false end;function aj.system_indent_set_to_prefs(aH,aO)aO=aO or aj.get_page_format_prefs()local bl=finale.FCMeasure()local bm=aH.FirstMeasure==1;if not bm and bl:Load(aH.FirstMeasure)then if bl.ShowFullNames then bm=true end end;if bm and aO.UseFirstSystemMargins then aH.LeftMargin=aO.FirstSystemLeft else aH.LeftMargin=aO.SystemLeft end;return aH:Save()end;function aj.calc_script_name(bn)local bo=finale.FCString()if finenv.RunningLuaFilePath then bo.LuaString=finenv.RunningLuaFilePath()else bo:SetRunningLuaFilePath()end;local bp=finale.FCString()bo:SplitToPathAndFile(nil,bp)local an=bp.LuaString;if not bn then an=an:match("(.+)%..+")if not an or an==""then an=bp.LuaString end end;return an end;return aj end)return a("__root")