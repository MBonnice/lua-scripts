local a,b,c,d=(function(e)local f={[{}]=true}local g;local h={}local require;local i={}g=function(j,k)if not h[j]then h[j]=k end end;require=function(j)local l=i[j]if l then if l==f then return nil end else if not h[j]then if not e then local m=type(j)=='string'and'\"'..j..'\"'or tostring(j)error('Tried to require '..m..', but no such module has been registered')else return e(j)end end;i[j]=f;l=h[j](require,i,g,h)i[j]=l end;return l end;return require,i,g,h end)(require)c("__root",function(require,n,c,d)function plugindef()finaleplugin.RequireSelection=true;finaleplugin.Author="Nick Mazuk"finaleplugin.Copyright="CC0 https://creativecommons.org/publicdomain/zero/1.0/"finaleplugin.Version="1.0"finaleplugin.Date="August 22, 2021"finaleplugin.CategoryTags="Accidental"finaleplugin.AuthorURL="https://nickmazuk.com"return"Simplify accidentals","Simplify accidentals","Removes all double sharps and flats by respelling them"end;local o=require("library.transposition")function accidentals_simplify()for p in eachentrysaved(finenv.Region())do if not p:IsNote()then goto q end;local r=p.Measure;local s=p.Staff;local t=finale.FCCell(r,s)local u=t:GetKeySignature()for v in each(p)do if v.RaiseLower==0 then goto w end;local x=finale.FCString()v:GetString(x,u,false,false)local y=x:GetLuaString()if string.match(y,"bb")or string.match(y,"##")then o.enharmonic_transpose(v,v.RaiseLower)o.chromatic_transpose(v,0,0,true)end::w::end::q::end end;accidentals_simplify()end)c("library.transposition",function(require,n,c,d)local z={}function z.finale_version(A,B,C)local D=bit32.bor(bit32.lshift(math.floor(A),24),bit32.lshift(math.floor(B),20))if C then D=bit32.bor(D,math.floor(C))end;return D end;function z.group_overlaps_region(E,F)if F:IsFullDocumentSpan()then return true end;local G=false;local H=finale.FCSystemStaves()H:LoadAllForRegion(F)for I in each(H)do if E:ContainsStaff(I:GetStaff())then G=true;break end end;if not G then return false end;if E.StartMeasure>F.EndMeasure or E.EndMeasure<F.StartMeasure then return false end;return true end;function z.group_is_contained_in_region(E,F)if not F:IsStaffIncluded(E.StartStaff)then return false end;if not F:IsStaffIncluded(E.EndStaff)then return false end;return true end;function z.staff_group_is_multistaff_instrument(E)local J=finale.FCMultiStaffInstruments()J:LoadAll()for K in each(J)do if K:ContainsStaff(E.StartStaff)and K.GroupID==E:GetItemID()then return true end end;return false end;function z.get_selected_region_or_whole_doc()local L=finenv.Region()if L:IsEmpty()then L:SetFullDocument()end;return L end;function z.get_first_cell_on_or_after_page(M)local N=M;local O=finale.FCPage()local P=false;while O:Load(N)do if O:GetFirstSystem()>0 then P=true;break end;N=N+1 end;if P then local Q=finale.FCStaffSystem()Q:Load(O:GetFirstSystem())return finale.FCCell(Q.FirstMeasure,Q.TopStaff)end;local R=finale.FCMusicRegion()R:SetFullDocument()return finale.FCCell(R.EndMeasure,R.EndStaff)end;function z.get_top_left_visible_cell()if not finenv.UI():IsPageView()then local S=finale.FCMusicRegion()S:SetFullDocument()return finale.FCCell(finenv.UI():GetCurrentMeasure(),S.StartStaff)end;return z.get_first_cell_on_or_after_page(finenv.UI():GetCurrentPage())end;function z.get_top_left_selected_or_visible_cell()local L=finenv.Region()if not L:IsEmpty()then return finale.FCCell(L.StartMeasure,L.StartStaff)end;return z.get_top_left_visible_cell()end;function z.is_default_measure_number_visible_on_cell(T,t,U,V)local W=finale.FCCurrentStaffSpec()if not W:LoadForCell(t,0)then return false end;if T:GetShowOnTopStaff()and t.Staff==U.TopStaff then return true end;if T:GetShowOnBottomStaff()and t.Staff==U:CalcBottomStaff()then return true end;if W.ShowMeasureNumbers then return not T:GetExcludeOtherStaves(V)end;return false end;function z.is_default_number_visible_and_left_aligned(T,t,X,V,Y)if T.UseScoreInfoForParts then V=false end;if Y and T:GetShowOnMultiMeasureRests(V)then if finale.MNALIGN_LEFT~=T:GetMultiMeasureAlignment(V)then return false end elseif t.Measure==X.FirstMeasure then if not T:GetShowOnSystemStart()then return false end;if finale.MNALIGN_LEFT~=T:GetStartAlignment(V)then return false end else if not T:GetShowMultiples(V)then return false end;if finale.MNALIGN_LEFT~=T:GetMultipleAlignment(V)then return false end end;return z.is_default_measure_number_visible_on_cell(T,t,X,V)end;function z.update_layout(Z,_)Z=Z or 1;_=_ or false;local a0=finale.FCPage()if a0:Load(Z)then a0:UpdateLayout(_)end end;function z.get_current_part()local a1=finale.FCParts()a1:LoadAll()return a1:GetCurrent()end;function z.get_page_format_prefs()local a2=z.get_current_part()local a3=finale.FCPageFormatPrefs()local a4=false;if a2:IsScore()then a4=a3:LoadScore()else a4=a3:LoadParts()end;return a3,a4 end;function z.get_smufl_metadata_file(a5)if not a5 then a5=finale.FCFontInfo()a5:LoadFontPrefs(finale.FONTPREF_MUSIC)end;local a6=function(a7,a5)local a8=a7 .."/SMuFL/Fonts/"..a5.Name.."/"..a5.Name..".json"return io.open(a8,"r")end;local a9=""if finenv.UI():IsOnWindows()then a9=os.getenv("LOCALAPPDATA")else a9=os.getenv("HOME").."/Library/Application Support"end;local aa=a6(a9,a5)if nil~=aa then return aa end;local ab="/Library/Application Support"if finenv.UI():IsOnWindows()then ab=os.getenv("COMMONPROGRAMFILES")end;return a6(ab,a5)end;function z.is_font_smufl_font(a5)if not a5 then a5=finale.FCFontInfo()a5:LoadFontPrefs(finale.FONTPREF_MUSIC)end;if finenv.RawFinaleVersion>=z.finale_version(27,1)then if nil~=a5.IsSMuFLFont then return a5.IsSMuFLFont end end;local ac=z.get_smufl_metadata_file(a5)if nil~=ac then io.close(ac)return true end;return false end;function z.simple_input(ad,ae)local af=finale.FCString()af.LuaString=""local ag=finale.FCString()local ah=160;function format_ctrl(ai,aj,ak,al)ai:SetHeight(aj)ai:SetWidth(ak)ag.LuaString=al;ai:SetText(ag)end;title_width=string.len(ad)*6+54;if title_width>ah then ah=title_width end;text_width=string.len(ae)*6;if text_width>ah then ah=text_width end;ag.LuaString=ad;local am=finale.FCCustomLuaWindow()am:SetTitle(ag)local an=am:CreateStatic(0,0)format_ctrl(an,16,ah,ae)local ao=am:CreateEdit(0,20)format_ctrl(ao,20,ah,"")am:CreateOkButton()am:CreateCancelButton()function callback(ai)end;am:RegisterHandleCommand(callback)if am:ExecuteModal(nil)==finale.EXECMODAL_OK then af.LuaString=ao:GetText(af)return af.LuaString end end;function z.is_finale_object(ap)return ap and type(ap)=="userdata"and ap.ClassName and ap.GetClassID and true or false end;function z.system_indent_set_to_prefs(X,a3)a3=a3 or z.get_page_format_prefs()local aq=finale.FCMeasure()local ar=X.FirstMeasure==1;if not ar and aq:Load(X.FirstMeasure)then if aq.ShowFullNames then ar=true end end;if ar and a3.UseFirstSystemMargins then X.LeftMargin=a3.FirstSystemLeft else X.LeftMargin=a3.SystemLeft end;return X:Save()end;return z end)return a("__root")